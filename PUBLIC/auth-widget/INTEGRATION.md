# WaySenID â€” ĞŸĞ¾Ğ»Ğ½Ğ¾Ğµ Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸

> **Ğ’ĞµÑ€ÑĞ¸Ñ:** 2.0.0 | Ğ”Ğ»Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ² Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ñ… Ğ¸ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ñ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²  
> **ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:** Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ² WayGPT (waygpt.ru)

Ğ”Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ¾Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ **Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ»** Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ WaySenID Ğº Ğ²Ğ°ÑˆĞµĞ¼Ñƒ ÑĞµÑ€Ğ²Ğ¸ÑÑƒ â€” Ğ¾Ñ‚ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Ğ´Ğ¾ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğ³Ğ¾ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ².

---

## Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ

1. [ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ¸ Ğ¶Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ»](#1-Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°-Ğ¸-Ğ¶Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹-Ñ†Ğ¸ĞºĞ»)
2. [Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ](#2-ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸-Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ)
3. [Ğ¨Ğ°Ğ³ 1: Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ](#3-ÑˆĞ°Ğ³-1-Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ-Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ)
4. [Ğ¨Ğ°Ğ³ 2: ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ SDK](#4-ÑˆĞ°Ğ³-2-Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ-sdk)
5. [Ğ¨Ğ°Ğ³ 3: Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ°](#5-ÑˆĞ°Ğ³-3-ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°-Ğ²Ñ…Ğ¾Ğ´Ğ°)
6. [Ğ¨Ğ°Ğ³ 4: Backend â€” Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° callback](#6-ÑˆĞ°Ğ³-4-backend--Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°-callback)
7. [Ğ¨Ğ°Ğ³ 5: Ğ¥Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²](#7-ÑˆĞ°Ğ³-5-Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ-Ğ¸-Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ-Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²)
8. [Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ](#8-Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ-Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾-Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ)
9. [ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: WayGPT](#9-Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹-Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€-waygpt)
10. [Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ â€” Ñ‡ĞµĞºĞ»Ğ¸ÑÑ‚](#10-Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ--Ñ‡ĞµĞºĞ»Ğ¸ÑÑ‚)
11. [FAQ Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸](#11-faq-Ğ¸-Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸)

---

## 1. ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ¸ Ğ¶Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ»

### 1.1 ĞĞ±Ñ‰Ğ°Ñ ÑÑ…ĞµĞ¼Ğ°

```
   ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Ğ’ĞĞ¨ Ğ¡Ğ•Ğ Ğ’Ğ˜Ğ¡ (waygpt.ru)                   â”‚
â”‚                                                               â”‚
â”‚  Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ°:                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Email              â”‚  â”‚                              â”‚   â”‚
â”‚  â”‚  ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ             â”‚  â”‚   [ğŸŒ Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ· WaySenID]  â”‚   â”‚
â”‚  â”‚  [Ğ’Ğ¾Ğ¹Ñ‚Ğ¸]            â”‚  â”‚                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ñ…Ğ¾Ğ´            OAuth 2.0 + OIDC              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                             â”‚
           â–¼                             â–¼
    Ğ’Ğ°ÑˆĞ° Ğ‘Ğ” (users)           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   auth.markbase.ru       â”‚
                              â”‚   (WaySenID Provider)    â”‚
                              â”‚                          â”‚
                              â”‚  1. Account Picker       â”‚
                              â”‚  2. Ğ’Ñ…Ğ¾Ğ´ / Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ   â”‚
                              â”‚  3. ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ email   â”‚
                              â”‚  4. Ğ­ĞºÑ€Ğ°Ğ½ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¸Ğ¹        â”‚
                              â”‚  5. Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ code          â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ lifecycle (redirect-Ñ€ĞµĞ¶Ğ¸Ğ¼)

```
ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ           waygpt.ru (Frontend)          waygpt.ru (Backend)          auth.markbase.ru
     â”‚                        â”‚                              â”‚                           â”‚
     â”‚â”€â”€ ĞšĞ»Ğ¸Ğº Â«Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ·    â”‚                              â”‚                           â”‚
     â”‚   WaySenIDÂ»â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                              â”‚                           â”‚
     â”‚                        â”‚â”€â”€ GET /api/auth/wsid/init â”€â”€â–ºâ”‚                           â”‚
     â”‚                        â”‚                              â”‚â”€â”€ Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ state,       â”‚
     â”‚                        â”‚                              â”‚   code_verifier,          â”‚
     â”‚                        â”‚                              â”‚   code_challenge          â”‚
     â”‚                        â”‚                              â”‚   Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ Ğ² session     â”‚
     â”‚                        â”‚â—„â”€â”€ redirect_url â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                           â”‚
     â”‚â—„â”€â”€ 302 Redirect â”€â”€â”€â”€â”€â”€â”‚                              â”‚                           â”‚
     â”‚                        â”‚                              â”‚                           â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ GET /oauth/authorize â–ºâ”‚
     â”‚                        â”‚                              â”‚                           â”‚
     â”‚                        â”‚                              â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                        â”‚                              â”‚           â”‚ Ğ•ÑÑ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚? â”‚
     â”‚                        â”‚                              â”‚           â”œâ”€â”€â”€â”€â”€ Ğ”Ğ° â”€â”€â”€â”€â”€â”€â”¤
     â”‚                        â”‚                              â”‚           â”‚ Account Pickerâ”‚
     â”‚                        â”‚                              â”‚           â”‚ Ğ¸Ğ»Ğ¸ Login     â”‚
     â”‚                        â”‚                              â”‚           â”œâ”€â”€â”€â”€â”€ ĞĞµÑ‚ â”€â”€â”€â”€â”€â”¤
     â”‚                        â”‚                              â”‚           â”‚ Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ + â”‚
     â”‚                        â”‚                              â”‚           â”‚ ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ â”‚
     â”‚                        â”‚                              â”‚           â”‚ email         â”‚
     â”‚                        â”‚                              â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                        â”‚                              â”‚                           â”‚
     â”‚                        â”‚                              â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                        â”‚                              â”‚           â”‚ ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ Ğ²Ñ…Ğ¾Ğ´   â”‚
     â”‚                        â”‚                              â”‚           â”‚ Ğ² waygpt.ru?  â”‚
     â”‚                        â”‚                              â”‚           â”œâ”€â”€â”€â”€â”€ Ğ”Ğ° â”€â”€â”€â”€â”€â”€â”¤
     â”‚                        â”‚                              â”‚           â”‚ Consent Screenâ”‚
     â”‚                        â”‚                              â”‚           â”‚ (Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ)  â”‚
     â”‚                        â”‚                              â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                        â”‚                              â”‚                           â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 302 redirect_uri?code=...&state= â”‚
     â”‚                        â”‚                              â”‚                           â”‚
     â”‚â”€â”€ GET /callback?code=..&state=.. â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                           â”‚
     â”‚                        â”‚                              â”‚â”€â”€ POST /oauth/token â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                        â”‚                              â”‚   (code + client_secret    â”‚
     â”‚                        â”‚                              â”‚    + code_verifier)        â”‚
     â”‚                        â”‚                              â”‚â—„â”€â”€ access_token,          â”‚
     â”‚                        â”‚                              â”‚    refresh_token,          â”‚
     â”‚                        â”‚                              â”‚    id_token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                        â”‚                              â”‚                           â”‚
     â”‚                        â”‚                              â”‚â”€â”€ GET /oauth/userinfo â”€â”€â”€â”€â–ºâ”‚
     â”‚                        â”‚                              â”‚â—„â”€â”€ { sub, name, email } â”€â”€â”‚
     â”‚                        â”‚                              â”‚                           â”‚
     â”‚                        â”‚                              â”‚â”€â”€ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ/Ğ½Ğ°Ğ¹Ñ‚Ğ¸ user      â”‚
     â”‚                        â”‚                              â”‚   Ğ² ÑĞ²Ğ¾ĞµĞ¹ Ğ‘Ğ”              â”‚
     â”‚                        â”‚                              â”‚â”€â”€ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑĞµÑÑĞ¸Ñ          â”‚
     â”‚â—„â”€â”€ Set-Cookie: session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                           â”‚
     â”‚â—„â”€â”€ 302 â†’ /dashboard â”€â”€â”‚                              â”‚                           â”‚
     â”‚                        â”‚                              â”‚                           â”‚
     â–¼  ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ          â–¼                              â–¼                           â–¼
   Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½
```

### 1.3 ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ lifecycle (popup-Ñ€ĞµĞ¶Ğ¸Ğ¼)

```
ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ           waygpt.ru (ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾)         Popup (auth.markbase.ru)
     â”‚                        â”‚                              â”‚
     â”‚â”€â”€ ĞšĞ»Ğ¸Ğº Â«Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ·    â”‚                              â”‚
     â”‚   WaySenIDÂ»â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                              â”‚
     â”‚                        â”‚â”€â”€ window.open() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                        â”‚   /oauth/authorize?...       â”‚
     â”‚                        â”‚                              â”‚
     â”‚                        â”‚   (Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµÑ‚ postMessage)      â”‚â”€â”€ Account Picker
     â”‚                        â”‚                              â”‚â”€â”€ Login / Register
     â”‚                        â”‚                              â”‚â”€â”€ Email Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ
     â”‚                        â”‚                              â”‚â”€â”€ Consent Screen
     â”‚                        â”‚                              â”‚
     â”‚                        â”‚â—„â”€â”€ postMessage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ { type: 'wsid:auth_success',
     â”‚                        â”‚   (origin check!)            â”‚   code: '...', state: '...' }
     â”‚                        â”‚                              â”‚â”€â”€ (popup Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ)
     â”‚                        â”‚                              â”‚
     â”‚                        â”‚â”€â”€ POST /api/auth/wsid/callback â”€â”€ (Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ code Ğ½Ğ° backend)
     â”‚                        â”‚â—„â”€â”€ { user, session } â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                        â”‚                              â”‚
     â–¼  ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½           â–¼                              â–¼
```

---

## 2. Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ A: ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ£Ğ–Ğ• Ğ¸Ğ¼ĞµĞµÑ‚ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ WaySenID

```
1. ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ waygpt.ru â†’ ĞĞ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ Â«Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ· WaySenIDÂ»
2. ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ popup/redirect â†’ auth.markbase.ru
3. WaySenID Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½ÑƒÑ ÑĞµÑÑĞ¸Ñ â†’ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Account Picker
4. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚
5. Ğ•ÑĞ»Ğ¸ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ñ€Ğ°Ğ· Ğ½Ğ° waygpt.ru â†’ Consent Screen â†’ Â«Ğ Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚ÑŒÂ»
6. WaySenID Ğ¾Ñ‚Ğ´Ğ°Ñ‘Ñ‚ code â†’ waygpt.ru Ğ¾Ğ±Ğ¼ĞµĞ½Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ½Ğ° token
7. waygpt.ru ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½ÑƒÑ ÑĞµÑÑĞ¸Ñ â†’ Dashboard
```

**Ğ’Ñ€ĞµĞ¼Ñ: ~5 ÑĞµĞºÑƒĞ½Ğ´** (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ ÑĞµÑÑĞ¸Ñ Ğ¸ consent ÑƒĞ¶Ğµ Ğ´Ğ°Ğ½)

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ B: ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ĞĞ• Ğ¸Ğ¼ĞµĞµÑ‚ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ° WaySenID

```
1. ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ waygpt.ru â†’ ĞĞ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ Â«Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ· WaySenIDÂ»
2. ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ popup/redirect â†’ auth.markbase.ru
3. WaySenID Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ñ‡Ñ‚Ğ¾ Ğ½ĞµÑ‚ ÑĞµÑÑĞ¸Ğ¸ â†’ Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ°
4. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ Â«Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Â»
5. â”€â”€â”€â”€ Ğ Ğ•Ğ“Ğ˜Ğ¡Ğ¢Ğ ĞĞ¦Ğ˜Ğ¯ â”€â”€â”€â”€
   a. Ğ’Ğ²Ğ¾Ğ´ email
   b. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‡Ñ‚Ğ¾ email Ğ½Ğµ Ğ·Ğ°Ğ½ÑÑ‚
   c. Ğ’Ğ²Ğ¾Ğ´ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ (Ğ¼Ğ¸Ğ½. 8 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ², Ğ·Ğ°Ğ³Ğ»Ğ°Ğ²Ğ½Ñ‹Ğµ + ÑÑ‚Ñ€Ğ¾Ñ‡Ğ½Ñ‹Ğµ + Ñ†Ğ¸Ñ„Ñ€Ñ‹)
   d. Captcha (Ğ¯Ğ½Ğ´ĞµĞºÑ SmartCaptcha)
   e. ĞŸÑ€Ğ¸Ğ½ÑÑ‚Ğ¸Ğµ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¸Ğ¹ (Ğ¿Ğ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°, ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ, Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ)
   f. â–º ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¿Ğ¸ÑÑŒĞ¼Ğ° Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸ĞµĞ¼ â—„
6. â”€â”€â”€â”€ ĞŸĞĞ”Ğ¢Ğ’Ğ•Ğ Ğ–Ğ”Ğ•ĞĞ˜Ğ• EMAIL â”€â”€â”€â”€
   a. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾ Ñ 6-Ğ·Ğ½Ğ°Ñ‡Ğ½Ñ‹Ğ¼ ĞºĞ¾Ğ´Ğ¾Ğ¼
   b. Ğ’Ğ²Ğ¾Ğ´Ğ¸Ñ‚ ĞºĞ¾Ğ´ Ğ½Ğ° auth.markbase.ru
   c. Email Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ñ‘Ğ½ â†’ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½
7. Consent Screen â†’ Â«Ğ Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚ÑŒÂ» Ğ´Ğ»Ñ waygpt.ru
8. WaySenID Ğ¾Ñ‚Ğ´Ğ°Ñ‘Ñ‚ code â†’ waygpt.ru Ğ¾Ğ±Ğ¼ĞµĞ½Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ½Ğ° token
9. waygpt.ru ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½ÑƒÑ ÑĞµÑÑĞ¸Ñ â†’ Dashboard
```

**Ğ’Ñ€ĞµĞ¼Ñ: ~2-3 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹** (Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ Ğ¿Ğ¾Ñ‡Ñ‚Ñ‹)

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ C: Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ñ…Ğ¾Ğ´ + Ğ¿Ñ€Ğ¸Ğ²ÑĞ·ĞºĞ° WaySenID Ğ¿Ğ¾Ğ·Ğ¶Ğµ

```
1. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ½Ğ° waygpt.ru Ñ‡ĞµÑ€ĞµĞ· Ğ¾Ğ±Ñ‹Ñ‡Ğ½ÑƒÑ Ñ„Ğ¾Ñ€Ğ¼Ñƒ
2. Ğ’ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ñ… Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ° â†’ Â«ĞŸÑ€Ğ¸Ğ²ÑĞ·Ğ°Ñ‚ÑŒ WaySenIDÂ»
3. OAuth flow â†’ WaySenID ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ ÑĞ²ÑĞ·ÑŒ (link) Ñ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ¾Ğ¼ waygpt.ru
4. Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ²Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· Â«Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ· WaySenIDÂ»
```

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ D: ĞœĞ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ñ‹

```
1. Ğ£ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ 2 Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ° WaySenID (Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ + Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹)
2. ĞĞ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ Â«Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ· WaySenIDÂ» Ğ½Ğ° waygpt.ru
3. Account Picker Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¾Ğ±Ğ° Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°
4. Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¹ â†’ Ğ²Ñ…Ğ¾Ğ´Ğ¸Ñ‚
5. ĞœĞ¾Ğ¶ĞµÑ‚ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Ñ‡ĞµÑ€ĞµĞ· Account Switcher Ğ² ÑˆĞ°Ğ¿ĞºĞµ
```

---

## 3. Ğ¨Ğ°Ğ³ 1: Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ

### 3.1 Ğ§ĞµÑ€ĞµĞ· Registry UI

1. ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğ½Ğ° [registry.markbase.ru](https://registry.markbase.ru)
2. Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ ĞºĞ°Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€
3. Â«ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ÑÂ» â†’ Â«Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ OAuth-Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ĞµÂ»
4. Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ñ„Ğ¾Ñ€Ğ¼Ñƒ:

| ĞŸĞ¾Ğ»Ğµ | ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ (WayGPT) | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|------|------------------|----------|
| **ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ** | WayGPT | ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚ÑÑ Ğ½Ğ° Consent Screen |
| **Ğ”Ğ¾Ğ¼ĞµĞ½** | waygpt.ru | ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ´Ğ¾Ğ¼ĞµĞ½ |
| **Redirect URIs** | `https://waygpt.ru/auth/callback` | Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ€Ğ°Ğ·Ñ€ĞµÑˆÑ‘Ğ½Ğ½Ñ‹Ñ… callback URL |
| **Scopes** | `openid profile email` | Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ |
| **Ğ˜ĞºĞ¾Ğ½ĞºĞ°** | PNG 128x128 | ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚ÑÑ Ğ½Ğ° Consent Screen |
| **ĞŸĞ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ° ĞºĞ¾Ğ½Ñ„.** | `https://waygpt.ru/privacy` | Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ´Ğ»Ñ Consent Screen |
| **Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ¸ÑĞ¿.** | `https://waygpt.ru/terms` | Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ´Ğ»Ñ Consent Screen |
| **Ğ¢Ğ¸Ğ¿ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ** | `web` | `web` / `spa` / `native` |

5. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ credentials:

```
CLIENT_ID:     wsid_app_waygpt_abc123
CLIENT_SECRET: wsid_secret_xxxxxxxxxxxxxxxxxxx
```

### 3.2 Ğ§ĞµÑ€ĞµĞ· API

```bash
curl -X POST https://registry.markbase.ru/api/registry/v1/oauth/apps \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "WayGPT",
    "domain": "waygpt.ru",
    "redirect_uris": [
      "https://waygpt.ru/auth/callback",
      "http://localhost:3000/auth/callback"
    ],
    "scopes": ["openid", "profile", "email"],
    "app_type": "web",
    "privacy_url": "https://waygpt.ru/privacy",
    "terms_url": "https://waygpt.ru/terms"
  }'
```

**ĞÑ‚Ğ²ĞµÑ‚:**

```json
{
  "app_id": "wsid_app_waygpt_abc123",
  "client_id": "wsid_app_waygpt_abc123",
  "client_secret": "wsid_secret_xxxxxxxxxxxxxxxxxxx",
  "name": "WayGPT",
  "created_at": "2026-02-09T12:00:00Z"
}
```

> **Ğ’ĞĞ–ĞĞ:** `client_secret` Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ **Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ·**. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚Ğµ ĞµĞ³Ğ¾ Ğ½ĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾.  
> **ĞĞ˜ĞšĞĞ“Ğ”Ğ** Ğ½Ğµ Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚Ğµ `client_secret` Ğ² frontend-ĞºĞ¾Ğ´Ğµ, git, Ğ¸Ğ»Ğ¸ Ğ»Ğ¾Ğ³Ğ°Ñ….

---

## 4. Ğ¨Ğ°Ğ³ 2: ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ SDK

### 4.1 ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ¸Ğ»ĞµĞ¹ Ğ¸ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ°

```html
<!-- Ğ’ <head> -->
<link rel="stylesheet" href="https://auth.markbase.ru/sdk/waysenid.css">

<!-- ĞŸĞµÑ€ĞµĞ´ </body> -->
<script src="https://auth.markbase.ru/sdk/waysenid.js"></script>
```

### 4.2 Ğ§ĞµÑ€ĞµĞ· npm (React / Vue / Next.js)

```bash
npm install @markbase/waysenid-sdk
```

```javascript
import WaySenID from '@markbase/waysenid-sdk';
import '@markbase/waysenid-sdk/styles.css';
```

### 4.3 Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

```javascript
WaySenID.init({
  client_id: 'wsid_app_waygpt_abc123',
  redirect_uri: 'https://waygpt.ru/auth/callback',
  scope: 'openid profile email',
  mode: 'popup',           // 'popup' | 'redirect'
  locale: 'ru',            // 'ru' | 'en'
  
  // Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾Ğ¿Ñ†Ğ¸Ğ¸:
  auto_select: false,       // true = auto-login ĞµÑĞ»Ğ¸ 1 Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ¸ consent ÑƒĞ¶Ğµ Ğ´Ğ°Ğ½
  prompt: 'select_account', // ĞŸĞ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
  
  // Callbacks:
  onReady: () => {
    console.log('WaySenID SDK ready');
  },
  onError: (error) => {
    console.error('WaySenID SDK error:', error);
  }
});
```

---

## 5. Ğ¨Ğ°Ğ³ 3: Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ°

### 5.1 ĞŸĞ¾Ğ»Ğ½Ğ°Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ° (HTML)

```html
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ğ’Ñ…Ğ¾Ğ´ â€” WayGPT</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://auth.markbase.ru/sdk/waysenid.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: #f7f8fa;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      -webkit-font-smoothing: antialiased;
    }

    .login-card {
      width: 100%;
      max-width: 440px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08), 0 1px 4px rgba(0,0,0,0.04);
      padding: 40px 36px 32px;
    }

    .login-logo {
      text-align: center;
      margin-bottom: 28px;
    }
    .login-logo h1 {
      font-size: 24px;
      font-weight: 700;
      color: #0f172a;
      margin-top: 12px;
    }
    .login-logo p {
      font-size: 14px;
      color: #64748b;
      margin-top: 4px;
    }

    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #475569;
      margin-bottom: 6px;
    }
    .form-group input {
      width: 100%;
      height: 42px;
      border: 1.5px solid #e2e5e9;
      border-radius: 10px;
      padding: 0 14px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.15s;
      outline: none;
    }
    .form-group input:focus {
      border-color: #0f172a;
      box-shadow: 0 0 0 3px rgba(15,23,42,0.06);
    }

    .btn-login {
      width: 100%;
      height: 44px;
      background: #0f172a;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 8px;
    }
    .btn-login:hover {
      background: #1e293b;
      box-shadow: 0 4px 12px rgba(15,23,42,0.2);
    }

    .login-links {
      text-align: center;
      margin-top: 8px;
    }
    .login-links a {
      font-size: 13px;
      color: #64748b;
      text-decoration: none;
      transition: color 0.15s;
    }
    .login-links a:hover {
      color: #0f172a;
    }

    /* â”€â”€â”€ Divider â”€â”€â”€ */
    .auth-divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 24px 0;
      color: #94a3b8;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .auth-divider::before,
    .auth-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(to right, transparent, #e2e5e9, transparent);
    }

    /* â”€â”€â”€ WaySenID button container â”€â”€â”€ */
    .wsid-container {
      margin-bottom: 8px;
    }

    /* â”€â”€â”€ Footer â”€â”€â”€ */
    .login-footer {
      margin-top: 24px;
      text-align: center;
      max-width: 440px;
    }
    .login-footer a {
      font-size: 12px;
      color: #94a3b8;
      text-decoration: none;
      margin: 0 8px;
    }
    .login-footer a:hover { color: #64748b; }
    .login-footer .copy {
      margin-top: 12px;
      font-size: 11px;
      color: #c0c5cc;
    }
  </style>
</head>
<body>

  <div class="login-card">
    <div class="login-logo">
      <h1>WayGPT</h1>
      <p>Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ</p>
    </div>

    <!-- â•â•â•â•â•â• ĞšĞ½Ğ¾Ğ¿ĞºĞ° WaySenID â•â•â•â•â•â• -->
    <div class="wsid-container" id="wsid-button"></div>

    <!-- â•â•â•â•â•â• Ğ Ğ°Ğ·Ğ´ĞµĞ»Ğ¸Ñ‚ĞµĞ»ÑŒ â•â•â•â•â•â• -->
    <div class="auth-divider">Ğ¸Ğ»Ğ¸</div>

    <!-- â•â•â•â•â•â• ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ Ğ²Ñ…Ğ¾Ğ´ â•â•â•â•â•â• -->
    <form action="/auth/login" method="POST">
      <div class="form-group">
        <label>Email</label>
        <input type="email" name="email" placeholder="you@example.com" required>
      </div>
      <div class="form-group">
        <label>ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ</label>
        <input type="password" name="password" placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ" required>
      </div>
      <button type="submit" class="btn-login">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</button>
    </form>

    <div class="login-links">
      <a href="/auth/register">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚</a>
      &nbsp;&middot;&nbsp;
      <a href="/auth/forgot-password">Ğ—Ğ°Ğ±Ñ‹Ğ»Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ?</a>
    </div>
  </div>

  <div class="login-footer">
    <a href="/privacy">ĞšĞ¾Ğ½Ñ„Ğ¸Ğ´ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ</a>
    <a href="/terms">Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ñ</a>
    <a href="/contact">ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹</a>
    <div class="copy">&copy; 2026 WayGPT. ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚ ÑĞºĞ¾ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ markbase.ru</div>
  </div>

  <!-- â•â•â•â•â•â• WaySenID SDK â•â•â•â•â•â• -->
  <script src="https://auth.markbase.ru/sdk/waysenid.js"></script>
  <script>
    WaySenID.init({
      client_id: 'wsid_app_waygpt_abc123',
      redirect_uri: window.location.origin + '/auth/callback',
      scope: 'openid profile email'
    });

    // Ğ ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ
    WaySenID.renderButton('#wsid-button', {
      variant: 'outline',  // outline â€” Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ°Ğ»Ğ°ÑÑŒ Ğ¾Ñ‚ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Â«Ğ’Ğ¾Ğ¹Ñ‚Ğ¸Â»
      size: 'lg',
      width: '100%',
      text: 'Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ· WaySenID'
    });
  </script>

</body>
</html>
```

### 5.2 React-ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ²Ñ…Ğ¾Ğ´Ğ°

```jsx
// pages/Login.jsx
import React, { useState, useEffect, useRef } from 'react';
import WaySenID from '@markbase/waysenid-sdk';
import '@markbase/waysenid-sdk/styles.css';

export default function LoginPage() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const wsidRef = useRef(null);

  useEffect(() => {
    // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ WaySenID SDK
    WaySenID.init({
      client_id: process.env.REACT_APP_WSID_CLIENT_ID,
      redirect_uri: window.location.origin + '/auth/callback',
      scope: 'openid profile email',
    });

    // Ğ ĞµĞ½Ğ´ĞµÑ€ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸
    if (wsidRef.current) {
      WaySenID.renderButton(wsidRef.current, {
        variant: 'outline',
        size: 'lg',
        width: '100%',
        text: 'Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ· WaySenID',
        onSuccess: handleWsidSuccess,
        onError: handleWsidError,
      });
    }
  }, []);

  // â”€â”€ ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ Ğ²Ñ…Ğ¾Ğ´Ğ° Ñ‡ĞµÑ€ĞµĞ· WaySenID â”€â”€
  const handleWsidSuccess = async (result) => {
    setLoading(true);
    setError('');
    try {
      const resp = await fetch('/api/auth/wsid/callback', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code: result.code, state: result.state }),
      });
      const data = await resp.json();

      if (data.success) {
        // Ğ’Ñ…Ğ¾Ğ´ Ğ¸Ğ»Ğ¸ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾
        if (data.is_new_user) {
          // ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ â€” Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ onboarding
          window.location.href = '/onboarding';
        } else {
          window.location.href = '/dashboard';
        }
      } else {
        setError(data.error || 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸');
      }
    } catch (err) {
      setError('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ·.');
    } finally {
      setLoading(false);
    }
  };

  const handleWsidError = (err) => {
    if (err.error === 'access_denied') {
      // ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ·Ğ°ĞºÑ€Ñ‹Ğ» popup Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ğ»
      return;
    }
    setError('ĞÑˆĞ¸Ğ±ĞºĞ° WaySenID: ' + (err.error_description || err.error));
  };

  // â”€â”€ ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ Ğ²Ñ…Ğ¾Ğ´ Ğ¿Ğ¾ email/Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ â”€â”€
  const handleLocalLogin = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');
    try {
      const resp = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password }),
      });
      const data = await resp.json();
      if (data.success) {
        window.location.href = '/dashboard';
      } else {
        setError(data.error || 'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ email Ğ¸Ğ»Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ');
      }
    } catch (err) {
      setError('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={{
      minHeight: '100vh', background: '#f7f8fa',
      display: 'flex', flexDirection: 'column',
      alignItems: 'center', justifyContent: 'center', padding: 20,
      fontFamily: "'Inter', system-ui, sans-serif",
    }}>
      <div style={{
        width: '100%', maxWidth: 440, background: '#fff',
        borderRadius: 16, padding: '40px 36px 32px',
        boxShadow: '0 4px 24px rgba(0,0,0,0.08)',
      }}>
        <div style={{ textAlign: 'center', marginBottom: 28 }}>
          <h1 style={{ fontSize: 24, fontWeight: 700, color: '#0f172a' }}>WayGPT</h1>
          <p style={{ fontSize: 14, color: '#64748b', marginTop: 4 }}>Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ</p>
        </div>

        {error && (
          <div style={{
            background: '#fef2f2', border: '1px solid #fecaca',
            borderRadius: 10, padding: '10px 14px', marginBottom: 16,
            fontSize: 13, color: '#dc2626',
          }}>
            {error}
          </div>
        )}

        {/* â•â• ĞšĞ½Ğ¾Ğ¿ĞºĞ° WaySenID â•â• */}
        <div ref={wsidRef} style={{ marginBottom: 8 }} />

        {/* â•â• Ğ Ğ°Ğ·Ğ´ĞµĞ»Ğ¸Ñ‚ĞµĞ»ÑŒ â•â• */}
        <div style={{
          display: 'flex', alignItems: 'center', gap: 16,
          margin: '24px 0', color: '#94a3b8', fontSize: 12,
          fontWeight: 500, textTransform: 'uppercase', letterSpacing: 0.5,
        }}>
          <div style={{ flex: 1, height: 1, background: 'linear-gradient(to right, transparent, #e2e5e9, transparent)' }} />
          <span>Ğ¸Ğ»Ğ¸</span>
          <div style={{ flex: 1, height: 1, background: 'linear-gradient(to right, transparent, #e2e5e9, transparent)' }} />
        </div>

        {/* â•â• ĞĞ±Ñ‹Ñ‡Ğ½Ğ°Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ° â•â• */}
        <form onSubmit={handleLocalLogin}>
          <div style={{ marginBottom: 16 }}>
            <label style={{ display: 'block', fontSize: 13, fontWeight: 500, color: '#475569', marginBottom: 6 }}>Email</label>
            <input
              type="email" value={email} onChange={e => setEmail(e.target.value)}
              placeholder="you@example.com" required
              style={{
                width: '100%', height: 42, border: '1.5px solid #e2e5e9',
                borderRadius: 10, padding: '0 14px', fontSize: 14,
                fontFamily: 'inherit', outline: 'none',
              }}
            />
          </div>
          <div style={{ marginBottom: 16 }}>
            <label style={{ display: 'block', fontSize: 13, fontWeight: 500, color: '#475569', marginBottom: 6 }}>ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ</label>
            <input
              type="password" value={password} onChange={e => setPassword(e.target.value)}
              placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ" required
              style={{
                width: '100%', height: 42, border: '1.5px solid #e2e5e9',
                borderRadius: 10, padding: '0 14px', fontSize: 14,
                fontFamily: 'inherit', outline: 'none',
              }}
            />
          </div>
          <button type="submit" disabled={loading} style={{
            width: '100%', height: 44, background: '#0f172a', color: '#fff',
            border: 'none', borderRadius: 10, fontSize: 14, fontWeight: 600,
            fontFamily: 'inherit', cursor: 'pointer',
            opacity: loading ? 0.7 : 1,
          }}>
            {loading ? 'Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...' : 'Ğ’Ğ¾Ğ¹Ñ‚Ğ¸'}
          </button>
        </form>

        <div style={{ textAlign: 'center', marginTop: 16 }}>
          <a href="/auth/register" style={{ fontSize: 13, color: '#64748b' }}>Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚</a>
          <span style={{ margin: '0 8px', color: '#d1d5db' }}>&middot;</span>
          <a href="/auth/forgot-password" style={{ fontSize: 13, color: '#64748b' }}>Ğ—Ğ°Ğ±Ñ‹Ğ»Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ?</a>
        </div>
      </div>
    </div>
  );
}
```

---

## 6. Ğ¨Ğ°Ğ³ 4: Backend â€” Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° callback

### 6.1 Node.js / Express

```javascript
// routes/auth.js
const express = require('express');
const crypto = require('crypto');
const axios = require('axios');
const router = express.Router();

const WSID_AUTHORIZE_URL = 'https://auth.markbase.ru/oauth/authorize';
const WSID_TOKEN_URL = 'https://auth.markbase.ru/oauth/token';
const WSID_USERINFO_URL = 'https://auth.markbase.ru/oauth/userinfo';
const CLIENT_ID = process.env.WSID_CLIENT_ID;
const CLIENT_SECRET = process.env.WSID_CLIENT_SECRET;
const REDIRECT_URI = process.env.WSID_REDIRECT_URI;

// â”€â”€ Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ PKCE â”€â”€
function generateCodeVerifier() {
  return crypto.randomBytes(32).toString('base64url');
}
function generateCodeChallenge(verifier) {
  return crypto.createHash('sha256').update(verifier).digest('base64url');
}

// â”€â”€ 1. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ OAuth flow (redirect-Ñ€ĞµĞ¶Ğ¸Ğ¼) â”€â”€
router.get('/wsid/init', (req, res) => {
  const state = crypto.randomBytes(16).toString('hex');
  const codeVerifier = generateCodeVerifier();
  const codeChallenge = generateCodeChallenge(codeVerifier);

  // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ² ÑĞµÑÑĞ¸Ñ (ĞĞ‘Ğ¯Ğ—ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ ÑĞµÑ€Ğ²ĞµÑ€Ğ½Ğ°Ñ ÑĞµÑÑĞ¸Ñ, Ğ½Ğµ cookie!)
  req.session.oauth_state = state;
  req.session.oauth_code_verifier = codeVerifier;
  req.session.oauth_return_url = req.query.return_url || '/dashboard';

  const params = new URLSearchParams({
    response_type: 'code',
    client_id: CLIENT_ID,
    redirect_uri: REDIRECT_URI,
    scope: 'openid profile email',
    state: state,
    code_challenge: codeChallenge,
    code_challenge_method: 'S256',
    prompt: 'select_account',
  });

  res.redirect(`${WSID_AUTHORIZE_URL}?${params}`);
});

// â”€â”€ 2. Callback (Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ code) â”€â”€
router.get('/wsid/callback', async (req, res) => {
  const { code, state, error, error_description } = req.query;

  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ¾Ñ‚ WaySenID
  if (error) {
    console.error(`WaySenID OAuth error: ${error} â€” ${error_description}`);
    return res.redirect(`/login?error=${encodeURIComponent(error_description || error)}`);
  }

  // â”€â”€ CSRF Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° â”€â”€
  if (!state || state !== req.session.oauth_state) {
    console.error('WaySenID OAuth: state mismatch (CSRF attack?)');
    return res.redirect('/login?error=invalid_state');
  }

  try {
    // â”€â”€ 3. ĞĞ±Ğ¼ĞµĞ½ code â†’ tokens â”€â”€
    const tokenResp = await axios.post(WSID_TOKEN_URL, new URLSearchParams({
      grant_type: 'authorization_code',
      code: code,
      client_id: CLIENT_ID,
      client_secret: CLIENT_SECRET,
      redirect_uri: REDIRECT_URI,
      code_verifier: req.session.oauth_code_verifier,
    }), {
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      timeout: 10000,
    });

    const { access_token, refresh_token, id_token } = tokenResp.data;

    // â”€â”€ 4. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ â”€â”€
    const userResp = await axios.get(WSID_USERINFO_URL, {
      headers: { 'Authorization': `Bearer ${access_token}` },
      timeout: 5000,
    });

    const wsidUser = userResp.data;
    // wsidUser = { sub, name, email, email_verified, picture }

    // â”€â”€ 5. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° email_verified â”€â”€
    if (!wsidUser.email_verified) {
      return res.redirect('/login?error=email_not_verified');
    }

    // â”€â”€ 6. ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ² Ğ’ĞĞ¨Ğ•Ğ™ Ğ‘Ğ” â”€â”€
    let user = await db.users.findOne({ where: { wsid_sub: wsidUser.sub } });
    let isNewUser = false;

    if (!user) {
      // ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾ email â€” Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚
      user = await db.users.findOne({ where: { email: wsidUser.email } });

      if (user) {
        // ĞŸÑ€Ğ¸Ğ²ÑĞ·Ğ°Ñ‚ÑŒ WaySenID Ğº ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ¼Ñƒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ñƒ
        await db.users.update(
          { wsid_sub: wsidUser.sub, wsid_linked_at: new Date() },
          { where: { id: user.id } }
        );
      } else {
        // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        user = await db.users.create({
          email: wsidUser.email,
          display_name: wsidUser.name,
          wsid_sub: wsidUser.sub,
          wsid_linked_at: new Date(),
          email_verified: true, // WaySenID ÑƒĞ¶Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ğ»
          auth_provider: 'waysenid',
        });
        isNewUser = true;
      }
    }

    // â”€â”€ 7. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ refresh_token (Ğ·Ğ°ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹) â”€â”€
    await db.oauth_tokens.upsert({
      user_id: user.id,
      provider: 'waysenid',
      access_token: encrypt(access_token),
      refresh_token: encrypt(refresh_token),
      expires_at: new Date(Date.now() + tokenResp.data.expires_in * 1000),
    });

    // â”€â”€ 8. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑĞµÑÑĞ¸Ñ â”€â”€
    req.session.user_id = user.id;
    req.session.auth_provider = 'waysenid';

    // ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ OAuth-Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· ÑĞµÑÑĞ¸Ğ¸
    delete req.session.oauth_state;
    delete req.session.oauth_code_verifier;

    const returnUrl = req.session.oauth_return_url || '/dashboard';
    delete req.session.oauth_return_url;

    res.redirect(isNewUser ? '/onboarding' : returnUrl);

  } catch (err) {
    console.error('WaySenID callback error:', err.response?.data || err.message);
    res.redirect('/login?error=auth_failed');
  }
});

// â”€â”€ 3. Callback Ğ´Ğ»Ñ popup-Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ° (POST Ğ¾Ñ‚ frontend) â”€â”€
router.post('/wsid/callback', async (req, res) => {
  const { code, state } = req.body;

  // Ğ¢Ğ° Ğ¶Ğµ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ñ‡Ñ‚Ğ¾ Ğ¸ GET callback, Ğ½Ğ¾ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ JSON
  // ... (Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾ GET, Ğ½Ğ¾ res.json() Ğ²Ğ¼ĞµÑÑ‚Ğ¾ res.redirect())

  try {
    // ... Ğ¾Ğ±Ğ¼ĞµĞ½ code â†’ token â†’ userinfo â†’ find/create user ...

    res.json({
      success: true,
      is_new_user: isNewUser,
      user: {
        id: user.id,
        email: user.email,
        display_name: user.display_name,
      }
    });
  } catch (err) {
    res.status(400).json({ success: false, error: err.message });
  }
});

// â”€â”€ 4. Ğ’Ñ‹Ñ…Ğ¾Ğ´ â”€â”€
router.post('/wsid/logout', async (req, res) => {
  if (req.session.user_id) {
    // ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾: Ğ¾Ñ‚Ğ¾Ğ·Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ğ¾ĞºĞµĞ½ Ñƒ WaySenID
    try {
      const tokens = await db.oauth_tokens.findOne({
        where: { user_id: req.session.user_id, provider: 'waysenid' }
      });
      if (tokens) {
        await axios.post('https://auth.markbase.ru/oauth/revoke', new URLSearchParams({
          token: decrypt(tokens.refresh_token),
          client_id: CLIENT_ID,
          client_secret: CLIENT_SECRET,
        }));
        await tokens.destroy();
      }
    } catch (_) { /* Ğ½Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ Ğ²Ñ‹Ñ…Ğ¾Ğ´ */ }
  }

  req.session.destroy();
  res.json({ success: true });
});

module.exports = router;
```

### 6.2 Python / FastAPI

```python
# auth/waysenid.py
import os
import secrets
import hashlib
import base64
from datetime import datetime, timedelta

import httpx
from fastapi import APIRouter, Request, HTTPException
from fastapi.responses import RedirectResponse, JSONResponse

router = APIRouter(prefix="/auth/wsid")

WSID_AUTHORIZE = "https://auth.markbase.ru/oauth/authorize"
WSID_TOKEN = "https://auth.markbase.ru/oauth/token"
WSID_USERINFO = "https://auth.markbase.ru/oauth/userinfo"
WSID_REVOKE = "https://auth.markbase.ru/oauth/revoke"

CLIENT_ID = os.getenv("WSID_CLIENT_ID")
CLIENT_SECRET = os.getenv("WSID_CLIENT_SECRET")
REDIRECT_URI = os.getenv("WSID_REDIRECT_URI", "https://waygpt.ru/auth/callback")


def _pkce_pair():
    """Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ PKCE code_verifier + code_challenge."""
    verifier = secrets.token_urlsafe(32)
    digest = hashlib.sha256(verifier.encode()).digest()
    challenge = base64.urlsafe_b64encode(digest).rstrip(b"=").decode()
    return verifier, challenge


@router.get("/init")
async def wsid_init(request: Request, return_url: str = "/dashboard"):
    """Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ OAuth flow â€” redirect Ğ½Ğ° auth.markbase.ru."""
    state = secrets.token_hex(16)
    verifier, challenge = _pkce_pair()

    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² ÑĞµÑ€Ğ²ĞµÑ€Ğ½Ğ¾Ğ¹ ÑĞµÑÑĞ¸Ğ¸
    request.session["oauth_state"] = state
    request.session["oauth_verifier"] = verifier
    request.session["oauth_return"] = return_url

    params = {
        "response_type": "code",
        "client_id": CLIENT_ID,
        "redirect_uri": REDIRECT_URI,
        "scope": "openid profile email",
        "state": state,
        "code_challenge": challenge,
        "code_challenge_method": "S256",
        "prompt": "select_account",
    }
    url = f"{WSID_AUTHORIZE}?{'&'.join(f'{k}={v}' for k, v in params.items())}"
    return RedirectResponse(url)


@router.get("/callback")
async def wsid_callback(request: Request, code: str = "", state: str = "",
                         error: str = "", error_description: str = ""):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° callback Ğ¾Ñ‚ WaySenID."""
    if error:
        return RedirectResponse(f"/login?error={error_description or error}")

    # â”€â”€ CSRF check â”€â”€
    saved_state = request.session.pop("oauth_state", None)
    if not state or state != saved_state:
        raise HTTPException(400, "Invalid state (CSRF)")

    verifier = request.session.pop("oauth_verifier", "")
    return_url = request.session.pop("oauth_return", "/dashboard")

    async with httpx.AsyncClient(timeout=10) as client:
        # â”€â”€ ĞĞ±Ğ¼ĞµĞ½ code â†’ token â”€â”€
        token_resp = await client.post(WSID_TOKEN, data={
            "grant_type": "authorization_code",
            "code": code,
            "client_id": CLIENT_ID,
            "client_secret": CLIENT_SECRET,
            "redirect_uri": REDIRECT_URI,
            "code_verifier": verifier,
        })
        if token_resp.status_code != 200:
            raise HTTPException(400, f"Token exchange failed: {token_resp.text}")
        tokens = token_resp.json()

        # â”€â”€ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ â”€â”€
        user_resp = await client.get(WSID_USERINFO, headers={
            "Authorization": f"Bearer {tokens['access_token']}"
        })
        if user_resp.status_code != 200:
            raise HTTPException(400, "Failed to get user info")
        wsid_user = user_resp.json()

    # â”€â”€ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ email â”€â”€
    if not wsid_user.get("email_verified"):
        return RedirectResponse("/login?error=email_not_verified")

    # â”€â”€ ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ â”€â”€
    user = await find_user_by_wsid(wsid_user["sub"])
    is_new = False

    if not user:
        user = await find_user_by_email(wsid_user["email"])
        if user:
            await link_wsid_to_user(user["id"], wsid_user["sub"])
        else:
            user = await create_user(
                email=wsid_user["email"],
                display_name=wsid_user.get("name"),
                wsid_sub=wsid_user["sub"],
                email_verified=True,
                auth_provider="waysenid",
            )
            is_new = True

    # â”€â”€ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾ĞºĞµĞ½Ñ‹ â”€â”€
    await save_oauth_tokens(user["id"], "waysenid", tokens)

    # â”€â”€ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑĞµÑÑĞ¸Ñ â”€â”€
    request.session["user_id"] = user["id"]
    request.session["auth_provider"] = "waysenid"

    return RedirectResponse("/onboarding" if is_new else return_url)
```

---

## 7. Ğ¨Ğ°Ğ³ 5: Ğ¥Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²

### 7.1 Ğ¡Ñ…ĞµĞ¼Ğ° Ğ‘Ğ” (Ğ²Ğ°Ñˆ ÑĞµÑ€Ğ²Ğ¸Ñ)

```sql
-- Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ (Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğµ)
ALTER TABLE users ADD COLUMN wsid_sub VARCHAR(64) UNIQUE;
ALTER TABLE users ADD COLUMN wsid_linked_at TIMESTAMPTZ;
ALTER TABLE users ADD COLUMN auth_provider VARCHAR(20) DEFAULT 'local';
-- auth_provider: 'local' | 'waysenid' | 'both'

CREATE INDEX idx_users_wsid_sub ON users(wsid_sub);

-- Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° OAuth-Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²
CREATE TABLE oauth_tokens (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  provider VARCHAR(20) NOT NULL DEFAULT 'waysenid',
  access_token TEXT NOT NULL,        -- Ğ·Ğ°ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹!
  refresh_token TEXT,                -- Ğ·Ğ°ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹!
  id_token TEXT,
  expires_at TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(user_id, provider)
);
```

### 7.2 Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²

```javascript
// utils/crypto.js
const crypto = require('crypto');
const ENCRYPTION_KEY = process.env.TOKEN_ENCRYPTION_KEY; // 32 bytes
const IV_LENGTH = 16;

function encrypt(text) {
  const iv = crypto.randomBytes(IV_LENGTH);
  const cipher = crypto.createCipheriv('aes-256-cbc', Buffer.from(ENCRYPTION_KEY, 'hex'), iv);
  let encrypted = cipher.update(text, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  return iv.toString('hex') + ':' + encrypted;
}

function decrypt(text) {
  const [ivHex, encrypted] = text.split(':');
  const iv = Buffer.from(ivHex, 'hex');
  const decipher = crypto.createDecipheriv('aes-256-cbc', Buffer.from(ENCRYPTION_KEY, 'hex'), iv);
  let decrypted = decipher.update(encrypted, 'hex', 'utf8');
  decrypted += decipher.final('utf8');
  return decrypted;
}
```

### 7.3 ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ access_token

```javascript
async function refreshAccessToken(userId) {
  const tokens = await db.oauth_tokens.findOne({
    where: { user_id: userId, provider: 'waysenid' }
  });

  if (!tokens || !tokens.refresh_token) {
    throw new Error('No refresh token available');
  }

  const resp = await axios.post(WSID_TOKEN_URL, new URLSearchParams({
    grant_type: 'refresh_token',
    refresh_token: decrypt(tokens.refresh_token),
    client_id: CLIENT_ID,
    client_secret: CLIENT_SECRET,
  }));

  const newTokens = resp.data;

  await tokens.update({
    access_token: encrypt(newTokens.access_token),
    refresh_token: newTokens.refresh_token
      ? encrypt(newTokens.refresh_token)
      : tokens.refresh_token,
    expires_at: new Date(Date.now() + newTokens.expires_in * 1000),
    updated_at: new Date(),
  });

  return newTokens.access_token;
}
```

---

## 8. Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ

### 8.1 ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ flow Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ñ‡ĞµÑ€ĞµĞ· WaySenID

ĞšĞ¾Ğ³Ğ´Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ Â«Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ· WaySenIDÂ» Ğ¸ Ñƒ Ğ½ĞµĞ³Ğ¾ **Ğ½ĞµÑ‚ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    auth.markbase.ru (popup/page)                     â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           â”Œâ”€â”€â”€â”€â”€â”                                              â”‚  â”‚
â”‚  â”‚           â”‚ ğŸŒ  â”‚                                              â”‚  â”‚
â”‚  â”‚           â””â”€â”€â”€â”€â”€â”˜                                              â”‚  â”‚
â”‚  â”‚          WaySenID                                              â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚   â”‚  Email                                               â”‚     â”‚  â”‚
â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚     â”‚  â”‚
â”‚  â”‚   â”‚  â”‚ newuser@example.com                          â”‚    â”‚     â”‚  â”‚
â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚     â”‚  â”‚
â”‚  â”‚   â”‚                                                      â”‚     â”‚  â”‚
â”‚  â”‚   â”‚  [ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ â†’]                                      â”‚     â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚   ĞĞµÑ‚ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°?  Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â”‚                              â–¼  (email Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½)                    â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          WaySenID â€” Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ                                â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚   Email: newuser@example.com                                   â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚   ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ:           [________________________]                 â”‚  â”‚
â”‚  â”‚   ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ:      [________________________]                 â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚   Ğ¡Ğ¸Ğ»Ğ° Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¸Ğ¹                            â”‚  â”‚
â”‚  â”‚   â€¢ ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 8 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ² âœ“                                      â”‚  â”‚
â”‚  â”‚   â€¢ Ğ—Ğ°Ğ³Ğ»Ğ°Ğ²Ğ½Ñ‹Ğµ Ğ¸ ÑÑ‚Ñ€Ğ¾Ñ‡Ğ½Ñ‹Ğµ âœ“                                    â”‚  â”‚
â”‚  â”‚   â€¢ Ğ¦Ğ¸Ñ„Ñ€Ñ‹ âœ“                                                   â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚   [Captcha â€” Ğ¯Ğ½Ğ´ĞµĞºÑ SmartCaptcha]                              â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚   â˜‘ Ğ¯ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ñ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸                        â”‚  â”‚
â”‚  â”‚     Ğ¿Ğ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºÑƒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ´ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸                                â”‚  â”‚
â”‚  â”‚   â˜‘ Ğ¯ Ğ´Ğ°Ñ ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¸Ğµ Ğ½Ğ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ                               â”‚  â”‚
â”‚  â”‚     Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…                                        â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚   [Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ â†’]                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â”‚                              â–¼  (Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½, ĞĞ Ğ½Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½)      â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          WaySenID â€” ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ email                         â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚          â”Œâ”€â”€â”€â”€â”€â”                                               â”‚  â”‚
â”‚  â”‚          â”‚ âœ‰ï¸   â”‚                                               â”‚  â”‚
â”‚  â”‚          â””â”€â”€â”€â”€â”€â”˜                                               â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚   ĞœÑ‹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¸ ĞºĞ¾Ğ´ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ½Ğ°                            â”‚  â”‚
â”‚  â”‚   newuser@example.com                                          â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚   Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ 6-Ğ·Ğ½Ğ°Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´:                                      â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”                       â”‚  â”‚
â”‚  â”‚   â”‚ 4 â”‚ â”‚ 7 â”‚ â”‚ 2 â”‚ â”‚ 9 â”‚ â”‚ 1 â”‚ â”‚ 5 â”‚                       â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜                       â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚   ĞĞµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ¸? ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ (Ñ‡ĞµÑ€ĞµĞ· 58 ÑĞµĞº)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â”‚                              â–¼  (email Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ñ‘Ğ½)                  â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          Consent Screen (Ğ´Ğ»Ñ waygpt.ru)                        â”‚  â”‚
â”‚  â”‚          ... (ĞºĞ°Ğº Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¾ Ğ² README.md Â§7)                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â”‚                              â–¼  (Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¶Ğ°Ğ» Â«Ğ Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚ÑŒÂ»)     â”‚
â”‚                                                                      â”‚
â”‚  redirect â†’ waygpt.ru/auth/callback?code=...&state=...              â”‚
â”‚  Ğ¸Ğ»Ğ¸ postMessage â†’ { type: 'wsid:auth_success', code, state }      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 Ğ§Ñ‚Ğ¾ Ğ’ĞĞ–ĞĞ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ° Ğ²Ğ°ÑˆĞµĞ³Ğ¾ ÑĞµÑ€Ğ²Ğ¸ÑĞ°

1. **Ğ’Ğ°Ğ¼ ĞĞ• Ğ½ÑƒĞ¶Ğ½Ğ¾** Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ â€” WaySenID Ğ´ĞµĞ»Ğ°ĞµÑ‚ ÑÑ‚Ğ¾ ÑĞ°Ğ¼
2. **Ğ’Ğ°Ğ¼ ĞĞ• Ğ½ÑƒĞ¶Ğ½Ğ¾** Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ğ°Ñ‚ÑŒ email â€” WaySenID Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ `email_verified: true`
3. **Ğ’Ğ°Ğ¼ ĞĞ• Ğ½ÑƒĞ¶Ğ½Ğ¾** Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ğ¸ WaySenID-Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
4. **Ğ’Ğ°Ğ¼ ĞĞ£Ğ–ĞĞ** Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ callback Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ² ÑĞ²Ğ¾ĞµĞ¹ Ğ‘Ğ”
5. **Ğ’Ğ°Ğ¼ ĞĞ£Ğ–ĞĞ** Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑÑ‚ÑŒ `email_verified` Ğ² Ğ¾Ñ‚Ğ²ĞµÑ‚Ğµ `/oauth/userinfo`
6. **Ğ’Ğ°Ğ¼ ĞĞ£Ğ–ĞĞ** Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ°Ñ‚ÑŒ Â«Ğ½Ğ¾Ğ²Ñ‹Ñ…Â» Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¾Ñ‚ Â«Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ñ…Â» (Ğ´Ğ»Ñ onboarding)

### 8.3 Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ğ¸ WaySenID Ğ¿Ñ€Ğ¸ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸

| Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|----------|----------|
| **Email Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ñ‘Ğ½** | ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ğ°ĞµÑ‚ email 6-Ğ·Ğ½Ğ°Ñ‡Ğ½Ñ‹Ğ¼ ĞºĞ¾Ğ´Ğ¾Ğ¼ |
| **ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ½Ğ°Ğ´Ñ‘Ğ¶Ğ½Ñ‹Ğ¹** | ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 8 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ², Ğ·Ğ°Ğ³Ğ»Ğ°Ğ²Ğ½Ñ‹Ğµ + ÑÑ‚Ñ€Ğ¾Ñ‡Ğ½Ñ‹Ğµ + Ñ†Ğ¸Ñ„Ñ€Ñ‹ |
| **Captcha Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ğ°** | Ğ¯Ğ½Ğ´ĞµĞºÑ SmartCaptcha Ğ½Ğ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ |
| **Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑĞ¸Ñ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ñ‹** | ĞŸĞ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ´ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ + ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ + ĞŸĞ” |
| **Anti-bruteforce** | ĞœĞ°ĞºÑ. 10 Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº / 30 Ğ¼Ğ¸Ğ½ |
| **Anti-DDoS** | Rate limiting Ğ½Ğ° Ğ²ÑĞµ endpoints |
| **Unique email** | ĞĞ´Ğ¸Ğ½ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Ğ½Ğ° Ğ¾Ğ´Ğ¸Ğ½ email |

---

## 9. ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: WayGPT

### 9.1 Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²

```
waygpt/
â”œâ”€â”€ .env                          # Credentials (ĞĞ˜ĞšĞĞ“Ğ”Ğ Ğ² git!)
â”œâ”€â”€ .env.example                  # Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½
â”œâ”€â”€ package.json
â”œâ”€â”€ server.js                     # Express app
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ auth.js                   # Ğ’ÑĞµ auth routes
â”‚   â””â”€â”€ api.js                    # API routes
â”œâ”€â”€ middleware/
â”‚   â””â”€â”€ requireAuth.js            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ User.js                   # ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
â”‚   â””â”€â”€ OAuthToken.js             # ĞœĞ¾Ğ´ĞµĞ»ÑŒ OAuth-Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ crypto.js                 # Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ login.html                # Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ°
â”‚   â””â”€â”€ css/
â”‚       â””â”€â”€ login.css             # Ğ¡Ñ‚Ğ¸Ğ»Ğ¸
â””â”€â”€ views/
    â””â”€â”€ dashboard.ejs             # Dashboard
```

### 9.2 Ğ¤Ğ°Ğ¹Ğ» .env.example

```env
# â”€â”€ WaySenID OAuth â”€â”€
WSID_CLIENT_ID=wsid_app_waygpt_abc123
WSID_CLIENT_SECRET=wsid_secret_xxxxxxxxxxxxxxxxxxx
WSID_REDIRECT_URI=https://waygpt.ru/auth/wsid/callback

# â”€â”€ Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ â”€â”€
SESSION_SECRET=your-session-secret-min-32-chars-random
TOKEN_ENCRYPTION_KEY=64-hex-chars-for-aes-256

# â”€â”€ Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… â”€â”€
DATABASE_URL=postgres://user:pass@localhost:5432/waygpt

# â”€â”€ ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ â”€â”€
NODE_ENV=production
PORT=3000
APP_URL=https://waygpt.ru
```

### 9.3 Middleware Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

```javascript
// middleware/requireAuth.js
module.exports = function requireAuth(req, res, next) {
  if (!req.session || !req.session.user_id) {
    // API Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ â†’ 401
    if (req.path.startsWith('/api/')) {
      return res.status(401).json({ error: 'unauthorized' });
    }
    // ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ â†’ Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚ Ğ½Ğ° Ğ»Ğ¾Ğ³Ğ¸Ğ½
    return res.redirect(`/login?return_url=${encodeURIComponent(req.originalUrl)}`);
  }

  next();
};
```

### 9.4 Env-Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ docker-compose

```yaml
# docker-compose.yml (Ñ„Ñ€Ğ°Ğ³Ğ¼ĞµĞ½Ñ‚)
services:
  waygpt:
    image: waygpt:latest
    environment:
      - WSID_CLIENT_ID=${WSID_CLIENT_ID}
      - WSID_CLIENT_SECRET=${WSID_CLIENT_SECRET}
      - WSID_REDIRECT_URI=https://waygpt.ru/auth/wsid/callback
      - SESSION_SECRET=${SESSION_SECRET}
      - TOKEN_ENCRYPTION_KEY=${TOKEN_ENCRYPTION_KEY}
    # ĞĞ˜ĞšĞĞ“Ğ”Ğ Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ²Ğ°Ñ‚ÑŒ secrets Ñ‡ĞµÑ€ĞµĞ· environment Ğ² Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¾Ğ¼ Ğ²Ğ¸Ğ´Ğµ
    # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Docker secrets Ğ¸Ğ»Ğ¸ vault
```

---

## 10. Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ â€” Ñ‡ĞµĞºĞ»Ğ¸ÑÑ‚

### 10.1 ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

| # | Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ | Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ |
|---|------------|--------|
| 1 | `client_secret` Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑÑ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ, ĞĞ˜ĞšĞĞ“Ğ”Ğ Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚Ğµ | â˜ |
| 2 | `client_secret` ĞĞ• Ğ² git (Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ² .gitignore) | â˜ |
| 3 | ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ `state` Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ callback | â˜ |
| 4 | PKCE Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ (code_challenge + code_verifier) | â˜ |
| 5 | `redirect_uri` ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ñ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¼ â€” Ğ´Ğ¾ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ° | â˜ |
| 6 | `access_token` Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑÑ Ğ² httpOnly cookie Ğ¸Ğ»Ğ¸ ÑĞµÑ€Ğ²ĞµÑ€Ğ½Ğ¾Ğ¹ ÑĞµÑÑĞ¸Ğ¸ | â˜ |
| 7 | `access_token` Ğ¸ `refresh_token` Ğ·Ğ°ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ² Ğ‘Ğ” (AES-256) | â˜ |
| 8 | ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ÑÑ `email_verified: true` Ğ² userinfo | â˜ |
| 9 | Ğ’ popup-Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ÑÑ `event.origin` Ğ² postMessage | â˜ |
| 10 | Ğ’ÑĞµ OAuth-ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚Ñ‹ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ HTTPS | â˜ |
| 11 | `refresh_token` Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸ | â˜ |
| 12 | ĞŸÑ€Ğ¸ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğµ Ñ‚Ğ¾ĞºĞµĞ½ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· `/oauth/revoke` | â˜ |
| 13 | Ğ¡ĞµÑÑĞ¸Ñ Ğ¸Ğ¼ĞµĞµÑ‚ TTL (Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ 72 Ñ‡Ğ°ÑĞ°, Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ 24) | â˜ |
| 14 | Rate limiting Ğ½Ğ° callback endpoint (Ğ¼Ğ°ĞºÑ. 30/Ğ¼Ğ¸Ğ½) | â˜ |
| 15 | Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ²ÑĞµÑ… OAuth-ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ (login, logout, errors) | â˜ |

### 10.2 Ğ—Ğ°Ğ¿Ñ€ĞµÑ‰ĞµĞ½Ğ¾

| Ğ—Ğ°Ğ¿Ñ€ĞµÑ‚ | ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ |
|--------|--------|
| Ğ¥Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ `access_token` Ğ² localStorage | XSS-ÑƒÑĞ·Ğ²Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ |
| Ğ¥Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ `client_secret` Ğ² JS-Ğ±Ğ°Ğ½Ğ´Ğ»Ğµ | Ğ£Ñ‚ĞµÑ‡ĞºĞ° Ñ‡ĞµÑ€ĞµĞ· Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ |
| ĞŸĞµÑ€ĞµĞ´Ğ°Ğ²Ğ°Ñ‚ÑŒ `access_token` Ğ² URL (query params) | Referer, Ğ»Ğ¾Ğ³Ğ¸, Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ |
| ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ `state` | CSRF-Ğ°Ñ‚Ğ°ĞºĞ° |
| Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ HTTP (Ğ½Ğµ HTTPS) | Man-in-the-middle |
| Ğ”Ğ¾Ğ²ĞµÑ€ÑÑ‚ÑŒ `email` Ğ±ĞµĞ· `email_verified` | ĞŸĞ¾Ğ´Ğ¼ĞµĞ½Ğ° email |
| Ğ¥Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ½ĞµĞ·Ğ°ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ‚Ğ¾ĞºĞµĞ½Ñ‹ Ğ² Ğ‘Ğ” | SQL injection â†’ ÑƒÑ‚ĞµÑ‡ĞºĞ° |

### 10.3 Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸

| Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ñ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|-------------|----------|
| Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ PKCE | Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ¿ĞµÑ€ĞµÑ…Ğ²Ğ°Ñ‚Ğ° code |
| Minimum scopes | Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°Ğ¹Ñ‚Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ |
| Token rotation | `refresh_token` Ğ¾Ğ´Ğ½Ğ¾Ñ€Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ |
| Audit log | Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ²ÑĞµ auth-ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ |
| CSP headers | `Content-Security-Policy` Ğ´Ğ»Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹ Ğ¾Ñ‚ XSS |
| HSTS | `Strict-Transport-Security` Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº |

---

## 11. FAQ Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸

### Q: Ğ§Ñ‚Ğ¾ ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ·Ğ°ĞºÑ€Ñ‹Ğ» popup Ğ½Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ğ² Ğ²Ñ…Ğ¾Ğ´?

SDK Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ popup Ğ¸ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ `onError({ error: 'popup_closed' })`. Ğ’Ğ°Ñˆ ÑĞ°Ğ¹Ñ‚ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ Ğ²Ñ…Ğ¾Ğ´Ğ°. ĞĞ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚.

### Q: Ğ§Ñ‚Ğ¾ ĞµÑĞ»Ğ¸ WaySenID Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½?

SDK Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ `temporarily_unavailable`. Ğ’Ğ°Ñˆ ÑĞ°Ğ¹Ñ‚ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½:
1. ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Â«Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½Â»
2. ĞŸÑ€ĞµĞ´Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ Ğ°Ğ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ²Ñ…Ğ¾Ğ´ (email/Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ)
3. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· 30 ÑĞµĞºÑƒĞ½Ğ´

### Q: ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ñ…Ğ¾Ğ´ Ğ¸ WaySenID?

Ğ”Ğ°. Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ñ‹Ğ¹ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´:
- ĞĞ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ Ğ²Ñ…Ğ¾Ğ´Ğ°: Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ°Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ° + ĞºĞ½Ğ¾Ğ¿ĞºĞ° Â«Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ· WaySenIDÂ»
- Ğ’ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ñ…: Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ñ‚ÑŒ/Ğ¾Ñ‚Ğ²ÑĞ·Ğ°Ñ‚ÑŒ WaySenID
- Ğ’ Ğ‘Ğ”: Ğ¿Ğ¾Ğ»Ğµ `wsid_sub` (nullable) + Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğµ email/password

### Q: Ğ§Ñ‚Ğ¾ ĞµÑĞ»Ğ¸ email Ğ¸Ğ· WaySenID ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ² Ğ¼Ğ¾ĞµĞ¹ Ğ‘Ğ”?

ĞŸÑ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ²Ñ…Ğ¾Ğ´Ğµ Ñ‡ĞµÑ€ĞµĞ· WaySenID: ĞµÑĞ»Ğ¸ email ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ â€” **Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ñ‚ÑŒ** WaySenID Ğº ÑÑ‚Ğ¾Ğ¼Ñƒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ñƒ (Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚). ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ `email_verified: true`.

### Q: ĞšĞ°Ğº Ğ¾Ñ‚Ğ»Ğ°Ğ¶Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾?

1. Ğ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ `http://localhost:3000/auth/callback` ĞºĞ°Ğº redirect_uri
2. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ `display=page` (popup Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ)
3. Ğ”Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¾Ğ²: `prompt=login` â€” Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ğ²Ñ…Ğ¾Ğ´Ğ°

### Q: ĞšĞ°Ğº Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ scopes Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ Ğ²Ñ…Ğ¾Ğ´Ğ°?

Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ scope Ğ² Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ `/oauth/authorize`. WaySenID Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ğ¾ĞºĞ°Ğ¶ĞµÑ‚ Consent Screen Ñ Ğ½Ğ¾Ğ²Ñ‹Ğ¼Ğ¸ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸ÑĞ¼Ğ¸.

---

## Changelog

### 2026-02-09
- **v2.0.0** â€” ĞŸĞ¾Ğ»Ğ½Ğ¾Ğµ Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ñ lifecycle-Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°Ğ¼Ğ¸, Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸ĞµĞ¹ Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ, Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ¾Ğ¼ WayGPT, Ñ‡ĞµĞºĞ»Ğ¸ÑÑ‚Ğ¾Ğ¼ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸, ÑÑ…ĞµĞ¼Ğ¾Ğ¹ Ğ‘Ğ”
