# Единый вход во всех модулях markbase.ru

> **Применимо к:** app.markbase.ru, shop.markbase.ru, delivery, logistics, crm, orders, files, hrm и всем проектам экосистемы MarkBase.

---

## 1. Принцип

Во **всех** модулях и проектах на доменах `*.markbase.ru` вход и регистрация выполняются **только через WaySenID** (auth.markbase.ru). Собственных форм ввода email/пароля и капчи на стороне модуля **не должно быть**.

- **Вход:** одна кнопка «Войти через WaySenID» → открывается **всплывающее окно** (popup) с страницей auth.markbase.ru/login.
- **Регистрация:** одна кнопка «Зарегистрироваться через WaySenID» → popup с auth.markbase.ru/register.

Вся логика (капча, подтверждение email, смена пароля и т.д.) находится на auth.markbase.ru. Настройки капчи (основная/дополнительная, тип, сложность) задаются в панели captcha.markbase.ru и подгружаются по ключам; изменения не требуют правок в коде модулей.

---

## 2. Реализация на модуле (app, shop и т.д.)

### 2.1 Страница входа

- Отображать **только** кнопку «Войти через WaySenID».
- По клику: открыть popup с URL  
  `https://auth.markbase.ru/login?return_url=<callback модуля>`.
- `return_url` должен вести на страницу модуля, которая:
  - принимает редирект из popup после успешного входа,
  - отправляет в родительское окно `postMessage({ type: 'wsid:auth_success', to: '/dashboard' })`,
  - закрывает popup.
- Родительское окно (страница входа модуля) слушает `message`: при `type === 'wsid:auth_success'` выполняет проверку сессии (например, GET /api/auth/me) и переход по `to` (например, на дашборд или на ту же страницу, с которой открывали вход).

### 2.2 Страница регистрации

- Аналогично: только кнопка «Зарегистрироваться через WaySenID».
- Popup: `https://auth.markbase.ru/register?return_url=<callback модуля>`.
- Тот же callback и тот же обработчик `postMessage`, что и для входа.

### 2.3 Callback-URL модуля

Рекомендуемый вид:  
`https://<модуль>.markbase.ru/auth/callback?to=<путь после входа>`.

Пример для app:  
`https://app.markbase.ru/auth/callback?to=/dashboard`.

После редиректа с auth в этот URL страница callback в popup отправляет `postMessage` в `opener` и закрывает окно.

---

## 3. Куда попадает пользователь после входа/регистрации

- **Та же страница:** если пользователь нажал «Войти» на главной модуля — после успешного входа он остаётся на главной (или переходит на дашборд, по политике модуля).
- **return_url:** если вход был инициирован с защищённой страницы (например, «Для просмотра нужен вход»), после входа — редирект обратно на эту страницу.
- **Дашборд:** по умолчанию после первого входа можно перенаправлять на главную страницу приложения или дашборд (например, `/dashboard`).

---

## 4. Капча и настройки

- Капча (тип, сложность, основная/доп. провайдер) настраивается **только** в панели captcha.markbase.ru (платформенный проект «MarkBase Internal»).
- Модули **не** содержат своих форм капчи и не дублируют настройки. Ключи и конфиг подгружаются через API captcha и env; все изменения в captcha и auth применяются ко всем модулям без доработки кода.

Подробнее: [CAPTCHA_WIDGET.md](./CAPTCHA_WIDGET.md), [plugins/captcha/README.md](./plugins/captcha/README.md), [auth-widget/INTEGRATION.md](./auth-widget/INTEGRATION.md).

---

## 5. Итог

| Требование | Описание |
|------------|----------|
| Нет своих форм входа/регистрации | Только кнопки «Войти через WaySenID» / «Зарегистрироваться через WaySenID» |
| Вход через popup | Открытие auth.markbase.ru в всплывающем окне с `return_url` на callback модуля |
| Callback на стороне модуля | Страница `/auth/callback?to=...` принимает редирект, шлёт `postMessage` в opener, закрывает popup |
| Один аккаунт | WaySenID (UAM); cookie `uam_session` на `.markbase.ru` |
| Капча и настройки | Централизованно на auth/captcha; в модулях не дублируются |

Так достигается **единообразие** входа и регистрации на app, shop и во всех модулях markbase.ru.
