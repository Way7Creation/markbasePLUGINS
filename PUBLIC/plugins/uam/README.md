# Plugin: UAM (WaySenID) โ ะะดะธะฝะฐั ะฐััะตะฝัะธัะธะบะฐัะธั

> **ะะตััะธั:** 1.5.0
> **Slug:** `uam`
> **Endpoint:** `https://auth.markbase.ru`
> **Cookie:** `uam_session` ะฝะฐ `.markbase.ru`

---

## ะะฑะทะพั

UAM (WaySenID) โ ัะตะฝััะฐะปะธะทะพะฒะฐะฝะฝัะน ัะตัะฒะธั ะฐััะตะฝัะธัะธะบะฐัะธะธ ะฟะปะฐััะพัะผั MarkBase. ะัะต ะผะพะดัะปะธ ะธ ััะพัะพะฝะฝะธะต ะฟัะพะตะบัั ะธัะฟะพะปัะทััั ะตะดะธะฝัะน ะฒัะพะด ัะตัะตะท UAM.

**ะัะธะฝัะธะฟ:** ะฟะพะปัะทะพะฒะฐัะตะปั ัะตะณะธัััะธััะตััั ะธ ะฒัะพะดะธั **ะพะดะธะฝ ัะฐะท** ัะตัะตะท auth.markbase.ru. Cookie `uam_session` ะดะตะนััะฒัะตั ะฝะฐ ะฒัะตั ะฟะพะดะดะพะผะตะฝะฐั `.markbase.ru`. ะกัะพัะพะฝะฝะธะต ะฟัะพะตะบัั ะฒะฐะปะธะดะธัััั ัะตััะธั ัะตัะตะท API.

### ะงัะพ ะฝะพะฒะพะณะพ ะฒ v1.5.0

- **ะะตัะตะบะปััะตะฝะธะต ะฑะตะท ะฟะฐัะพะปั** โ ะฟัะธ ัะผะตะฝะต ะฐะบะบะฐัะฝัะฐ ะฟะฐัะพะปั ะฝะต ะทะฐะฟัะฐัะธะฒะฐะตััั, ะตัะปะธ ะฒะปะฐะดะตะปะตั ะฐะบะบะฐัะฝัะฐ ะฝะต ะฒะบะปััะธะป ยซะัะตะณะดะฐ ะทะฐะฟัะฐัะธะฒะฐัั ะฟะฐัะพะปัยป ะธ ั ะฟะพัะปะตะดะฝะตะณะพ ะฒัะพะดะฐ ะฟัะพัะปะพ ะผะตะฝััะต N ะดะฝะตะน (ะฟะพ ัะผะพะปัะฐะฝะธั 180). ะกัะพัะพะฝะฝะธะต ะผะพะดัะปะธ **ะพะฑัะทะฐะฝั** ัะตะฐะปะธะทะพะฒะฐัั ัั ะถะต ะปะพะณะธะบั (ัะผ. ัะฟะตัะธัะธะบะฐัะธั Account Switcher).
- **POST /switch-with-token** โ ะฟะตัะตะบะปััะตะฝะธะต ะฟะพ ัะพะบะตะฝั; ะฝะฐัััะพะนะบะธ ะฒ ัะฐะทะดะตะปะต ยซะะตะทะพะฟะฐัะฝะพัััยป: ะฒัะตะณะดะฐ ะฟะฐัะพะปั / ัะพะปัะบะพ ะฟะพัะปะต ะดะพะปะณะพะณะพ ะฝะตะฒัะพะดะฐ.
- **ะะตัะบะธ ััััะพะนััะฒ** โ ะฒ ัะฟะธัะบะต ัะตััะธะน ะผะพะถะฝะพ ะทะฐะดะฐัั ะฝะฐะทะฒะฐะฝะธะต ััััะพะนััะฒะฐ (PATCH /sessions/:id).

### ะงัะพ ะฝะพะฒะพะณะพ ะฒ v1.4.0

- **Account Switcher** โ ะฟะตัะตะบะปััะตะฝะธะต ะผะตะถะดั ะฐะบะบะฐัะฝัะฐะผะธ ะฟััะผะพ ะธะท ัะฐะฟะบะธ ะปัะฑะพะณะพ ะผะพะดัะปั + ะดะพะฑะฐะฒะปะตะฝะธะต ะฝะพะฒัั ะฐะบะบะฐัะฝัะพะฒ
- **`?switch=email`** โ URL-ะฟะฐัะฐะผะตัั ะดะปั ะฑััััะพะณะพ ะฟะตัะตะบะปััะตะฝะธั (ะฟัะพะฟััะบะฐะตั Account Picker โ ััะฐะทั ะฒะฒะพะด ะฟะฐัะพะปั)
- **`?new_account=1`** โ URL-ะฟะฐัะฐะผะตัั ะดะปั ะดะพะฑะฐะฒะปะตะฝะธั ะฝะพะฒะพะณะพ ะฐะบะบะฐัะฝัะฐ (ััะฐะทั ะฒะฒะพะด email)
- **GET /logout ั redirect** โ ะฒััะพะด ัะตัะตะท ัััะปะบั ั `?return_url=` (ะดะปั PHP/WordPress/HTML ะธะฝัะตะณัะฐัะธะน)
- **ะกะฟะตัะธัะธะบะฐัะธั Account Switcher** โ ะฟะพะปะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั ั ะณะพัะพะฒัะผ React-ะบะพะผะฟะพะฝะตะฝัะพะผ ะดะปั ัะตะฐะปะธะทะฐัะธะธ ะฒ ะปัะฑะพะผ ะผะพะดัะปะต
- **ะัะพะฒะตัะบะฐ email ะฟะตัะตะด ะฒัะพะดะพะผ** โ `POST /check-email` ะพะฟัะตะดะตะปัะตั, ัััะตััะฒัะตั ะปะธ ะฐะบะบะฐัะฝั, ะดะพ ะฒะฒะพะดะฐ ะฟะฐัะพะปั
- **ะฃะผะฝัะน UX ะปะพะณะธะฝะฐ** โ ะตัะปะธ ะฐะบะบะฐัะฝั ะฝะต ะฝะฐะนะดะตะฝ โ ะฟัะตะดะปะพะถะตะฝะธะต ะทะฐัะตะณะธัััะธัะพะฒะฐัััั ั ะฐะฒัะพะทะฐะฟะพะปะฝะตะฝะธะตะผ email
- **ะฃะผะฝัะน UX ัะตะณะธัััะฐัะธะธ** โ ะตัะปะธ ะฐะบะบะฐัะฝั ัะถะต ัััะตััะฒัะตั โ ะฟัะตะดะปะพะถะตะฝะธะต ะฒะพะนัะธ
- **ะะฐะทะปะธัะตะฝะธะต ะพัะธะฑะพะบ** โ backend ะฒะพะทะฒัะฐัะฐะตั `reason: 'user_not_found'` (ะปะพะณะธะฝ) ะธ `reason: 'email_taken'` (ัะตะณะธัััะฐัะธั)
- **ะะตัะตะดะฐัะฐ email ะผะตะถะดั ัััะฐะฝะธัะฐะผะธ** โ URL-ะฟะฐัะฐะผะตัั `?email=` ะดะปั ะฑะตััะพะฒะฝะพะณะพ ะฟะตัะตัะพะดะฐ ะผะตะถะดั ะปะพะณะธะฝะพะผ ะธ ัะตะณะธัััะฐัะธะตะน

### ะงัะพ ะฝะพะฒะพะณะพ ะฒ v1.3.0

- **ะะพะปะฝัะน ัะตะดะธะทะฐะนะฝ** โ ะธะฝัะตััะตะนั ะฒ ััะธะปะต Yandex ID
- **ะะฝะพะณะพััะพะฒะฝะตะฒะฐั ะทะฐัะธัะฐ** โ brute-force, DDoS, rate limiting, IP-ะฑะปะพะบะธัะพะฒะบะฐ
- **Captcha** โ ะธะฝัะตะณัะฐัะธั ั MarkBase Captcha (ัะพะฑััะฒะตะฝะฝะฐั + ะฏะฝะดะตะบั + Google) ะฝะฐ ัะตะณะธัััะฐัะธะธ ะธ ะฒัะพะดะต
- **ะัะฑะพั ะฐะบะบะฐัะฝัะพะฒ** โ ะดะพ 5 ะทะฐะฟะพะผะฝะตะฝะฝัั ะฐะบะบะฐัะฝัะพะฒ ั ัะดะฐะปะตะฝะธะตะผ/ะฟะตัะตะบะปััะตะฝะธะตะผ
- **ะฃะฟัะฐะฒะปะตะฝะธะต IP** โ ะฟะพะปัะทะพะฒะฐัะตะปะธ ะผะพะณัั ะพะณัะฐะฝะธัะธะฒะฐัั ะฒัะพะด ัะพะปัะบะพ ั ะดะพะฒะตัะตะฝะฝัั IP
- **ะฆะตะฝัั ะฑะตะทะพะฟะฐัะฝะพััะธ** โ ะพัะตะฝะบะฐ ะทะฐัะธัั, ะธััะพัะธั ะฒัะพะดะพะฒ, ััะฐััั ะผะพะดัะปะตะน
- **ะัะพะณัะตััะธะฒะฝะฐั ะฑะปะพะบะธัะพะฒะบะฐ** โ ะฟัะธ 10+ ะฝะตัะดะฐัะฝัั ะฟะพะฟััะบะฐั IP ะฑะปะพะบะธััะตััั ะฝะฐ 60โ120โ240 ะผะธะฝ
- **ะัะดะธั** โ ะฟะพะปะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต ะฒัะพะดะพะฒ, ัะผะตะฝั ะฟะฐัะพะปะตะน, ะพัะทัะฒะฐ ัะตััะธะน

---

## ะกัะตะผะฐ ัะฐะฑะพัั

```
โโโโโโโโโโโโโโโโ    1. Redirect     โโโโโโโโโโโโโโโโโโโโ
โ  ะะฐั ะฟัะพะตะบั  โ โโโโโโโโโโโโโโโโ> โ  auth.markbase.ru โ
โ  (ะปัะฑะพะน)     โ                    โ     Login Page    โ
โโโโโโโโฌโโโโโโโโ                    โโโโโโโโโโฌโโโโโโโโโโ
       โ                                      โ
       โ   4. Redirect back                   โ 2. POST /api/uam/v1/login
       โ   + cookie uam_session               โ    {email, password}
       โ <โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
       โ                                      โ 3. Set-Cookie: uam_session
       โ                                      โ    Domain: .markbase.ru
       โผ
โโโโโโโโโโโโโโโโ    5. Validate      โโโโโโโโโโโโโโโโโโโโ
โ  ะะฐั Backend โ โโโโโโโโโโโโโโโโ> โ  UAM Internal API โ
โ              โ                    โ  /session/validateโ
โ              โ <โโโโโโโโโโโโโโโโ โ  {user_id, email} โ
โโโโโโโโโโโโโโโโ    6. User data     โโโโโโโโโโโโโโโโโโโโ
```

### ะัะพะตะบัั ั ัะพะฑััะฒะตะฝะฝะพะน ัะตะณะธัััะฐัะธะตะน (ยซะะพะนัะธ ะบะฐะบยป)

ะัะปะธ ั ะฒะฐั **ัะฒะพั ัะพัะผะฐ ะฒัะพะดะฐ/ัะตะณะธัััะฐัะธะธ** ะธ ะฒั ัะพัะธัะต ะดะพะฑะฐะฒะธัั WaySenID ะบะฐะบ ะตัั ะพะดะธะฝ ัะฟะพัะพะฑ (ะฐะฝะฐะปะพะณะธัะฝะพ ยซะะพะนัะธ ัะตัะตะท Googleยป / ยซะฏะฝะดะตะบัยป): ะพะดะฝะฐ ะบะฝะพะฟะบะฐ ยซะะพะนัะธ ัะตัะตะท WaySenIDยป, ะฑะตะท ะดัะฑะปะธัะพะฒะฐะฝะธั ัะพัะผ ะธ ะบะฐะฟัะธ. ะะฐะฝะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะตัะตะดะฐัััั ัะตัะตะท cookie (ะฝะฐ \*.markbase.ru) ะธะปะธ ัะตัะตะท ะพะดะฝะพัะฐะทะพะฒัะน `wsid_code` + `POST /exchange-code` (ะฝะฐ ััะพัะพะฝะฝะตะผ ะดะพะผะตะฝะต).

โ **[WAYSENID_LOGIN_AS.md](../../WAYSENID_LOGIN_AS.md)** โ ะฟะพัะฐะณะพะฒะพะต ะฟะพะดะบะปััะตะฝะธะต, ะดะฒะฐ ะฒะฐัะธะฐะฝัะฐ (ัะพั ะถะต ะดะพะผะตะฝ / ััะพัะพะฝะฝะธะน ะดะพะผะตะฝ), ัะพัะผะฐั ะดะฐะฝะฝัั, ัะตะบะปะธัั.

---

## ะะฝะพะณะพััะพะฒะฝะตะฒะฐั ัะธััะตะผะฐ ะทะฐัะธัั

> **v1.3.0** โ UAM ะฒะบะปััะฐะตั **10 ะผะพะดัะปะตะน ะฑะตะทะพะฟะฐัะฝะพััะธ**, ะบะพัะพััะต ัะฐะฑะพัะฐัั ะฐะฒัะพะผะฐัะธัะตัะบะธ.

### ะะพะดัะปะธ ะทะฐัะธัั

| # | ะะพะดัะปั | ะะฟะธัะฐะฝะธะต | ะะฐัะฐะผะตััั |
|---|--------|----------|-----------|
| 1 | **Brute-Force Protection** | ะะณัะฐะฝะธัะตะฝะธะต ะฟะพะฟััะพะบ ะฒัะพะดะฐ ะฟะพ IP + email | 10 ะฟะพะฟััะพะบ / 30 ะผะธะฝ |
| 2 | **Progressive Lockout** | ะะฐัะฐััะฐััะฐั ะฑะปะพะบะธัะพะฒะบะฐ IP ะฟัะธ ะฟะพะฒัะพัะฝัั ะฝะฐัััะตะฝะธัั | 60 โ 120 โ 240 ะผะธะฝ |
| 3 | **IP Auto-Block** | ะะฒัะพะผะฐัะธัะตัะบะพะต ะทะฐะฝะตัะตะฝะธะต IP ะฒ ัะฐะฑะปะธัั `blocked_ips` | ะะพ ะธััะตัะตะฝะธั lockout |
| 4 | **Global Rate Limiter** | ะะณัะฐะฝะธัะตะฝะธะต ะฒัะตั API-ะทะฐะฟัะพัะพะฒ ั ะพะดะฝะพะณะพ IP | 120 ะทะฐะฟัะพัะพะฒ / 60 ัะตะบ |
| 5 | **Auth Rate Limiter** | ะะพะฟะพะปะฝะธัะตะปัะฝะพะต ะพะณัะฐะฝะธัะตะฝะธะต ะฝะฐ `/login`, `/register` | 20 ะทะฐะฟัะพัะพะฒ / 60 ัะตะบ |
| 6 | **IP Allowlist** | ะะพะปัะทะพะฒะฐัะตะปััะบะฐั ัะธะปัััะฐัะธั โ ะฒัะพะด ัะพะปัะบะพ ั ะดะพะฒะตัะตะฝะฝัั IP | ะะฐัััะฐะธะฒะฐะตััั ะฟะพะปัะทะพะฒะฐัะตะปะตะผ |
| 7 | **Password Policy** | ะขัะตะฑะพะฒะฐะฝะธั ะบ ะฟะฐัะพะปั: ะดะปะธะฝะฐ, ัะตะณะธััั, ัะธััั | ะะธะฝ. 8 ัะธะผะฒะพะปะพะฒ, A-z + 0-9 |
| 8 | **Security Headers** | HSTS, X-Frame-Options, X-XSS-Protection, no-cache | ะะฒัะพะผะฐัะธัะตัะบะธ |
| 9 | **Audit Logging** | ะะพะณะธัะพะฒะฐะฝะธะต ะฒัะตั ะดะตะนััะฒะธะน ะธ ัะพะฑััะธะน ะฑะตะทะพะฟะฐัะฝะพััะธ | ะ ัะฐะฑะปะธัั `audit_log` |
| 10 | **Session Security** | HTTP-only cookies, TTL, ะพัะทัะฒ ัะตััะธะน | 72 ัะฐัะฐ TTL |
| 11 | **Captcha Protection** | MarkBase Captcha ะพะฑัะทะฐัะตะปัะฝะฐ ะฝะฐ ัะตะณะธัััะฐัะธะธ. ะะฐ ะฒัะพะดะต โ backend conditional middleware (ะณะพัะพะฒ ะบ ะฒะบะปััะตะฝะธั ะฟัะธ ะฝะตะพะฑัะพะดะธะผะพััะธ), ะพัะฝะพะฒะฝะฐั ะทะฐัะธัะฐ ะฒัะพะดะฐ ัะตัะตะท brute-force + IP-block | ะกะพะฑััะฒะตะฝะฝะฐั + ะฏะฝะดะตะบั + Google |

### ะัะฒะตัั ะฟัะธ ะฑะปะพะบะธัะพะฒะบะต

**ะะบะบะฐัะฝั ะฝะต ะฝะฐะนะดะตะฝ (v1.4.0):**
```json
{
  "error": "ะะบะบะฐัะฝั ั ัะฐะบะธะผ email ะฝะต ะฝะฐะนะดะตะฝ",
  "reason": "user_not_found",
  "failed_count": 1,
  "remaining_attempts": 9,
  "max_attempts": 10,
  "window_minutes": 30
}
```

**ะัะธ ะฝะตัะดะฐัะฝะพะผ ะฒัะพะดะต (ะฝะตะฒะตัะฝัะน ะฟะฐัะพะปั, ะฟะพะฟััะบะธ ะตัั ะตััั):**
```json
{
  "error": "ะะตะฒะตัะฝัะต ััะตัะฝัะต ะดะฐะฝะฝัะต",
  "failed_count": 3,
  "remaining_attempts": 7,
  "max_attempts": 10,
  "window_minutes": 30,
  "warning": null
}
```

**ะัะธ ะฝะตัะดะฐัะฝะพะผ ะฒัะพะดะต (ะพััะฐะปะพัั โค 3 ะฟะพะฟััะบะธ):**
```json
{
  "error": "ะะตะฒะตัะฝัะต ััะตัะฝัะต ะดะฐะฝะฝัะต",
  "failed_count": 8,
  "remaining_attempts": 2,
  "max_attempts": 10,
  "window_minutes": 30,
  "warning": "ะััะฐะปะพัั ะฟะพะฟััะพะบ: 2 ะธะท 10"
}
```

**ะัะธ ะฑะปะพะบะธัะพะฒะบะต IP (brute-force, ะฟัะตะฒััะตะฝ ะปะธะผะธั):**
```json
{
  "error": "ะัะตะฒััะตะฝะพ ะผะฐะบัะธะผะฐะปัะฝะพะต ะบะพะปะธัะตััะฒะพ ะฟะพะฟััะพะบ (10). IP ะทะฐะฑะปะพะบะธัะพะฒะฐะฝ ะฝะฐ 60 ะผะธะฝ.",
  "failed_count": 10,
  "max_attempts": 10,
  "remaining_attempts": 0,
  "retry_after_minutes": 60,
  "protection": "brute_force_block"
}
```

**ะัะธ ะทะฐะฑะปะพะบะธัะพะฒะฐะฝะฝะพะผ IP (ะฟะพะฒัะพัะฝะฐั ะฟะพะฟััะบะฐ):**
```json
{
  "error": "IP-ะฐะดัะตั ะฒัะตะผะตะฝะฝะพ ะทะฐะฑะปะพะบะธัะพะฒะฐะฝ. ะะพะฒัะพัะธัะต ัะตัะตะท 45 ะผะธะฝ.",
  "reason": "brute_force",
  "blocked_until": "2026-02-09T13:00:00.000Z",
  "retry_after_seconds": 2700,
  "attempts_count": 12,
  "protection": "ip_blocked"
}
```

**ะัะธ auth rate limit (20 req/min):**
```json
{
  "error": "ะกะปะธัะบะพะผ ะผะฝะพะณะพ ะฟะพะฟััะพะบ ะฐะฒัะพัะธะทะฐัะธะธ. ะะพะดะพะถะดะธัะต ะผะธะฝััั.",
  "retry_after_seconds": 45,
  "protection": "auth_rate_limit"
}
```

**ะัะธ global rate limit (120 req/min):**
```json
{
  "error": "ะกะปะธัะบะพะผ ะผะฝะพะณะพ ะทะฐะฟัะพัะพะฒ. ะะพะถะฐะปัะนััะฐ, ะฟะพะดะพะถะดะธัะต.",
  "retry_after_seconds": 30,
  "protection": "rate_limit"
}
```

### ะขะฐะฑะปะธัั ะะ ะดะปั ะฑะตะทะพะฟะฐัะฝะพััะธ

```sql
-- ะะพะฟััะบะธ ะฒัะพะดะฐ (brute-force tracking)
uam.login_attempts (attempt_id, ip_address, email, success, created_at)

-- ะะฒัะพะฑะปะพะบะธัะพะฒะฐะฝะฝัะต IP
uam.blocked_ips (id, ip_address, reason, blocked_until, violation_count, created_at)

-- ะะฐัััะพะนะบะธ ะฑะตะทะพะฟะฐัะฝะพััะธ ะฟะพะปัะทะพะฒะฐัะตะปั
uam.user_security_settings (user_id, two_factor_enabled, last_password_change, ...)

-- ะัะดะธั-ะปะพะณ
uam.audit_log (log_id, user_id, action, ip_address, user_agent, metadata, created_at)

-- IP-ัะธะปัััะฐัะธั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
uam.user_ip_allowlist (id, user_id, ip_address, label, created_by, created_at)
```

---

## ะัะบะฐะทะพัััะพะนัะธะฒะพััั (Graceful Degradation)

> **ะะะะะฆะะ:** ะงัะพ ะฑั ะฝะธ ะฟัะพะธััะพะดะธะปะพ ะฝะฐ ัะตัะฒะตัะต UAM โ ะฟะตัะตะทะฐะฟััะบ, wipe ะะ, ะฟะฐะดะตะฝะธะต โ ะฟะพะปัะทะพะฒะฐัะตะปะธ
> **ะะะะะะะ ะฝะต ะฒัะปะตัะฐัั** ะธะท ะบะฐะฑะธะฝะตัะพะฒ. ะขะพะปัะบะพ ะฏะะะซะ ะดะตะนััะฒะธั ัะฐะผะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั ะผะพะณัั ะทะฐะฒะตััะธัั ัะตััะธั.

### ะงัะพ ะผะพะถะตั ัะฐะทะปะพะณะธะฝะธัั ะฟะพะปัะทะพะฒะฐัะตะปั

| ะะตะนััะฒะธะต | ะัะพ ะธะฝะธัะธะธััะตั | ะะตะทัะปััะฐั |
|----------|---------------|-----------|
| ะะฐะถะฐะป "ะัะนัะธ ะธะท ะฒัะตั ััััะพะนััะฒ" | ะะพะปัะทะพะฒะฐัะตะปั | ะัะต ัะตััะธะธ ะทะฐะฒะตััะตะฝั |
| ะกะผะตะฝะธะป ะฟะฐัะพะปั ั "ะฒัะนัะธ ะฒะตะทะดะต" | ะะพะปัะทะพะฒะฐัะตะปั | ะัะต ัะตััะธะธ ะบัะพะผะต ัะตะบััะตะน ะทะฐะฒะตััะตะฝั |
| Cookie `uam_session` ะธััะตะบะปะฐ | ะัะฐัะทะตั (ะฐะฒัะพ) | ะกะตััะธั ะธััะตะบะปะฐ ะตััะตััะฒะตะฝะฝะพ (72ั) |

### ะงัะพ ะะ ะฒะปะธัะตั ะฝะฐ ะฟะพะปัะทะพะฒะฐัะตะปะตะน

| ะกะธััะฐัะธั | ะะพะฒะตะดะตะฝะธะต |
|----------|-----------|
| UAM ะฟะตัะตะทะฐะฟัััะธะปัั | ะัั ัะฐะฑะพัะฐะตั, ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะต ะทะฐะผะตัะฐะตั |
| UAM ะะ ะฑัะปะฐ ะพัะธัะตะฝะฐ (wipe) | ะัั ัะฐะฑะพัะฐะตั, ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะต ะทะฐะผะตัะฐะตั |
| UAM ะฒะตัะฝัะป 500/503 | ะัั ัะฐะฑะพัะฐะตั, ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะต ะทะฐะผะตัะฐะตั |
| UAM ะฟะพะปะฝะพัััั ะฝะตะดะพัััะฟะตะฝ | ะัั ัะฐะฑะพัะฐะตั ะดะพ 72 ัะฐัะพะฒ |
| ะกะตััะธั "ะฝะต ะฝะฐะนะดะตะฝะฐ" ะฒ UAM | ะัั ัะฐะฑะพัะฐะตั (ะฒะพะทะผะพะถะฝะพ wipe) |

### ะะฐะบ ััะพ ัะฐะฑะพัะฐะตั: ะฟะพะปะต `reason` ะฒ ะพัะฒะตัะต UAM

ะญะฝะดะฟะพะธะฝั `GET /api/uam/v1/session/validate` ะฟัะธ ะพัะธะฑะบะต ะฒะพะทะฒัะฐัะฐะตั `reason`:

```json
// ะกะตััะธั ะฏะะะ ะพัะพะทะฒะฐะฝะฐ ะฟะพะปัะทะพะฒะฐัะตะปะตะผ โ ัะดะฐะปัะตะผ ะบัั, ัะฐะทะปะพะณะธะฝะธะฒะฐะตะผ
{ "error": "ะะตะดะตะนััะฒะธัะตะปัะฝะฐั ัะตััะธั", "reason": "revoked" }

// ะกะตััะธั ะฝะต ะฝะฐะนะดะตะฝะฐ (wipe, ัะตััะฐัั) โ ะะ ัะดะฐะปัะตะผ ะบัั
{ "error": "ะะตะดะตะนััะฒะธัะตะปัะฝะฐั ัะตััะธั", "reason": "not_found" }

// ะกะตััะธั ะธััะตะบะปะฐ ะฟะพ TTL โ ะะ ัะดะฐะปัะตะผ ะบัั (cookie ัะพะถะต ะธััะตััั)
{ "error": "ะะตะดะตะนััะฒะธัะตะปัะฝะฐั ัะตััะธั", "reason": "expired" }
```

### ะะฐัะฐะผะตััั ะบััะฐ

| ะะฐัะฐะผะตัั | ะะฝะฐัะตะฝะธะต | ะะฟะธัะฐะฝะธะต |
|----------|----------|----------|
| `CACHE_TTL` | 259 200 ัะตะบ (72 ัะฐัะฐ) | ะกะพะฒะฟะฐะดะฐะตั ั TTL ัะตััะธะธ UAM |
| `CACHE_REFRESH` | 60 ัะตะบ (1 ะผะธะฝ) | ะคะพะฝะพะฒะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ะฟัะธ ะดะพัััะฟะฝะพะผ UAM |
| `CACHE_MAX` | 10 000 | ะะฐะบัะธะผัะผ ะทะฐะฟะธัะตะน ะฒ ะฟะฐะผััะธ |

### ะะพะณะธะบะฐ

```
ะะฐะฟัะพั ะฟะพะปัะทะพะฒะฐัะตะปั
    โ
    โโโ Cookie ะฝะตั โ return null (ะฝะต ะทะฐะปะพะณะธะฝะตะฝ)
    โ
    โโโ ะัั ัะฒะตะถะธะน (< 60 ัะตะบ) โ return ะบัั (ะฝะต ะดััะณะฐะตะผ UAM)
    โ
    โโโ ะะฐะฟัะพั ะบ UAM /session/validate
           โ
           โโโ 200 OK        โ ะบััะธััะตะผ + return user
           โโโ 401 "revoked" โ ะฟะพะปัะทะพะฒะฐัะตะปั ะฏะะะ ะพัะพะทะฒะฐะป โ ัะดะฐะปัะตะผ ะบัั, return null
           โโโ 401 ะดััะณะพะต    โ wipe/ัะตััะฐัั โ return ะบัั (ะฟะพะปัะทะพะฒะฐัะตะปั ัะฐะฑะพัะฐะตั!)
           โโโ 500/503       โ return ะบัั
           โโโ Timeout       โ return ะบัั
```

---

## ะะพะปะฝัะน ัะธะบะป: ะัะพะด, ะะตะณะธัััะฐัะธั, ะะฐะฟะพะผะธะฝะฐะฝะธะต ะฐะบะบะฐัะฝัะพะฒ

### ะัะพะด (Login) โ ะกัะธะปั Yandex ID

```
ะะพะปัะทะพะฒะฐัะตะปั โ ะะฐั ะฟัะพะตะบั (/dashboard)
   โ
   โโโ Cookie uam_session ะตััั?
   โ     โโโ ะะฐ โ ะฒะฐะปะธะดะฐัะธั (ัะผ. ะบัั) โ ะฟะพะบะฐะทะฐัั dashboard
   โ     โโโ ะะตั โ redirect ะฝะฐ auth.markbase.ru/login?return_url=...
   โ
auth.markbase.ru/login
   โ
   โโโ ะััั ะทะฐะฟะพะผะฝะตะฝะฝัะต ะฐะบะบะฐัะฝัั?
   โ     โโโ ะะฐ โ ะจะฐะณ 1: ะัะฑะพั ะฐะบะบะฐัะฝัะฐ (ัะฟะธัะพะบ ะบะฐััะพัะตะบ)
   โ     โ         โโโ ะัะฑัะฐะป ะฐะบะบะฐัะฝั โ ะจะฐะณ 3: ะะฒะพะด ะฟะฐัะพะปั
   โ     โ         โโโ ยซะััะณะพะน ะฐะบะบะฐัะฝัยป โ ะจะฐะณ 2: ะะฒะพะด email
   โ     โ         โโโ ะฃะดะฐะปะธัั ะฐะบะบะฐัะฝั โ ะฃะดะฐะปัะตะผ ะธะท localStorage
   โ     โโโ ะะตั โ ะจะฐะณ 2: ะะฒะพะด email
   โ
   โโโ ะจะฐะณ 2: ะะฒะพะด email โ POST /check-email (v1.4.0)
   โ     โโโ exists: true โ ะจะฐะณ 3: ะะฒะพะด ะฟะฐัะพะปั
   โ     โโโ exists: false โ ยซะะบะบะฐัะฝั ะฝะต ะฝะฐะนะดะตะฝยป + ะบะฝะพะฟะบะฐ ยซะะฐัะตะณะธัััะธัะพะฒะฐััััยป
   โ                          (ะฟะตัะตัะพะด ะฝะฐ /register?email=... ั ะฐะฒัะพะทะฐะฟะพะปะฝะตะฝะธะตะผ)
   โ
   โโโ ะจะฐะณ 3: ะะฒะพะด ะฟะฐัะพะปั
   โ     โโโ ะะฐััะพัะบะฐ ะฒัะฑัะฐะฝะฝะพะณะพ ะฐะบะบะฐัะฝัะฐ (ะฐะฒะฐัะฐั, ะธะผั, email)
   โ     โโโ ะะพะปะต ะฟะฐัะพะปั
   โ     โโโ ะะฝะดะธะบะฐัะพั ะพััะฐะฒัะธััั ะฟะพะฟััะพะบ (ะฟัะพะณัะตัั-ะฑะฐั)
   โ     โโโ ะัะตะดัะฟัะตะถะดะตะฝะธะต ะฟัะธ โค 3 ะฟะพะฟััะบะฐั
   โ     โโโ ะะปะพะบะธัะพะฒะบะฐ ั ัะฐะนะผะตัะพะผ ะฟัะธ ะฟัะตะฒััะตะฝะธะธ ะปะธะผะธัะฐ
   โ
   โโโ POST /api/uam/v1/login โ Brute-force ะฟัะพะฒะตัะบะฐ โ Set-Cookie
   โโโ ะะบะบะฐัะฝั ะทะฐะฟะพะผะธะฝะฐะตััั ะฒ localStorage ะฑัะฐัะทะตัะฐ
   โโโ Redirect ะพะฑัะฐัะฝะพ ะฝะฐ return_url โ ะฒะฐั /dashboard
```

### ะะตะณะธัััะฐัะธั (Register)

```
ะะพะปัะทะพะฒะฐัะตะปั โ ะะฐั ะฟัะพะตะบั (/register ะธะปะธ ะบะฝะพะฟะบะฐ "ะะฐัะตะณะธัััะธัะพะฒะฐัััั")
   โ
   โโโ Redirect ะฝะฐ auth.markbase.ru/register?return_url=...

auth.markbase.ru/register[?email=user@example.com]
   โ
   โโโ ะจะฐะณ 1: Email (ะฐะฒัะพะทะฐะฟะพะปะฝัะตััั ะธะท ?email= ะฟะฐัะฐะผะตััะฐ)
   โ     โโโ POST /check-email (v1.4.0)
   โ     โ     โโโ exists: false โ ะฟัะพะดะพะปะถะธัั ัะตะณะธัััะฐัะธั
   โ     โ     โโโ exists: true โ ยซะะบะบะฐัะฝั ัะถะต ัััะตััะฒัะตัยป + ะบะฝะพะฟะบะฐ ยซะะพะนัะธยป
   โ
   โโโ ะะพะปั: Email, ะะฐัะพะปั, ะะพะดัะฒะตัะถะดะตะฝะธะต ะฟะฐัะพะปั, ะะผั, ะะพะผะฟะฐะฝะธั
   โ
   โโโ ะะฐะปะธะดะฐัะธั ะฟะฐัะพะปั ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ:
   โ     โโโ โ ะะธะฝะธะผัะผ 8 ัะธะผะฒะพะปะพะฒ
   โ     โโโ โ ะะฐะณะปะฐะฒะฝะฐั ะฑัะบะฒะฐ
   โ     โโโ โ ะกััะพัะฝะฐั ะฑัะบะฒะฐ
   โ     โโโ โ ะฆะธััะฐ
   โ
   โโโ ะะฝะดะธะบะฐัะพั ัะปะพะถะฝะพััะธ: ะกะปะฐะฑัะน โ ะกัะตะดะฝะธะน โ ะฅะพัะพัะธะน โ ะัะปะธัะฝัะน
   โ
   โโโ POST /api/uam/v1/register
   โ     โ ะัะพะฒะตััะตั ัะปะพะถะฝะพััั ะฟะฐัะพะปั (backend)
   โ     โ ะกะพะทะดะฐัั ะฟะพะปัะทะพะฒะฐัะตะปั
   โ     โ ะะฒัะพะผะฐัะธัะตัะบะธ ะฟะพะดะฟะธััะฒะฐะตั ะพะฑัะทะฐัะตะปัะฝัะต ัะพะณะปะฐัะธั
   โ     โ ะกะพะทะดะฐัั ัะตััะธั + Set-Cookie
   โ     โ ะะบะบะฐัะฝั ะทะฐะฟะพะผะธะฝะฐะตััั ะฒ localStorage
   โโโ Redirect ะพะฑัะฐัะฝะพ ะฝะฐ return_url โ ะฒะฐั /dashboard
```

### API: ะัะพะฒะตัะบะฐ email (v1.4.0)

```bash
POST https://auth.markbase.ru/api/uam/v1/check-email
Content-Type: application/json

{
  "email": "user@example.com"
}
```

**ะัะฒะตั (200):**
```json
{
  "exists": true,
  "email": "user@example.com"
}
```

| ะะพะปะต | ะขะธะฟ | ะะฟะธัะฐะฝะธะต |
|------|-----|----------|
| `exists` | boolean | `true` โ ะฐะบะบะฐัะฝั ะฝะฐะนะดะตะฝ, `false` โ ะฝะต ัััะตััะฒัะตั |
| `email` | string | ะะพัะผะฐะปะธะทะพะฒะฐะฝะฝัะน email |

> **ะะฐัะธัะฐ:** Endpoint ะทะฐัะธััะฝ `authRateLimiter` (20 req/min per IP). ะัะธ ะพัะธะฑะบะต ัะตัะฒะตัะฐ ะฒะพะทะฒัะฐัะฐะตั `exists: false` (ะฝะต ัะฐัะบััะฒะฐะตั ะธะฝัะพัะผะฐัะธั).

> **ะัะธะผะตะฝะตะฝะธะต:** ะัะทัะฒะฐะตััั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฝะฐ ััะพะฝัะตะฝะดะต ะฟัะธ ะฒะฒะพะดะต email ะฝะฐ ัััะฐะฝะธัะฐั Login ะธ Register ะดะปั ัะปัััะตะฝะธั UX โ ะฟะพะปัะทะพะฒะฐัะตะปั ััะฐะทั ัะทะฝะฐัั, ะฝัะถะฝะพ ะปะธ ัะตะณะธัััะธัะพะฒะฐัััั ะธะปะธ ะฒัะพะดะธัั.

### API: ะะตะณะธัััะฐัะธั

```bash
POST https://auth.markbase.ru/api/uam/v1/register
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "SecurePass123",
  "display_name": "ะะฒะฐะฝ ะะตััะพะฒ",
  "company_name": "ะะะ ะะพะผะฐัะบะฐ"
}
```

**ะัะฒะตั (200):**
```json
{
  "success": true,
  "user": {
    "user_id": "...",
    "email": "user@example.com",
    "display_name": "ะะฒะฐะฝ ะะตััะพะฒ",
    "role": "user"
  },
  "verification_required": false
}
```

**ะัะธะฑะบะธ:**
| ะะพะด | ะัะธะฑะบะฐ | ะัะธัะธะฝะฐ |
|-----|--------|---------|
| 400 | Email ะธ ะฟะฐัะพะปั ะพะฑัะทะฐัะตะปัะฝั | ะะต ะฟะตัะตะดะฐะฝั ะพะฑัะทะฐัะตะปัะฝัะต ะฟะพะปั |
| 400 | ะะฐัะพะปั ะดะพะปะถะตะฝ ะฑััั ะฝะต ะผะตะฝะตะต 8 ัะธะผะฒะพะปะพะฒ | ะกะปะธัะบะพะผ ะบะพัะพัะบะธะน ะฟะฐัะพะปั |
| 400 | ะะฐัะพะปั ะดะพะปะถะตะฝ ัะพะดะตัะถะฐัั ะทะฐะณะปะฐะฒะฝัะต ะธ ัััะพัะฝัะต ะฑัะบะฒั, ะฐ ัะฐะบะถะต ัะธััั | ะะต ัะพะพัะฒะตัััะฒัะตั ะฟะพะปะธัะธะบะต |
| 409 | ะะบะบะฐัะฝั ั ัะฐะบะธะผ email ัะถะต ัััะตััะฒัะตั (reason: `email_taken`) | Email ัะถะต ะทะฐะฝัั, frontend ะฟัะตะดะปะฐะณะฐะตั ะฒะพะนัะธ |
| 429 | ะกะปะธัะบะพะผ ะผะฝะพะณะพ ะทะฐะฟัะพัะพะฒ | Rate limit ะฟัะตะฒััะตะฝ |

### ะะฐะฟะพะผะธะฝะฐะฝะธะต ะฐะบะบะฐัะฝัะพะฒ

WaySenID ะฐะฒัะพะผะฐัะธัะตัะบะธ ะทะฐะฟะพะผะธะฝะฐะตั ะฐะบะบะฐัะฝัั, ั ะบะพัะพััั ะฟะพะปัะทะพะฒะฐัะตะปั ะฒัะพะดะธะป, ะฒ `localStorage` ะฑัะฐัะทะตัะฐ:

| ะะปัั | ะะฟะธัะฐะฝะธะต |
|------|----------|
| `wsid_last_email` | ะะพัะปะตะดะฝะธะน email ะดะปั ะฑััััะพะณะพ ะฒัะพะดะฐ |
| `wsid_last_name` | Display name ะฟะพัะปะตะดะฝะตะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั |
| `wsid_accounts` | JSON-ะผะฐััะธะฒ ะดะพ 5 ะฟะพัะปะตะดะฝะธั ะฐะบะบะฐัะฝัะพะฒ |

**ะคะพัะผะฐั `wsid_accounts`:**
```json
[
  { "email": "user@example.com", "display_name": "ะะฒะฐะฝ ะะตััะพะฒ", "last_login": "2026-02-08T12:00:00Z" },
  { "email": "admin@company.ru", "display_name": "ะะดะผะธะฝะธัััะฐัะพั", "last_login": "2026-02-07T10:00:00Z" }
]
```

**ะะพะฒะตะดะตะฝะธะต ะฝะฐ ัััะฐะฝะธัะต ะฒัะพะดะฐ (v1.3.0):**
- ะะตัะบะพะปัะบะพ ะฐะบะบะฐัะฝัะพะฒ โ **ะจะฐะณ ยซะัะฑะพั ะฐะบะบะฐัะฝัะฐยป** โ ะบะฐััะพัะบะธ ั ะฐะฒะฐัะฐัะฐะผะธ, ะธะผะตะฝะฐะผะธ ะธ ะทะฐะผะฐัะบะธัะพะฒะฐะฝะฝัะผะธ email
- ะะฝะพะฟะบะฐ ัะดะฐะปะตะฝะธั ะดะปั ะบะฐะถะดะพะณะพ ะฐะบะบะฐัะฝัะฐ (ะบัะตััะธะบ)
- ะะฝะพะฟะบะฐ ยซะะพะนัะธ ะดััะณะธะผ ะฐะบะบะฐัะฝัะพะผยป โ ะฟะตัะตัะพะด ะบ ะฒะฒะพะดั email
- ะะตั ะฐะบะบะฐัะฝัะพะฒ โ ััะฐะทั ัะพัะผะฐ ะฒะฒะพะดะฐ email

**ะัะปะธ ะฒะฐั ะฟัะพะตะบั ะฝะฐ ะดััะณะพะผ ะดะพะผะตะฝะต** (ะฝะต `*.markbase.ru`):
- Cookie `uam_session` ะฝะต ะฑัะดะตั ะดะพัััะฟะฝะฐ ะฐะฒัะพะผะฐัะธัะตัะบะธ
- ะัะฟะพะปัะทัะนัะต API `POST /api/uam/v1/login` ะฝะฐะฟััะผัั
- ะกะพััะฐะฝัะนัะต ัะพะบะตะฝ ะธะท ะพัะฒะตัะฐ ะฒ ัะฒะพะตะน ัะธััะตะผะต
- ะะปะธ ะธัะฟะพะปัะทัะนัะต redirect-flow ัะตัะตะท `return_url`

---

## ะะตัะตะบะปััะตะฝะธะต ะฐะบะบะฐัะฝัะพะฒ (Account Switcher) โ ะกะฟะตัะธัะธะบะฐัะธั ะดะปั ะะกะะฅ ะผะพะดัะปะตะน

> **v1.4.0** โ ะะฐะถะดัะน ะผะพะดัะปั ะฟะปะฐััะพัะผั **ะพะฑัะทะฐะฝ** ัะตะฐะปะธะทะพะฒะฐัั ะฟะตัะตะบะปััะตะฝะธะต ะฐะบะบะฐัะฝัะพะฒ ะฒ ัะฐะฟะบะต.
> ะะพะปัะทะพะฒะฐัะตะปั ะดะพะปะถะตะฝ ะธะผะตัั ะฒะพะทะผะพะถะฝะพััั ะฒ ะปัะฑะพะน ะผะพะผะตะฝั ะฟะตัะตะบะปััะธัััั ะฝะฐ ะดััะณะพะน ะฐะบะบะฐัะฝั ะธะปะธ ะดะพะฑะฐะฒะธัั ะฝะพะฒัะน.

### ะะฐะบ ััะพ ะฒัะณะปัะดะธั

ะัะธ ะฝะฐะถะฐัะธะธ ะฝะฐ ะฐะฒะฐัะฐั/ะฟัะพัะธะปั ะฒ ะฟัะฐะฒะพะผ ะฒะตััะฝะตะผ ัะณะปั ัะฐะฟะบะธ **ะปัะฑะพะณะพ** ะผะพะดัะปั ะพัะพะฑัะฐะถะฐะตััั dropdown:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  [ะะฒะฐัะฐั] ะะฒะฐะฝ ะะตััะพะฒ        โ      โ  โ ะขะตะบััะธะน ะฐะบะบะฐัะฝั (ะฐะบัะธะฒะฝัะน)
โ           ivan@example.com           โ
โ           ะะดะผะธะฝะธัััะฐัะพั              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โ ะะะะะะะฎะงะะขะฌ ะะะะะฃะะข              โ  โ ะะฐะณะพะปะพะฒะพะบ (ะตัะปะธ ะตััั ะดััะณะธะต)
โ                                      โ
โ  [ะะฒะฐัะฐั] ะะฐัะธั ะกะผะธัะฝะพะฒะฐ     โ      โ  โ ะััะณะพะน ัะพััะฐะฝัะฝะฝัะน ะฐะบะบะฐัะฝั
โ           ma***@company.ru           โ
โ                                      โ
โ  [ะะฒะฐัะฐั] Admin              โ      โ  โ ะัั ะพะดะธะฝ ัะพััะฐะฝัะฝะฝัะน
โ           su***@markbase.ru          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ๏ผ ะะพะฑะฐะฒะธัั ะฐะบะบะฐัะฝั                 โ  โ ะะพะนัะธ ะฝะพะฒัะผ ะฐะบะบะฐัะฝัะพะผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ๐ค ะฃะฟัะฐะฒะปะตะฝะธะต ะฐะบะบะฐัะฝัะพะผ             โ  โ ะะตัะตัะพะด ะฝะฐ auth.markbase.ru
โ  ๐ ะะตะทะพะฟะฐัะฝะพััั                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ๐ช ะัะนัะธ                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะพะณะธะบะฐ ะฟะตัะตะบะปััะตะฝะธั ะฐะบะบะฐัะฝัะพะฒ (ะพะฑัะทะฐัะตะปัะฝะฐ ะดะปั ะฒัะตั ะผะพะดัะปะตะน)

ะะตัะตะบะปััะตะฝะธะต ะดะพะปะถะฝะพ **ะฝะต ะทะฐะฟัะฐัะธะฒะฐัั ะฟะฐัะพะปั**, ะตัะปะธ ัะตะปะตะฒะพะน ะฐะบะบะฐัะฝั ะฝะตะดะฐะฒะฝะพ ะฒัะพะดะธะป ั ััะพะณะพ ััััะพะนััะฒะฐ ะธ ั ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะต ะฒะบะปััะตะฝะฐ ะฝะฐัััะพะนะบะฐ ยซะัะตะณะดะฐ ะทะฐะฟัะฐัะธะฒะฐัั ะฟะฐัะพะปัยป. ะะฝะฐัะต โ ะฟะตัะตัะพะด ะฝะฐ ัััะฐะฝะธัั ะฒะฒะพะดะฐ ะฟะฐัะพะปั.

```
ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั ะฝะฐ ะดััะณะพะน ะฐะบะบะฐัะฝั ะฒ dropdown
    โ
    โโโ 1. ะะทััั ะธะท localStorage (wsid_accounts) ะทะฐะฟะธัั ัะตะปะตะฒะพะณะพ ะฐะบะบะฐัะฝัะฐ:
    โ      email, switch_token, require_password_on_switch, switch_inactivity_days, last_login
    โ
    โโโ 2. ะะตัะธัั: ะฝัะถะตะฝ ะปะธ ะฟะฐัะพะปั?
    โ      โข require_password_on_switch === 'always' โ ะะ
    โ      โข ะฝะตั switch_token โ ะะ
    โ      โข (ัะตะนัะฐั โ last_login) > switch_inactivity_days (ะฟะพ ัะผะพะปัะฐะฝะธั 180 ะดะฝะตะน) โ ะะ
    โ      โข ะธะฝะฐัะต โ ะฟะฐัะพะปั ะะ ะทะฐะฟัะฐัะธะฒะฐัั
    โ
    โโโ 3a. ะัะปะธ ะฟะฐัะพะปั ะะ ะฝัะถะตะฝ:
    โ      POST /api/uam/v1/switch-with-token
    โ      Body: { email, switch_token }
    โ      Credentials: include (cookie)
    โ      โ 200: Set-Cookie ะฝะพะฒะฐั ัะตััะธั โ redirect ะฝะฐ return_url (ะธะปะธ /account)
    โ      โ 403 / ะพัะธะฑะบะฐ: fallback ะฝะฐ 3b
    โ
    โโโ 3b. ะัะปะธ ะฟะฐัะพะปั ะฝัะถะตะฝ (ะธะปะธ 3a ะฒะตัะฝัะป ะพัะธะฑะบั):
           POST /api/uam/v1/logout (ะทะฐะฒะตััะฐะตะผ ัะตะบัััั ัะตััะธั)
           Redirect: auth.markbase.ru/login?switch=email@example.com
                     [&return_url=https://billing.markbase.ru/dashboard]
           ะะฐ ัััะฐะฝะธัะต ะฒัะพะดะฐ: ัะฐะณ ยซะะฒะพะด ะฟะฐัะพะปัยป โ POST /login โ Set-Cookie โ redirect ะฝะฐ return_url
```

### ะะตะทะพะฟะฐัะฝะพััั ะฟะตัะตะบะปััะตะฝะธั ะฑะตะท ะฟะฐัะพะปั

- **Switch token** ะฒัะดะฐัััั ัะพะปัะบะพ ะฟัะธ ััะฟะตัะฝะพะผ ะฒัะพะดะต ะฟะพ ะฟะฐัะพะปั (POST /login). ะฅัะฐะฝะธััั ะฒ `wsid_accounts` ะธ ะฝะฐ ัะตัะฒะตัะต (ัะฐะฑะปะธัะฐ `switch_tokens`), ััะพะบ ะถะธะทะฝะธ ะฟะพ ัะผะพะปัะฐะฝะธั 30 ะดะฝะตะน (ะฟะตัะตะผะตะฝะฝะฐั `UAM_SWITCH_TOKEN_TTL_DAYS`).
- **ะะฐัััะพะนะบะธ ะทะฐะดะฐัั ะฒะปะฐะดะตะปะตั ะฐะบะบะฐัะฝัะฐ** ะฒ ัะฐะทะดะตะปะต ยซะะตะทะพะฟะฐัะฝะพัััยป (auth.markbase.ru):
  - **ยซะัะตะณะดะฐ ะทะฐะฟัะฐัะธะฒะฐัั ะฟะฐัะพะปัยป** โ ะฟัะธ ะปัะฑะพะผ ะฟะตัะตะบะปััะตะฝะธะธ ะฝะฐ ััะพั ะฐะบะบะฐัะฝั ะฒัะตะณะดะฐ ะฟะพะบะฐะทัะฒะฐะตััั ะฒะฒะพะด ะฟะฐัะพะปั; ะฝะธะบัะพ ะฝะต ัะผะพะถะตั ะฒะพะนัะธ ั ะฒะฐัะตะณะพ ััััะพะนััะฒะฐ ะฑะตะท ะฟะฐัะพะปั.
  - **ยซะขะพะปัะบะพ ะฟะพัะปะต ะดะพะปะณะพะณะพ ะฝะตะฒัะพะดะฐยป** (ัะตะบะพะผะตะฝะดัะตััั) โ ะฟะตัะตะบะปััะตะฝะธะต ะฑะตะท ะฟะฐัะพะปั ัะฐะทัะตัะตะฝะพ, ะตัะปะธ ั ะฟะพัะปะตะดะฝะตะณะพ ะฒัะพะดะฐ ะฒ ััะพั ะฐะบะบะฐัะฝั ั ััะพะณะพ ััััะพะนััะฒะฐ ะฟัะพัะปะพ ะผะตะฝััะต N ะดะฝะตะน (ะฟะพ ัะผะพะปัะฐะฝะธั 180).
- **ะกัะพัะพะฝะฝะธะต ะผะพะดัะปะธ ะพะฑัะทะฐะฝั** ะธัะฟะพะปัะทะพะฒะฐัั ะพะดะฝั ะธ ัั ะถะต ะปะพะณะธะบั: ะฟัะพะฒะตัััั `require_password_on_switch`, `last_login` ะธ `switch_inactivity_days` ะธะท `wsid_accounts`, ะฟัะธ ะฒะพะทะผะพะถะฝะพััะธ ะฒัะทัะฒะฐัั `POST /switch-with-token`, ะธะฝะฐัะต โ ัะตะดะธัะตะบั ะฝะฐ `login?switch=email&return_url=...`. ะะต ัะตะฐะปะธะทะพะฒัะฒะฐัั ยซะฒัะตะณะดะฐ ัะตะดะธัะตะบั ะฝะฐ ะฟะฐัะพะปัยป โ ััะพ ัััะดัะฐะตั UX ะธ ะฝะต ัะพะพัะฒะตัััะฒัะตั ะฟะพะปะธัะธะบะต ะฑะตะทะพะฟะฐัะฝะพััะธ UAM.

### ะะพะณะธะบะฐ ะดะพะฑะฐะฒะปะตะฝะธั ะฝะพะฒะพะณะพ ะฐะบะบะฐัะฝัะฐ

```
ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั ยซะะพะฑะฐะฒะธัั ะฐะบะบะฐัะฝัยป
    โ
    โโโ 1. POST /api/uam/v1/logout (ะทะฐะฒะตััะฐะตะผ ัะตะบัััั ัะตััะธั)
    โ
    โโโ 2. Redirect:
    โ      auth.markbase.ru/login?new_account=1
    โ      [&return_url=https://billing.markbase.ru/dashboard]
    โ
    โโโ 3. ะกััะฐะฝะธัะฐ ะฒัะพะดะฐ (Login.js):
           โโโ ะะฐัะฐะผะตัั ?new_account=1 โ ััะฐะทั ะฟะพะบะฐะทะฐัั ัะฐะณ ยซะะฒะพะด emailยป
           โ   (ะฟัะพะฟััะบะฐะตะผ ัะฐะณ ยซะัะฑะพั ะฐะบะบะฐัะฝัะฐยป)
           โโโ ะะพะปัะทะพะฒะฐัะตะปั ะฒะฒะพะดะธั email ะฝะพะฒะพะณะพ ะฐะบะบะฐัะฝัะฐ
           โโโ POST /check-email โ ะฟัะพะฒะตัะบะฐ
           โโโ ะะฒะพะด ะฟะฐัะพะปั โ POST /login โ Set-Cookie
           โโโ ะะพะฒัะน ะฐะบะบะฐัะฝั ะทะฐะฟะพะผะธะฝะฐะตััั ะฒ wsid_accounts
           โโโ Redirect ะพะฑัะฐัะฝะพ ะฝะฐ return_url โ ะผะพะดัะปั
```

### URL-ะฟะฐัะฐะผะตััั ัััะฐะฝะธัั ะฒัะพะดะฐ (Login)

| ะะฐัะฐะผะตัั | ะะฟะธัะฐะฝะธะต | ะัะธะผะตั |
|----------|----------|--------|
| `return_url` | ะัะดะฐ ะฒะตัะฝััั ะฟะพัะปะต ััะฟะตัะฝะพะณะพ ะฒัะพะดะฐ | `?return_url=https://billing.markbase.ru/dashboard` |
| `switch` | Email ะฐะบะบะฐัะฝัะฐ ะดะปั ะฑััััะพะณะพ ะฟะตัะตะบะปััะตะฝะธั โ ััะฐะทั ะฟะพะบะฐะทัะฒะฐะตั ะฒะฒะพะด ะฟะฐัะพะปั | `?switch=admin@markbase.ru` |
| `new_account` | ะัะธะฝัะดะธัะตะปัะฝะพ ะฟะพะบะฐะทะฐัั ะฒะฒะพะด email (ะดะปั ะดะพะฑะฐะฒะปะตะฝะธั ะฝะพะฒะพะณะพ ะฐะบะบะฐัะฝัะฐ) | `?new_account=1` |
| `email` | ะัะตะดะทะฐะฟะพะปะฝะธัั email (ะดะปั ะฟะตัะตัะพะดะฐ ะธะท ัะตะณะธัััะฐัะธะธ) | `?email=user@example.com` |

### localStorage: ะฅัะฐะฝะตะฝะธะต ะฐะบะบะฐัะฝัะพะฒ

ะัะต ะผะพะดัะปะธ **ัะฐะทะดะตะปััั ะพะดะธะฝ ะธ ัะพั ะถะต localStorage** ะฝะฐ ะดะพะผะตะฝะต `*.markbase.ru`.
ะะปััะธ ััะฐะฝะดะฐััะธะทะธัะพะฒะฐะฝั โ **ะฝะต ะธะทะผะตะฝัะนัะต ะธะผะตะฝะฐ ะบะปััะตะน!**

| ะะปัั | ะขะธะฟ | ะะฟะธัะฐะฝะธะต |
|------|-----|----------|
| `wsid_accounts` | `JSON Array` | ะะฐััะธะฒ ะดะพ 5 ัะพััะฐะฝัะฝะฝัั ะฐะบะบะฐัะฝัะพะฒ |
| `wsid_last_email` | `string` | Email ะฟะพัะปะตะดะฝะตะณะพ ะฒัะพะดะฐ |
| `wsid_last_name` | `string` | Display name ะฟะพัะปะตะดะฝะตะณะพ ะฒัะพะดะฐ |

**ะคะพัะผะฐั `wsid_accounts`:**
```json
[
  {
    "email": "ivan@example.com",
    "display_name": "ะะฒะฐะฝ ะะตััะพะฒ",
    "last_login": "2026-02-09T12:00:00.000Z",
    "switch_token": "hex-ัะพะบะตะฝ ะพั UAM (ะฒัะดะฐัััั ะฟัะธ ะฒัะพะดะต ะฟะพ ะฟะฐัะพะปั)",
    "require_password_on_switch": "always | after_inactivity",
    "switch_inactivity_days": 180
  },
  {
    "email": "admin@markbase.ru",
    "display_name": "System Administrator",
    "last_login": "2026-02-09T10:34:00.000Z",
    "switch_token": "...",
    "require_password_on_switch": "after_inactivity",
    "switch_inactivity_days": 180
  }
]
```

ะะพะปั `switch_token`, `require_password_on_switch`, `switch_inactivity_days` ะฟัะธัะพะดัั ะฒ ะพัะฒะตัะต POST /login ะธ ัะพััะฐะฝััััั ะฟัะธ ะฒัะทะพะฒะต `rememberAccount(email, displayName, options)`. ะะฝะธ ะฝัะถะฝั ะดะปั ะฟะตัะตะบะปััะตะฝะธั ะฑะตะท ะฟะฐัะพะปั ะฒ ัะฐะผะบะฐั ะฟัะฐะฒะธะป ะฑะตะทะพะฟะฐัะฝะพััะธ.

**ะัะฐะฒะธะปะฐ:**
- ะะฐะบัะธะผัะผ 5 ะฐะบะบะฐัะฝัะพะฒ (FIFO โ ะฝะพะฒัะต ะฒััะตัะฝััั ััะฐััะต)
- ะัะธ ััะฟะตัะฝะพะผ ะฒัะพะดะต ะฐะบะบะฐัะฝั **ะดะพะฑะฐะฒะปัะตััั** ะฒ ะฝะฐัะฐะปะพ ะผะฐััะธะฒะฐ ั ัะพะบะตะฝะพะผ ะธ ะฝะฐัััะพะนะบะฐะผะธ ะธะท ะพัะฒะตัะฐ /login
- ะัะธ ัะดะฐะปะตะฝะธะธ ะฐะบะบะฐัะฝัะฐ โ ะพะฝ ัะดะฐะปัะตััั ะธะท ะผะฐััะธะฒะฐ
- ะัะต ะพะฟะตัะฐัะธะธ ัะตัะตะท `safeGet`/`safeSet` (try-catch ะดะปั Safari private mode)

### Helper-ััะฝะบัะธะธ ะดะปั ัะฐะฑะพัั ั ะฐะบะบะฐัะฝัะฐะผะธ (JavaScript)

```javascript
/* โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
 * WaySenID Account Helpers
 * ะัะฟะพะปัะทัะนัะต ะฒ ะะฎะะะ ะผะพะดัะปะต ะดะปั ัะฐะฑะพัั ั ัะพััะฐะฝัะฝะฝัะผะธ ะฐะบะบะฐัะฝัะฐะผะธ.
 * ะญัะธ ััะฝะบัะธะธ ัะพะฒะผะตััะธะผั ั Login.js ะธ Layout.js auth.markbase.ru.
 * โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ */

const ACCOUNTS_KEY = 'wsid_accounts';
const LAST_EMAIL_KEY = 'wsid_last_email';
const LAST_NAME_KEY = 'wsid_last_name';

// ะะตะทะพะฟะฐัะฝัะน ะดะพัััะฟ ะบ localStorage (Safari private mode)
const safeGet = (key) => { try { return localStorage.getItem(key); } catch (_) { return null; } };
const safeSet = (key, value) => { try { localStorage.setItem(key, value); } catch (_) {} };

// ะะพะปััะธัั ัะฟะธัะพะบ ัะพััะฐะฝัะฝะฝัั ะฐะบะบะฐัะฝัะพะฒ
function getSavedAccounts() {
  try {
    const raw = safeGet(ACCOUNTS_KEY);
    const arr = JSON.parse(raw || '[]');
    return Array.isArray(arr) ? arr : [];
  } catch (_) { return []; }
}

// ะะฐะฟะพะผะฝะธัั ะฐะบะบะฐัะฝั ะฟะพัะปะต ััะฟะตัะฝะพะณะพ ะฒัะพะดะฐ ะฟะพ ะฟะฐัะพะปั.
// options: { switch_token, require_password_on_switch, switch_inactivity_days } โ ะธะท ะพัะฒะตัะฐ POST /login
function rememberAccount(email, displayName, options = {}) {
  const normalized = (email || '').trim().toLowerCase();
  if (!normalized) return;
  safeSet(LAST_EMAIL_KEY, normalized);
  if (displayName) safeSet(LAST_NAME_KEY, displayName);
  let accounts = getSavedAccounts();
  accounts = accounts.filter(a => a.email !== normalized);
  const entry = {
    email: normalized,
    display_name: displayName || normalized,
    last_login: new Date().toISOString()
  };
  if (options.switch_token) entry.switch_token = options.switch_token;
  if (options.require_password_on_switch) entry.require_password_on_switch = options.require_password_on_switch;
  if (options.switch_inactivity_days != null) entry.switch_inactivity_days = options.switch_inactivity_days;
  accounts.unshift(entry);
  accounts = accounts.slice(0, 5); // ะะฐะบัะธะผัะผ 5
  safeSet(ACCOUNTS_KEY, JSON.stringify(accounts));
}

// ะฃะดะฐะปะธัั ะฐะบะบะฐัะฝั ะธะท ัะฟะธัะบะฐ
function forgetAccount(email) {
  let accounts = getSavedAccounts();
  accounts = accounts.filter(a => a.email !== email);
  safeSet(ACCOUNTS_KEY, JSON.stringify(accounts));
  return accounts;
}

// ะะฐัะบะธัะพะฒะฐัั email (ะดะปั ะพัะพะฑัะฐะถะตะฝะธั)
function maskEmail(email) {
  if (!email || !email.includes('@')) return email;
  const [local, domain] = email.split('@');
  const masked = local.length <= 2 ? local[0] + '***' : local.slice(0, 2) + '***';
  return masked + '@' + domain;
}

// ะฆะฒะตัะฐ ะฐะฒะฐัะฐัะพะฒ (ััะฐะฑะธะปัะฝัะต ะฟะพ email)
const AVATAR_COLORS = ['#FC3F1D', '#5B45FF', '#00A884', '#FF6F00', '#0077FF', '#E91E63', '#9C27B0', '#00BCD4'];
function getAvatarColor(str) {
  let hash = 0;
  for (let i = 0; i < (str || '').length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
  return AVATAR_COLORS[Math.abs(hash) % AVATAR_COLORS.length];
}

// ะะฝะธัะธะฐะปั ะดะปั ะฐะฒะฐัะฐัะฐ
function getInitials(name, email) {
  if (name && name !== email) {
    const parts = name.trim().split(/\s+/);
    if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
    return name[0].toUpperCase();
  }
  return (email || '?')[0].toUpperCase();
}
```

### ะะพัะพะฒัะน React-ะบะพะผะฟะพะฝะตะฝั: AccountSwitcher ะดะปั ะปัะฑะพะณะพ ะผะพะดัะปั

> ะกะบะพะฟะธััะนัะต ััะพั ะบะพะผะฟะพะฝะตะฝั ะฒ ัะฐะฟะบั ะฒะฐัะตะณะพ ะผะพะดัะปั. ะะฝ ะฐะฒัะพะผะฐัะธัะตัะบะธ:
> - ะฟะพะบะฐะทัะฒะฐะตั ัะตะบััะตะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั
> - ะฟะพะบะฐะทัะฒะฐะตั ะดััะณะธะต ัะพััะฐะฝัะฝะฝัะต ะฐะบะบะฐัะฝัั
> - ะฟะพะทะฒะพะปัะตั ะฟะตัะตะบะปััะฐัััั ะธ ะดะพะฑะฐะฒะปััั ะฝะพะฒัะต

```javascript
import React, { useState, useEffect } from 'react';
import { Avatar, Dropdown } from 'antd';
// ะะผะฟะพััะธััะนัะต helper-ััะฝะบัะธะธ ะฒััะต ะธะปะธ ัะบะพะฟะธััะนัะต ะธั

const UAM_URL = 'https://auth.markbase.ru';

/**
 * AccountSwitcher โ dropdown ะดะปั ะฟะตัะตะบะปััะตะฝะธั ะฐะบะบะฐัะฝัะพะฒ ะฒ ัะฐะฟะบะต ะผะพะดัะปั.
 *
 * @param {Object} props
 * @param {Object} props.user - ะขะตะบััะธะน ะฟะพะปัะทะพะฒะฐัะตะปั { email, display_name, role }
 * @param {Function} props.onLogout - Callback ะฟัะธ ะฒััะพะดะต (optional)
 * @param {string} props.returnUrl - URL ะดะปั ะฒะพะทะฒัะฐัะฐ ะฟะพัะปะต ะฟะตัะตะบะปััะตะฝะธั (optional)
 */
function AccountSwitcher({ user, onLogout, returnUrl }) {
  const [accounts, setAccounts] = useState([]);

  useEffect(() => {
    setAccounts(getSavedAccounts());
  }, []);

  const currentReturnUrl = returnUrl || window.location.href;
  const otherAccounts = accounts.filter(a => a.email !== user?.email);

  // ะะตัะตะบะปััะตะฝะธะต: ะตัะปะธ ัะฐะทัะตัะตะฝะพ ะฝะฐัััะพะนะบะฐะผะธ ะธ ะตััั ัะพะบะตะฝ โ POST /switch-with-token, ะธะฝะฐัะต โ logout + redirect ะฝะฐ ะฒะฒะพะด ะฟะฐัะพะปั
  const handleSwitch = async (email) => {
    const acc = accounts.find(a => a.email === email);
    const inactivityDays = (acc?.switch_inactivity_days != null ? acc.switch_inactivity_days : 180);
    const requirePassword = acc?.require_password_on_switch || 'after_inactivity';
    const lastLogin = acc?.last_login ? new Date(acc.last_login).getTime() : 0;
    const inactivityMs = inactivityDays * 24 * 60 * 60 * 1000;
    const needPassword = requirePassword === 'always' ||
      !acc?.switch_token ||
      (Date.now() - lastLogin > inactivityMs);

    if (needPassword) {
      try {
        await fetch(`${UAM_URL}/api/uam/v1/logout`, { method: 'POST', credentials: 'include' });
      } catch (_) {}
      window.location.href = `${UAM_URL}/login?switch=${encodeURIComponent(email)}&return_url=${encodeURIComponent(currentReturnUrl)}`;
      return;
    }
    try {
      const res = await fetch(`${UAM_URL}/api/uam/v1/switch-with-token`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, switch_token: acc.switch_token })
      });
      const data = await res.json().catch(() => ({}));
      if (res.ok && data.success) {
        window.location.href = currentReturnUrl;
        return;
      }
    } catch (_) {}
    window.location.href = `${UAM_URL}/login?switch=${encodeURIComponent(email)}&return_url=${encodeURIComponent(currentReturnUrl)}`;
  };

  // ะะพะฑะฐะฒะธัั ะฝะพะฒัะน: logout โ redirect ะฝะฐ login ั new_account
  const handleAddAccount = async () => {
    try {
      await fetch(`${UAM_URL}/api/uam/v1/logout`, {
        method: 'POST',
        credentials: 'include'
      });
    } catch (_) {}
    window.location.href = `${UAM_URL}/login?new_account=1&return_url=${encodeURIComponent(currentReturnUrl)}`;
  };

  // ะฃะดะฐะปะธัั ะฐะบะบะฐัะฝั ะธะท ัะพััะฐะฝัะฝะฝัั
  const handleRemove = (email) => {
    const updated = forgetAccount(email);
    setAccounts(updated);
  };

  // ะััะพะด
  const handleLogout = async () => {
    try {
      await fetch(`${UAM_URL}/api/uam/v1/logout`, {
        method: 'POST',
        credentials: 'include'
      });
    } catch (_) {}
    if (onLogout) onLogout();
    else window.location.href = `${UAM_URL}/login?return_url=${encodeURIComponent(currentReturnUrl)}`;
  };

  const color = getAvatarColor(user?.email);
  const initials = getInitials(user?.display_name, user?.email);

  const items = [
    // ะขะตะบััะธะน ะฐะบะบะฐัะฝั
    {
      key: 'current',
      label: (
        <div style={{ padding: '8px 0', minWidth: 260 }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
            <Avatar size={40} style={{ background: color, fontWeight: 600 }}>{initials}</Avatar>
            <div>
              <div style={{ fontWeight: 600, fontSize: 14 }}>
                {user?.display_name || 'ะะพะปัะทะพะฒะฐัะตะปั'} โ
              </div>
              <div style={{ fontSize: 12, color: '#999' }}>{user?.email}</div>
            </div>
          </div>
        </div>
      ),
      disabled: true,
    },
    { type: 'divider' },

    // ะััะณะธะต ะฐะบะบะฐัะฝัั
    ...(otherAccounts.length > 0 ? [
      { key: 'switch-header', label: 'โ ะะตัะตะบะปััะธัั ะฐะบะบะฐัะฝั', disabled: true },
      ...otherAccounts.map(acc => ({
        key: `switch-${acc.email}`,
        label: (
          <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
            <Avatar size={28} style={{ background: getAvatarColor(acc.email), fontWeight: 600, fontSize: 11 }}>
              {getInitials(acc.display_name, acc.email)}
            </Avatar>
            <div style={{ flex: 1 }}>
              <div style={{ fontSize: 13, fontWeight: 500 }}>{acc.display_name || acc.email}</div>
              <div style={{ fontSize: 11, color: '#999' }}>{maskEmail(acc.email)}</div>
            </div>
          </div>
        ),
        onClick: () => handleSwitch(acc.email),
      })),
      { type: 'divider' },
    ] : []),

    // ะะพะฑะฐะฒะธัั ะฐะบะบะฐัะฝั
    { key: 'add', label: '๏ผ ะะพะฑะฐะฒะธัั ะฐะบะบะฐัะฝั', onClick: handleAddAccount },
    { type: 'divider' },

    // ะฃะฟัะฐะฒะปะตะฝะธะต
    {
      key: 'manage',
      label: '๐ค ะฃะฟัะฐะฒะปะตะฝะธะต ะฐะบะบะฐัะฝัะพะผ',
      onClick: () => { window.location.href = `${UAM_URL}/account`; },
    },
    { type: 'divider' },

    // ะััะพะด
    { key: 'logout', label: '๐ช ะัะนัะธ', danger: true, onClick: handleLogout },
  ];

  return (
    <Dropdown menu={{ items }} placement="bottomRight" trigger={['click']}>
      <div style={{ cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 8 }}>
        <Avatar size={32} style={{ background: color, fontWeight: 600, fontSize: 13 }}>
          {initials}
        </Avatar>
        <span style={{ fontSize: 13, fontWeight: 500 }}>
          {user?.display_name || user?.email}
        </span>
      </div>
    </Dropdown>
  );
}
```

**ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะฒ ะปัะฑะพะผ ะผะพะดัะปะต (React):**
```javascript
// ะ ัะฐะฟะบะต ะฒะฐัะตะณะพ ะผะพะดัะปั:
<AccountSwitcher
  user={currentUser}                       // { email, display_name, role }
  returnUrl="https://billing.markbase.ru"  // ะัะดะฐ ะฒะตัะฝััั ะฟะพัะปะต ะฟะตัะตะบะปััะตะฝะธั
  onLogout={() => { setUser(null); }}      // Callback ะฟัะธ ะฒััะพะดะต (optional)
/>
```

### ะะปั ะะ-React ะผะพะดัะปะตะน (Redirect-ะฟะพะดัะพะด)

ะัะปะธ ะผะพะดัะปั ะฝะต ะฝะฐ React, ะฝะพ ะฟะพะดะดะตัะถะธะฒะฐะตั JavaScript:
- ะะตะฐะปะธะทัะนัะต ัั ะถะต ะปะพะณะธะบั ะฟะตัะตะบะปััะตะฝะธั: ะฟัะพัะธัะฐะนัะต `wsid_accounts`, ะฟัะธ ะฒะพะทะผะพะถะฝะพััะธ ะฒัะทะพะฒะธัะต `POST /switch-with-token` ั `credentials: 'include'`, ะฟัะธ ััะฟะตัะต โ redirect ะฝะฐ return_url, ะธะฝะฐัะต โ redirect ะฝะฐ `login?switch=email&return_url=...`. ะขะฐะบ ะฟะตัะตะบะปััะตะฝะธะต ะฑัะดะตั ะฑะตะท ะทะฐะฟัะพัะฐ ะฟะฐัะพะปั ัะฐะผ, ะณะดะต ััะพ ัะฐะทัะตัะตะฝะพ ะฝะฐัััะพะนะบะฐะผะธ.

ะัะปะธ ะธัะฟะพะปัะทัะตัะต ัะพะปัะบะพ ัััะปะบะธ (ะฑะตะท ะฟัะพะฒะตัะบะธ ัะพะบะตะฝะฐ):

```html
<!-- ะะตัะตะบะปััะธัั ะฝะฐ ะบะพะฝะบัะตัะฝัะน ะฐะบะบะฐัะฝั (ะฒัะตะณะดะฐ ะฟัะธะฒะตะดัั ะบ ะฒะฒะพะดั ะฟะฐัะพะปั ะฝะฐ ัััะฐะฝะธัะต ะปะพะณะธะฝะฐ) -->
<a href="https://auth.markbase.ru/login?switch=other@email.com&return_url=https://billing.markbase.ru/dashboard">
  ะะตัะตะบะปััะธัั ะฝะฐ other@email.com
</a>

<!-- ะะพะฑะฐะฒะธัั ะฝะพะฒัะน ะฐะบะบะฐัะฝั -->
<a href="https://auth.markbase.ru/login?new_account=1&return_url=https://billing.markbase.ru/dashboard">
  ะะพะฑะฐะฒะธัั ะฐะบะบะฐัะฝั
</a>

<!-- ะััะพะด ั redirect ะพะฑัะฐัะฝะพ -->
<a href="https://auth.markbase.ru/api/uam/v1/logout?return_url=https://billing.markbase.ru">
  ะัะนัะธ
</a>
```

### ะญะบัะฐะฝ ะฒัะฑะพัะฐ ะฐะบะบะฐัะฝัะฐ (Account Picker ะฝะฐ Login)

ะะพะณะดะฐ ะฟะพะปัะทะพะฒะฐัะตะปั ะฟะพะฟะฐะดะฐะตั ะฝะฐ `auth.markbase.ru/login` ะธ ะฒ `wsid_accounts` ะตััั ัะพััะฐะฝัะฝะฝัะต ะฐะบะบะฐัะฝัั, ะพัะพะฑัะฐะถะฐะตััั **Account Picker** (ะบะฐะบ ะฝะฐ ัะบัะธะฝัะพัะต):

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           [๐ถ WaySenID Logo]             โ
โ              WaySenID                    โ
โ          ะัะฑะตัะธัะต ะฐะบะบะฐัะฝั                โ
โ                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ [SA] System Administrator      ๐  โ  โ  โ ะะฐััะพัะบะฐ ะฐะบะบะฐัะฝัะฐ
โ  โ      su***@markbase.ru             โ  โ     (ะบะปะธะบ โ ะฒะฒะพะด ะฟะฐัะพะปั)
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ [ะะ] ะะฒะฐะฝ ะะตััะพะฒ              ๐  โ  โ  โ ะัั ะพะดะธะฝ ะฐะบะบะฐัะฝั
โ  โ      iv***@example.com             โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                          โ
โ            โโโโ ะธะปะธ โโโโ                 โ
โ                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  ๐ค ะะพะนัะธ ะดััะณะธะผ ะฐะบะบะฐัะฝัะพะผ         โ  โ  โ ะะฒะพะด ะฝะพะฒะพะณะพ email
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                          โ
โ    ะะตั ะฐะบะบะฐัะฝัะฐ? ะะฐัะตะณะธัััะธัะพะฒะฐัััั      โ
โ                                          โ
โ  โ 7/7 ะผะพะดัะปะตะน ะทะฐัะธัั ะฐะบัะธะฒะฝั           โ
โ  ๐ HTTPS  ๐ก Anti-Bruteforce  โก Anti-DDoS โ
โ                                          โ
โ     WaySenID v1.4 ยท MarkBase ยท 2026     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ะญะปะตะผะตะฝัั ะบะฐััะพัะบะธ ะฐะบะบะฐัะฝัะฐ:**
- **ะฆะฒะตัะฝะพะน ะฐะฒะฐัะฐั** โ ััะฐะฑะธะปัะฝัะน ัะฒะตั ะฟะพ hash ะพั email (8 ัะฒะตัะพะฒ)
- **ะะฝะธัะธะฐะปั** โ ะฟะตัะฒัะต ะฑัะบะฒั display_name ะธะปะธ ะฟะตัะฒะฐั ะฑัะบะฒะฐ email
- **ะะผั** โ display_name ะธะปะธ email ัะตะปะธะบะพะผ
- **ะะฐะผะฐัะบะธัะพะฒะฐะฝะฝัะน email** โ `su***@markbase.ru` (ะฟะตัะฒัะต 2 ัะธะผะฒะพะปะฐ + `***`)
- **ะะฝะพะฟะบะฐ ัะดะฐะปะตะฝะธั** โ ะธะบะพะฝะบะฐ ะบะพัะทะธะฝั, ัะดะฐะปัะตั ะฐะบะบะฐัะฝั ะธะท localStorage

**ะะพะฒะตะดะตะฝะธะต:**
1. ะะปะธะบ ะฝะฐ ะบะฐััะพัะบั โ ะฟะตัะตัะพะด ะบ ะฒะฒะพะดั ะฟะฐัะพะปั (ะจะฐะณ 3)
2. ะะปะธะบ ะฝะฐ ยซะะพะนัะธ ะดััะณะธะผ ะฐะบะบะฐัะฝัะพะผยป โ ะฟะตัะตัะพะด ะบ ะฒะฒะพะดั email (ะจะฐะณ 2)
3. ะะปะธะบ ะฝะฐ ๐ โ ัะดะฐะปะตะฝะธะต ะฐะบะบะฐัะฝัะฐ ะธะท `wsid_accounts`, ะตัะปะธ ะฐะบะบะฐัะฝัะพะฒ ะฝะต ะพััะฐะปะพัั โ ะฐะฒัะพะผะฐัะธัะตัะบะธะน ะฟะตัะตัะพะด ะบ ะฒะฒะพะดั email
4. ะัะธ `?switch=email` โ ัะฐะณ ะฒัะฑะพัะฐ ะฟัะพะฟััะบะฐะตััั, ััะฐะทั ะฒะฒะพะด ะฟะฐัะพะปั ะดะปั ัะบะฐะทะฐะฝะฝะพะณะพ email
5. ะัะธ `?new_account=1` โ ัะฐะณ ะฒัะฑะพัะฐ ะฟัะพะฟััะบะฐะตััั, ััะฐะทั ะฒะฒะพะด ะฝะพะฒะพะณะพ email

### ะงะตะบ-ะปะธัั ะดะปั ะผะพะดัะปะตะน: ะะฝัะตะณัะฐัะธั Account Switcher

ะะฐะถะดัะน ะผะพะดัะปั ะฟะปะฐััะพัะผั **ะดะพะปะถะตะฝ** ัะตะฐะปะธะทะพะฒะฐัั:

- [ ] **Dropdown ะฒ ัะฐะฟะบะต** ะฟัะธ ะบะปะธะบะต ะฝะฐ ะฐะฒะฐัะฐั/ะฟัะพัะธะปั ะฟะพะปัะทะพะฒะฐัะตะปั
- [ ] **ะขะตะบััะธะน ะฐะบะบะฐัะฝั** โ ะพัะพะฑัะฐะถะตะฝะธะต ะธะผะตะฝะธ, email, ัะพะปะธ
- [ ] **ะกะฟะธัะพะบ ะดััะณะธั ะฐะบะบะฐัะฝัะพะฒ** ะธะท `localStorage` ะบะปััะฐ `wsid_accounts` (ั ะฟะพะปัะผะธ `switch_token`, `require_password_on_switch`, `switch_inactivity_days`, `last_login`)
- [ ] **ะะตัะตะบะปััะตะฝะธะต** โ ะฟะพ ะปะพะณะธะบะต ะฑะตะทะพะฟะฐัะฝะพััะธ UAM: ะธะท `wsid_accounts` ะฒะทััั ัะตะปะตะฒะพะน ะฐะบะบะฐัะฝั; ะตัะปะธ `require_password_on_switch !== 'always'` ะธ ะตััั `switch_token` ะธ ะฝะต ะธัััะบ ััะพะบ ะฝะตะฒัะพะดะฐ (`last_login` + `switch_inactivity_days`) โ `POST /api/uam/v1/switch-with-token` ั `{ email, switch_token }`, ะทะฐัะตะผ redirect ะฝะฐ return_url; ะธะฝะฐัะต โ `POST /logout` + redirect ะฝะฐ `auth.markbase.ru/login?switch=email&return_url=...`
- [ ] **ะะพะฑะฐะฒะปะตะฝะธะต ะฝะพะฒะพะณะพ** โ logout + redirect ะฝะฐ `auth.markbase.ru/login?new_account=1&return_url=...`
- [ ] **ะฃะดะฐะปะตะฝะธะต ะฐะบะบะฐัะฝัะฐ** โ ัะดะฐะปะตะฝะธะต ะธะท `wsid_accounts` (ะฝะต ะทะฐััะฐะณะธะฒะฐะตั ัะตััะธะธ)
- [ ] **ะััะพะด** โ `POST /api/uam/v1/logout` + redirect ะฝะฐ login
- [ ] **ะกััะปะบะฐ ะฝะฐ ัะฟัะฐะฒะปะตะฝะธะต ะฐะบะบะฐัะฝัะพะผ** โ redirect ะฝะฐ `auth.markbase.ru/account`

---

## ะะธัะฝัะน ะบะฐะฑะธะฝะตั (Personal Account)

### ะกััะฐะฝะธัั ะปะธัะฝะพะณะพ ะบะฐะฑะธะฝะตัะฐ

| ะกััะฐะฝะธัะฐ | URL | ะะฟะธัะฐะฝะธะต |
|----------|-----|----------|
| **ะัะพัะธะปั** | `/account` | ะัะพัะผะพัั ะธ ัะตะดะฐะบัะธัะพะฒะฐะฝะธะต ะธะผะตะฝะธ, email, ะบะพะผะฟะฐะฝะธะธ |
| **ะกะตััะธะธ** | `/account/sessions` | ะะบัะธะฒะฝัะต ัะตััะธะธ, IP, ััััะพะนััะฒะฐ, ะพัะทัะฒ ัะตััะธะน |
| **ะะพะดัะปะธ** | `/account/modules` | ะะฐัะฐะปะพะณ ะฟะพะดะบะปัััะฝะฝัั ะผะพะดัะปะตะน ะฟะปะฐััะพัะผั |
| **ะกะพะณะปะฐัะธั** | `/account/consents` | ะัะฐะฒะพะฒัะต ะดะพะบัะผะตะฝัั, ะฟัะตะดะพััะฐะฒะปะตะฝะธะต/ะพัะทัะฒ ัะพะณะปะฐัะธะน |
| **ะะตะทะพะฟะฐัะฝะพััั** | `/account/security` | ะฆะตะฝัั ะฑะตะทะพะฟะฐัะฝะพััะธ: ะพัะตะฝะบะฐ, ะธััะพัะธั ะฒัะพะดะพะฒ, ะผะพะดัะปะธ |
| **IP-ะฐะดัะตัะฐ** | `/account/ip` | ะฃะฟัะฐะฒะปะตะฝะธะต IP allowlist ะดะปั ะพะณัะฐะฝะธัะตะฝะธั ะฒัะพะดะฐ |

### ะฆะตะฝัั ะฑะตะทะพะฟะฐัะฝะพััะธ (Security Center)

ะกััะฐะฝะธัะฐ ะฑะตะทะพะฟะฐัะฝะพััะธ ะฒะบะปััะฐะตั:

1. **ะัะตะฝะบะฐ ะฑะตะทะพะฟะฐัะฝะพััะธ** โ 0โ100 ะฑะฐะปะปะพะฒ ั ะฒะธะทัะฐะปัะฝัะผ ะฟัะพะณัะตััะพะผ
   - Email ะฟะพะดัะฒะตัะถะดัะฝ: +25 ะฑะฐะปะปะพะฒ
   - IP-ะพะณัะฐะฝะธัะตะฝะธั ะฝะฐัััะพะตะฝั: +25 ะฑะฐะปะปะพะฒ
   - ะะฐะปะพ ะฐะบัะธะฒะฝัั ัะตััะธะน (โค 3): +10 ะฑะฐะปะปะพะฒ
   - 2FA ะฒะบะปััะตะฝะฐ: +10 ะฑะฐะปะปะพะฒ

2. **ะกัะฐัะธััะธะบะฐ** โ ะฐะบัะธะฒะฝัะต ัะตััะธะธ, ัะฐะทัะตััะฝะฝัะต IP, ัะตะบััะธะน IP

3. **ะะพะดัะปะธ ะทะฐัะธัั** โ ัะฟะธัะพะบ ะฒัะตั 10 ะผะพะดัะปะตะน ัะพ ััะฐัััะฐะผะธ

4. **ะะฐัะฐะผะตััั ะทะฐัะธัั** โ ะบะพะฝะบัะตัะฝัะต ะปะธะผะธัั ะธ ะฝะฐัััะพะนะบะธ

5. **ะััะพัะธั ะฒัะพะดะพะฒ** โ ัะฐะฑะปะธัะฐ ั IP, ััััะพะนััะฒะพะผ, ะดะฐัะพะน, ััะฐัััะพะผ

6. **ะะตัะตะบะปััะตะฝะธะต ะผะตะถะดั ะฐะบะบะฐัะฝัะฐะผะธ** โ ะฝะฐัััะพะนะบะธ ะฑะตะทะพะฟะฐัะฝะพััะธ ะฟัะธ ัะผะตะฝะต ะฐะบะบะฐัะฝัะฐ:
   - **ะัะตะณะดะฐ ะทะฐะฟัะฐัะธะฒะฐัั ะฟะฐัะพะปั** โ ะฟัะธ ะปัะฑะพะผ ะฟะตัะตะบะปััะตะฝะธะธ ะฝะฐ ััะพั ะฐะบะบะฐัะฝั ััะตะฑัะตััั ะฟะฐัะพะปั (ะผะฐะบัะธะผะฐะปัะฝะฐั ะทะฐัะธัะฐ)
   - **ะขะพะปัะบะพ ะฟะพัะปะต ะดะพะปะณะพะณะพ ะฝะตะฒัะพะดะฐ** โ ะฟะตัะตะบะปััะตะฝะธะต ะฑะตะท ะฟะฐัะพะปั ัะฐะทัะตัะตะฝะพ, ะตัะปะธ ั ะฟะพัะปะตะดะฝะตะณะพ ะฒัะพะดะฐ ะฟัะพัะปะพ ะผะตะฝััะต N ะดะฝะตะน (ะฟะพ ัะผะพะปัะฐะฝะธั 180)

7. **ะะตะบะพะผะตะฝะดะฐัะธะธ** โ ัะพะฒะตัั ะฟะพ ัะปัััะตะฝะธั ะฑะตะทะพะฟะฐัะฝะพััะธ

### ะฃะฟัะฐะฒะปะตะฝะธะต IP-ะฐะดัะตัะฐะผะธ

ะะพะปัะทะพะฒะฐัะตะปะธ ะผะพะณัั ัะฐะผะพััะพััะตะปัะฝะพ:
- ะัะพัะผะฐััะธะฒะฐัั ัะฟะธัะพะบ ัะฐะทัะตััะฝะฝัั IP
- ะะพะฑะฐะฒะปััั ะฝะพะฒัะต IP ั ะผะตัะบะพะน (ยซะัะธัยป, ยซะะพะผยป, ยซVPNยป)
- ะะพะฑะฐะฒะปััั ัะตะบััะธะน IP ะพะดะฝะธะผ ะบะปะธะบะพะผ
- ะฃะดะฐะปััั IP ะธะท ัะฟะธัะบะฐ
- ะะธะดะตัั ััะฐััั ะพะณัะฐะฝะธัะตะฝะธั (ะฒะบะปััะตะฝะพ/ะพัะบะปััะตะฝะพ)

> **ะะฐะถะฝะพ:** ะัะปะธ ะฒ ัะฟะธัะบะต ะตััั ัะพัั ะฑั ะพะดะธะฝ IP, ะฒัะพะด ัะฐะทัะตััะฝ **ัะพะปัะบะพ** ั ัะบะฐะทะฐะฝะฝัั ะฐะดัะตัะพะฒ. ะัะปะธ ัะฟะธัะพะบ ะฟััั โ ะฒัะพะด ัะฐะทัะตััะฝ ะพัะพะฒััะดั.

---

## API: ะะพะปะฝัะน ัะฟัะฐะฒะพัะฝะธะบ

### ะััะตะฝัะธัะธะบะฐัะธั

| ะะตัะพะด | ะญะฝะดะฟะพะธะฝั | ะะฟะธัะฐะฝะธะต |
|-------|----------|----------|
| POST | `/api/uam/v1/check-email` | ะัะพะฒะตัะบะฐ ัััะตััะฒะพะฒะฐะฝะธั ะฐะบะบะฐัะฝัะฐ: `{email}` โ `{exists, email}` (v1.4.0) |
| POST | `/api/uam/v1/register` | ะะตะณะธัััะฐัะธั: `{email, password, display_name, company_name}` |
| POST | `/api/uam/v1/login` | ะัะพะด: `{email, password}` โ Set-Cookie + ะฒ ะพัะฒะตัะต `switch_token`, `require_password_on_switch`, `switch_inactivity_days` (ัะพััะฐะฝััั ะฒ wsid_accounts) |
| POST | `/api/uam/v1/switch-with-token` | ะะตัะตะบะปััะตะฝะธะต ะฑะตะท ะฟะฐัะพะปั: `{email, switch_token}` โ Set-Cookie; 403 `reason: 'password_required'` ะตัะปะธ ะฝัะถะตะฝ ะฟะฐัะพะปั (ัะผ. ะปะพะณะธะบั ะฒััะต) |
| POST | `/api/uam/v1/logout` | ะััะพะด: ัะดะฐะปะตะฝะธะต cookie + ะฟะพะดะดะตัะถะบะฐ `return_url` (redirect ะดะปั ะฝะต-AJAX) |
| GET | `/api/uam/v1/logout` | ะััะพะด ัะตัะตะท redirect-ัััะปะบั: `?return_url=...` (ะดะปั PHP/HTML ะธะฝัะตะณัะฐัะธะน) |
| POST | `/api/uam/v1/logout-all` | ะััะพะด ะธะท ะฒัะตั ััััะพะนััะฒ: `{keep_current?: bool}` |
| GET | `/api/uam/v1/me` | ะขะตะบััะธะน ะฟะพะปัะทะพะฒะฐัะตะปั (ััะตะฑัะตั cookie) |
| GET | `/api/uam/v1/session/validate` | ะะฐะปะธะดะฐัะธั ัะตััะธะธ (ะดะปั backend-ะผะพะดัะปะตะน) |

### ะัะพัะธะปั ะธ ะฟะฐัะพะปั

| ะะตัะพะด | ะญะฝะดะฟะพะธะฝั | ะะฟะธัะฐะฝะธะต |
|-------|----------|----------|
| PATCH | `/api/uam/v1/profile` | ะะฑะฝะพะฒะปะตะฝะธะต ะฟัะพัะธะปั: `{display_name}` |
| POST | `/api/uam/v1/change-password` | ะกะผะตะฝะฐ ะฟะฐัะพะปั: `{current_password, new_password, logout_all?}` + conditional captcha |
| POST | `/api/uam/v1/verify-email` | ะะพะดัะฒะตัะถะดะตะฝะธะต email ะฟะพ ัะพะบะตะฝั: `{token}` |

### ะกะตััะธะธ

| ะะตัะพะด | ะญะฝะดะฟะพะธะฝั | ะะฟะธัะฐะฝะธะต |
|-------|----------|----------|
| GET | `/api/uam/v1/sessions` | ะกะฟะธัะพะบ ะฐะบัะธะฒะฝัั ัะตััะธะน (ะฒะบะปััะฐั `device_label`) |
| PATCH | `/api/uam/v1/sessions/:id` | ะะฑะฝะพะฒะธัั ะผะตัะบั ััััะพะนััะฒะฐ: `{device_label}` |
| DELETE | `/api/uam/v1/sessions/:id` | ะัะทัะฒ ะบะพะฝะบัะตัะฝะพะน ัะตััะธะธ |

### IP Allowlist

| ะะตัะพะด | ะญะฝะดะฟะพะธะฝั | ะะฟะธัะฐะฝะธะต |
|-------|----------|----------|
| GET | `/api/uam/v1/ip-allowlist` | ะกะฟะธัะพะบ ัะฐะทัะตััะฝะฝัั IP + `current_ip`, `ip_restriction_enabled` |
| POST | `/api/uam/v1/ip-allowlist` | ะะพะฑะฐะฒะธัั IP: `{ip_address, label}` |
| DELETE | `/api/uam/v1/ip-allowlist/:id` | ะฃะดะฐะปะธัั IP ะธะท ัะฟะธัะบะฐ |
| POST | `/api/uam/v1/ip-allowlist/add-current` | ะะพะฑะฐะฒะธัั ัะตะบััะธะน IP ะบะปะธะตะฝัะฐ |

### ะะตะทะพะฟะฐัะฝะพััั (v1.3.0)

| ะะตัะพะด | ะญะฝะดะฟะพะธะฝั | Auth | ะะฟะธัะฐะฝะธะต |
|-------|----------|------|----------|
| GET | `/api/uam/v1/security/status` | Cookie | ะะพะปะฝัะน ััะฐััั ะฑะตะทะพะฟะฐัะฝะพััะธ ะฐะบะบะฐัะฝัะฐ (ะฒะบะปััะฐั `security_settings`: `require_password_on_switch`, `switch_inactivity_days`) |
| PATCH | `/api/uam/v1/security/settings` | Cookie | ะะฐัััะพะนะบะธ ะฟะตัะตะบะปััะตะฝะธั: `{require_password_on_switch?, switch_inactivity_days?}` |
| GET | `/api/uam/v1/security/login-history` | Cookie | ะััะพัะธั ะฒัะพะดะพะฒ ะฟะพะปัะทะพะฒะฐัะตะปั |
| GET | `/api/uam/v1/security/protection-info` | ะัะฑะปะธัะฝัะน | ะะฝัะพัะผะฐัะธั ะพ ะผะพะดัะปัั ะทะฐัะธัั + IP-ััะฐััั |

### ะกะพะณะปะฐัะธั

| ะะตัะพะด | ะญะฝะดะฟะพะธะฝั | ะะฟะธัะฐะฝะธะต |
|-------|----------|----------|
| GET | `/api/uam/v1/consents` | ะกะฟะธัะพะบ ัะพะณะปะฐัะธะน ัะตะบััะตะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั |
| POST | `/api/uam/v1/consents` | ะฃะฟัะฐะฒะปะตะฝะธะต ัะพะณะปะฐัะธัะผะธ: `{scope, project_id?, grant: true/false}` |

### ะัะพะตะบัั

| ะะตัะพะด | ะญะฝะดะฟะพะธะฝั | ะะฟะธัะฐะฝะธะต |
|-------|----------|----------|
| GET | `/api/uam/v1/projects` | ะกะฟะธัะพะบ ะฟะพะดะบะปัััะฝะฝัั ะฟัะพะตะบัะพะฒ |
| POST | `/api/uam/v1/projects/:project_id/link` | ะัะธะฒัะทะบะฐ ะฟัะพะตะบัะฐ ะบ UAM (platform_admin) |

### Health Check

| ะะตัะพะด | ะญะฝะดะฟะพะธะฝั | ะะฟะธัะฐะฝะธะต |
|-------|----------|----------|
| GET | `/health` | ะกัะฐััั ัะตัะฒะธัะฐ, ะะ, ัะตััะธะน, ะผะพะดัะปะตะน ะทะฐัะธัั |

**ะัะฒะตั `/health` (v1.3.0):**
```json
{
  "status": "ok",
  "service": "waysenid-uam",
  "version": "1.3.0",
  "timestamp": "2026-02-08T12:00:00Z",
  "postgres": true,
  "session": true,
  "uptime": 86400,
  "security_modules": {
    "brute_force": true,
    "rate_limiter": true,
    "ip_filter": true,
    "audit_log": true
  }
}
```

### ะัะฒะตั `/security/status`

```json
{
  "score": 75,
  "modules": {
    "brute_force": { "status": "active", "max_attempts": 10, "window_minutes": 30 },
    "rate_limiter": { "status": "active", "max_requests_per_minute": 120 },
    "ip_allowlist": { "status": "active", "count": 2 },
    "audit_log": { "status": "active" },
    "https": { "status": "active" },
    "password_policy": { "status": "active", "min_length": 8 }
  },
  "stats": {
    "active_sessions": 3,
    "allowed_ips": 2,
    "failed_attempts_24h": 5,
    "total_attempts": 150,
    "unique_ips": 12,
    "blocked_ips": 1
  },
  "login_history": [...]
}
```

### ะัะฒะตั `/security/protection-info` (ะฟัะฑะปะธัะฝัะน)

```json
{
  "protection_enabled": true,
  "modules": [
    { "name": "Brute-Force Protection", "status": "active" },
    { "name": "DDoS Rate Limiter", "status": "active" },
    { "name": "IP Auto-Block", "status": "active" },
    { "name": "HTTPS Enforcement", "status": "active" }
  ],
  "limits": {
    "max_login_attempts": 10,
    "lockout_window_minutes": 30,
    "rate_limit_per_minute": 120
  }
}
```

---

## ะขัะตะฑะพะฒะฐะฝะธั CSP (Content Security Policy) ะดะปั ะผะพะดัะปะตะน

> **ะะะะขะะงะะกะะ ะะะะะ:** ะัะปะธ ะฒะฐั ะผะพะดัะปั/ะฟัะธะปะพะถะตะฝะธะต ะธัะฟะพะปัะทัะตั CSP, ะฒั **ะพะฑัะทะฐะฝั** ะดะพะฑะฐะฒะธัั
> `https://auth.markbase.ru` ะฒ ะดะธัะตะบัะธะฒั `connect-src`. ะะตะท ััะพะณะพ ะฒัะพะด ะะ ะฑัะดะตั ัะฐะฑะพัะฐัั.

### ะัะพะฑะปะตะผะฐ

ะัะปะธ ะฟัะธะปะพะถะตะฝะธะต ะฝะฐ `app.markbase.ru` ะฟััะฐะตััั ะฒัะทะฒะฐัั API `auth.markbase.ru` ะฝะฐะฟััะผัั (ะฝะฐะฟัะธะผะตั, `/check-email`, `/login`), ะฝะพ CSP ะฝะต ัะฐะทัะตัะฐะตั `auth.markbase.ru` ะฒ `connect-src`, ะฑัะฐัะทะตั **ะฑะปะพะบะธััะตั** ะทะฐะฟัะพัั:

```
Connecting to 'https://auth.markbase.ru/api/uam/v1/login' violates the following
Content Security Policy directive: "connect-src 'self' https://markbase.ru ..."
```

### ะะฒะฐ ัะฟะพัะพะฑะฐ ัะตัะตะฝะธั

**ะกะฟะพัะพะฑ 1 (ะะตะบะพะผะตะฝะดัะตะผัะน): Redirect-flow โ ะะ ะฒัะทัะฒะฐะตะผ API ะฝะฐะฟััะผัั**

ะะพะดัะปั **ะฝะต** ะฒัััะฐะธะฒะฐะตั ัะฒะพั ัะพัะผั ะฒัะพะดะฐ. ะะผะตััะพ ััะพะณะพ ะฟะตัะตะฝะฐะฟัะฐะฒะปัะตั ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะฐ `auth.markbase.ru`:

```javascript
// ะะพะปัะทะพะฒะฐัะตะปั ะฝะต ะฐะฒัะพัะธะทะพะฒะฐะฝ โ redirect ะฝะฐ auth
window.location.href = 'https://auth.markbase.ru/login?return_url=' +
  encodeURIComponent(window.location.href);
```

ะัะธ ัะฐะบะพะผ ะฟะพะดัะพะดะต CSP **ะฝะต ะฝัะถะตะฝ** ะดะปั `auth.markbase.ru`, ะฟะพัะพะผั ััะพ ะทะฐะฟัะพัั ะธะดัั ะฒะฝัััะธ `auth.markbase.ru` (same-origin).

**ะกะฟะพัะพะฑ 2: API-flow โ ะฒัะทัะฒะฐะตะผ API ะฝะฐะฟััะผัั (ะดะปั SPA/ะผะพะฑะธะปัะฝัั)**

ะัะปะธ ะฒะฐั ะผะพะดัะปั ะฒัะทัะฒะฐะตั `auth.markbase.ru` API ะฝะฐะฟััะผัั (fetch/axios), ะดะพะฑะฐะฒััะต ะฒ CSP:

```
connect-src 'self' https://auth.markbase.ru https://captcha.markbase.ru ...
```

### ะะดะต ะฝะฐัััะพะธัั CSP

| ะะตััะพ | ะัะธะผะตั |
|-------|--------|
| **Nginx** (ัะตะบะพะผะตะฝะดัะตััั) | `add_header Content-Security-Policy "connect-src 'self' https://auth.markbase.ru ..." always;` |
| **HTML meta tag** | `<meta http-equiv="Content-Security-Policy" content="connect-src 'self' https://auth.markbase.ru ...">` |
| **Backend (helmet.js)** | `helmet({ contentSecurityPolicy: { directives: { connectSrc: ["'self'", "https://auth.markbase.ru"] } } })` |

### ะะธะฝะธะผะฐะปัะฝัะน CSP ะดะปั ะผะพะดัะปะตะน MarkBase

ะะพะปะฝัะน ัะฟัะฐะฒะพัะฝะธะบ ะฟะพ CSP, Permissions-Policy ะธ ัะธะฟะธัะฝัะผ ะพัะธะฑะบะฐะผ: **[PUBLIC/CSP_AND_SECURITY.md](../../CSP_AND_SECURITY.md)**.

ะะธะฝะธะผะฐะปัะฝัะน ะฝะฐะฑะพั ะดะธัะตะบัะธะฒ:

```
default-src 'self';
connect-src 'self' https://auth.markbase.ru https://captcha.markbase.ru https://api.markbase.ru;
script-src 'self' https://captcha.markbase.ru https://smartcaptcha.yandexcloud.net;
frame-src https://captcha.markbase.ru https://smartcaptcha.yandexcloud.net;
style-src 'self' 'unsafe-inline';
img-src 'self' data:;
```

ะัะธ ะธัะฟะพะปัะทะพะฒะฐะฝะธะธ Google Tag Manager ะดะพะฑะฐะฒััะต ะฒ `script-src` ะธ `frame-src`: `https://www.googletagmanager.com`. ะะปั SmartCaptcha ะดะพะฑะฐะฒััะต Permissions-Policy ั `accelerometer` ะธ `gyroscope` โ ัะผ. CSP_AND_SECURITY.md.

> **ะะฐะถะฝะพ ะดะปั app.markbase.ru:** ะัะปะธ ะฟัะธะปะพะถะตะฝะธะต ะธัะฟะพะปัะทัะตั CSP ะธ ะฟะพะบะฐะทัะฒะฐะตั ยซNetwork Errorยป ะฟัะธ ะฒัะพะดะต โ ััะพ CSP ะฑะปะพะบะธััะตั ะทะฐะฟัะพัั ะบ `auth.markbase.ru`. ะะพะฑะฐะฒััะต `https://auth.markbase.ru` ะฒ `connect-src`.

**ะัะพะฑะปะตะผั ะฒัะพะดะฐ, ัะตััะธะน ะธ CORS** ะฟัะธ ะฟะพะดะบะปััะตะฝะธะธ ะฒะฝะตัะฝะธั ะฟัะพะตะบัะพะฒ (app, shop, ััะพัะพะฝะฝะธะต ัะฐะนัั) ะบ UAM: [ะะะะะะะะซ_ะะ_ะะ_ะะะจะะ_ะกะขะะะะะ.md](../../../../ะะะะะะะะซ_ะะ_ะะ_ะะะจะะ_ะกะขะะะะะ.md) ยง 2. ะงัะพ ะฝะฐัััะพะธัั ะฝะฐ ััะพัะพะฝะต ะฒะฝะตัะฝะตะณะพ ะฟัะพะตะบัะฐ (CSP, credentials, return_url): [MARKBASE_PLUGINS_OUR_SIDE.md](../../MARKBASE_PLUGINS_OUR_SIDE.md).

---

## ะะพัะฐะณะพะฒะพะต ะฟะพะดะบะปััะตะฝะธะต (Quick Start)

### ะจะฐะณ 1. ะะฟัะตะดะตะปะธัะต ัะธะฟ ะฒะฐัะตะณะพ ะฟัะพะตะบัะฐ

| ะขะธะฟ | ะะพะผะตะฝ | Cookie ัะฐะฑะพัะฐะตั? | ะะตัะพะด |
|-----|-------|-----------------|-------|
| **ะะพะดะดะพะผะตะฝ MarkBase** | `*.markbase.ru` | ะะฒัะพะผะฐัะธัะตัะบะธ | Redirect-flow |
| **ะะพะดะดะพะผะตะฝ WayGPT** | `*.waygpt.ru` | ะะตั | API-flow ะธะปะธ Redirect-flow |
| **ะะฝะตัะฝะธะน ะฟัะพะตะบั** | `yoursite.com` | ะะตั | API-flow ะธะปะธ Redirect-flow |

### ะจะฐะณ 2. Redirect-flow (ัะตะบะพะผะตะฝะดัะตััั)

ะะพะดัะพะดะธั ะดะปั **ะปัะฑะพะณะพ** ะฟัะพะตะบัะฐ, ะฒะบะปััะฐั ะฒะฝะตัะฝะธะต.

**2.1. ะะพะฑะฐะฒััะต ะบะฝะพะฟะบะธ ะฒัะพะดะฐ/ัะตะณะธัััะฐัะธะธ:**
```html
<a href="https://auth.markbase.ru/login?return_url=https://yoursite.com/dashboard">
  ะะพะนัะธ ัะตัะตะท MarkBase
</a>
<a href="https://auth.markbase.ru/register?return_url=https://yoursite.com/dashboard">
  ะะฐัะตะณะธัััะธัะพะฒะฐัััั
</a>
```

**2.2. ะะพะฑะฐะฒััะต ะฒะฐั ะดะพะผะตะฝ ะฒ allowlist:**

ะะดะผะธะฝะธัััะฐัะพั ะดะพะปะถะตะฝ ะดะพะฑะฐะฒะธัั ะฒะฐั ะดะพะผะตะฝ ะฒ `UAM_RETURN_URL_ALLOWLIST`:
```
UAM_RETURN_URL_ALLOWLIST=.markbase.ru,.waygpt.ru,.yoursite.com
```
ะะตะท ััะพะณะพ `return_url` ะฝะฐ ะฒะฐั ะดะพะผะตะฝ ะฑัะดะตั ะพัะบะปะพะฝัะฝ.

**2.3. ะะพะฑะฐะฒััะต ะฒะฐั ะดะพะผะตะฝ ะฒ CORS:**

ะ `.env` UAM:
```
UAM_CORS_ORIGINS=https://app.markbase.ru,...,https://yoursite.com
```

**2.4. ะะฐะปะธะดะฐัะธั ัะตััะธะธ ะฝะฐ ะฒะฐัะตะผ backend:**

ะะพัะปะต ัะตะดะธัะตะบัะฐ ะพะฑัะฐัะฝะพ cookie `uam_session` ะฑัะดะตั ัััะฐะฝะพะฒะปะตะฝะฐ **ัะพะปัะบะพ** ะดะปั `*.markbase.ru`.

ะะปั ะฟะพะดะดะพะผะตะฝะพะฒ MarkBase: cookie ะฐะฒัะพะผะฐัะธัะตัะบะธ ะพัะฟัะฐะฒะปัะตััั ะฟัะธ ะทะฐะฟัะพัะฐั ะบ UAM.

ะะปั ะฒะฝะตัะฝะธั ะฟัะพะตะบัะพะฒ: ะฒะฐั backend ะดะพะปะถะตะฝ ะธะทะฒะปะตัั cookie ะธะท redirect-URL ะธะปะธ ะธัะฟะพะปัะทะพะฒะฐัั `/api/uam/v1/me` ั `credentials: 'include'` (ะตัะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั ะพัะบััะป ะฒะฐั ัะฐะนั ั cookie MarkBase ะฒ ะฑัะฐัะทะตัะต).

**2.5. ะะพะฑะฐะฒััะต ะฒะฐะปะธะดะฐัะธั ะฒ ะฒะฐั backend:**

ะกะบะพะฟะธััะนัะต ะบะพะด ะธะท ัะตะบัะธะธ ะธะฝัะตะณัะฐัะธะธ (JS/Python/PHP ะฝะธะถะต) ะธ ะฝะฐัััะพะนัะต:

| ะะตัะตะผะตะฝะฝะฐั | ะะฝัััะธ ัะดัะฐ (waysen_core ััะตะบ) | ะะฝะตัะฝะธะน ะฟัะพะตะบั (ะดััะณะพะน Docker/ัะตัะฒะตั) |
|-----------|-------------------------------|---------------------------------------|
| `UAM_INTERNAL` | `http://uam:8060` (Docker-ะธะผั) | `https://auth.markbase.ru` (ะฟัะฑะปะธัะฝัะน URL) |
| `UAM_PUBLIC` | `https://auth.markbase.ru` | `https://auth.markbase.ru` |

### ะจะฐะณ 3. API-flow (ะดะปั ะผะพะฑะธะปัะฝัั/SPA ะฑะตะท redirect)

ะัะปะธ redirect ะฝะต ะฟะพะดัะพะดะธั (ะผะพะฑะธะปัะฝะพะต ะฟัะธะปะพะถะตะฝะธะต, SPA ะฝะฐ ะดััะณะพะผ ะดะพะผะตะฝะต):

```
1. ะะฐั frontend โ POST https://auth.markbase.ru/api/uam/v1/login
   Body: { "email": "...", "password": "..." }
   Headers: { "Content-Type": "application/json" }

2. ะัะฒะตั: { "success": true, "user": {...} }
   + Set-Cookie: uam_session=... (Domain: .markbase.ru)

3. ะะปั ะฟะพัะปะตะดัััะธั ะทะฐะฟัะพัะพะฒ ะบ UAM API:
   fetch('https://auth.markbase.ru/api/uam/v1/me', { credentials: 'include' })
```

> **ะะฐะถะฝะพ**: `credentials: 'include'` ะพะฑัะทะฐัะตะปะตะฝ ะดะปั ะพัะฟัะฐะฒะบะธ cookie cross-origin.

> **ะะฐะถะฝะพ**: ะัะธ ะฟัะตะฒััะตะฝะธะธ ะปะธะผะธัะฐ ะฟะพะฟััะพะบ ะพัะฒะตั ะฑัะดะตั 429 ั `retry_after_minutes`.

### ะจะฐะณ 4. ะัะพะฒะตัััะต ะธะฝัะตะณัะฐัะธั

```bash
# 1. ะัะพะฒะตัะธัั ััะพ UAM ะดะพัััะฟะตะฝ ะธ ะผะพะดัะปะธ ะทะฐัะธัั ะฐะบัะธะฒะฝั
curl -s https://auth.markbase.ru/health | jq .

# 2. ะัะพะฒะตัะธัั ะธะฝัะพัะผะฐัะธั ะพ ะทะฐัะธัะต (ะฟัะฑะปะธัะฝัะน ัะฝะดะฟะพะธะฝั)
curl -s https://auth.markbase.ru/api/uam/v1/security/protection-info | jq .

# 3. ะะฐัะตะณะธัััะธัะพะฒะฐัั ัะตััะพะฒะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั
curl -s -X POST https://auth.markbase.ru/api/uam/v1/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@yoursite.com","password":"TestPass123","display_name":"ะขะตัั"}' | jq .

# 4. ะะพะนัะธ ะธ ะฟะพะปััะธัั cookie
curl -s -X POST https://auth.markbase.ru/api/uam/v1/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@yoursite.com","password":"TestPass123"}' \
  -c cookies.txt | jq .

# 5. ะัะพะฒะตัะธัั ัะตััะธั
curl -s https://auth.markbase.ru/api/uam/v1/me -b cookies.txt | jq .

# 6. ะัะพะฒะตัะธัั ััะฐััั ะฑะตะทะพะฟะฐัะฝะพััะธ
curl -s https://auth.markbase.ru/api/uam/v1/security/status -b cookies.txt | jq .

# 7. ะะฐะปะธะดะฐัะธั ัะตััะธะธ (ะบะฐะบ ััะพ ะดะตะปะฐะตั ะฒะฐั backend)
curl -s https://auth.markbase.ru/api/uam/v1/session/validate -b cookies.txt | jq .
```

### ะจะฐะณ 5. ะะฐัััะพะนัะต ะบัั (ะพะฑัะทะฐัะตะปัะฝะพ!)

ะะตะท ะบััะฐ ะบะฐะถะดัะน ะทะฐะฟัะพั ะฟะพะปัะทะพะฒะฐัะตะปั ะดััะณะฐะตั UAM. ะก ะบััะตะผ:
- ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั: ~0ms ะฒะผะตััะพ ~50ms ะฝะฐ ะบะฐะถะดัะน ะทะฐะฟัะพั
- ะัะบะฐะทะพัััะพะนัะธะฒะพััั: ะฟะพะปัะทะพะฒะฐัะตะปะธ ะฝะต ะฒัะปะตััั ะฟัะธ ัะฑะพะต UAM

ะกะบะพะฟะธััะนัะต ะณะพัะพะฒัะน ะบะพะด ะธะท ัะตะบัะธะธ ะธะฝัะตะณัะฐัะธะธ ะฝะธะถะต โ ะบัั ัะถะต ะฒัััะพะตะฝ.

---

## 1. ะะฝัะตะณัะฐัะธั: JavaScript / React

### ะะฝะพะฟะบะธ ะฒัะพะดะฐ ะธ ัะตะณะธัััะฐัะธะธ

```javascript
const UAM_URL = 'https://auth.markbase.ru';

function AuthButtons() {
  const returnUrl = encodeURIComponent(window.location.origin + '/dashboard');
  return (
    <div>
      <a href={`${UAM_URL}/login?return_url=${returnUrl}`}>
        ะะพะนัะธ ัะตัะตะท MarkBase
      </a>
      <a href={`${UAM_URL}/register?return_url=${returnUrl}`}>
        ะะฐัะตะณะธัััะธัะพะฒะฐัััั
      </a>
    </div>
  );
}
```

> **return_url** ะฟะตัะตะดะฐัััั ะพะดะธะฝะฐะบะพะฒะพ ะดะปั `/login` ะธ `/register`. ะะพัะปะต ััะฟะตัะฝะพะณะพ ะฒัะพะดะฐ/ัะตะณะธัััะฐัะธะธ
> ะฟะพะปัะทะพะฒะฐัะตะปั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฒะตัะฝัััั ะฝะฐ ัะบะฐะทะฐะฝะฝัะน URL ั ัััะฐะฝะพะฒะปะตะฝะฝะพะน cookie.

### ะะฝะพะฟะบะฐ ะฒััะพะดะฐ

```javascript
function LogoutButton() {
  const handleLogout = async () => {
    // 1. ะัะทัะฒะฐะตะผ logout API (ัะดะฐะปัะตั cookie ะฝะฐ .markbase.ru)
    await fetch('https://auth.markbase.ru/api/uam/v1/logout', {
      method: 'POST',
      credentials: 'include'
    });
    // 2. ะะตัะตะฝะฐะฟัะฐะฒะปัะตะผ ะฝะฐ ะณะปะฐะฒะฝัั
    window.location.href = '/';
  };

  return <button onClick={handleLogout}>ะัะนัะธ</button>;
}

// ะะปะธ ะฟัะพััะพ ัััะปะบะฐ:
// <a href="https://auth.markbase.ru/api/uam/v1/logout?return_url=https://yoursite.com">ะัะนัะธ</a>
```

### ะัะพะฒะตัะบะฐ ัะตััะธะธ (Frontend)

```javascript
// ะะพัะปะต ัะตะดะธัะตะบัะฐ ะพะฑัะฐัะฝะพ โ cookie ัะถะต ัััะฐะฝะพะฒะปะตะฝะฐ
async function checkAuth() {
  try {
    const resp = await fetch('https://auth.markbase.ru/api/uam/v1/me', {
      credentials: 'include'  // ะะะฏะะะขะะะฌะะ ะดะปั ะพัะฟัะฐะฒะบะธ cookies
    });
    if (resp.ok) {
      const user = await resp.json();
      console.log('Authenticated:', user.email, user.role);
      return user;
    }
  } catch (e) {}
  return null;
}
```

### ะะฐะปะธะดะฐัะธั ะฝะฐ Backend (Node.js) โ ั ะบััะตะผ

```javascript
const axios = require('axios');
const crypto = require('crypto');

// ะะฝัััะธ ัะดัะฐ (waysen_core ััะตะบ): http://uam:8060 (Docker-ะธะผั)
// ะะท ะฒะฝะตัะฝะตะณะพ ะฟัะพะตะบัะฐ (ะดััะณะพะน Docker/ัะตัะฒะตั): https://auth.markbase.ru
const UAM_INTERNAL = 'https://auth.markbase.ru';

// โโ Session cache (in-memory) โโ
const sessionCache = new Map();
const CACHE_TTL = 72 * 60 * 60 * 1000;  // 72 ัะฐัะฐ โ ัะพะฒะฟะฐะดะฐะตั ั TTL ัะตััะธะธ
const CACHE_REFRESH = 60_000;           // 1 ะผะธะฝ โ ัะพะฝะพะฒะพะต ะพะฑะฝะพะฒะปะตะฝะธะต
const CACHE_MAX = 10_000;

function cacheKey(cookie) {
  return crypto.createHash('sha256').update(cookie).digest('hex').slice(0, 32);
}

function cacheGet(cookie) {
  const key = cacheKey(cookie);
  const entry = sessionCache.get(key);
  if (!entry) return null;
  if (Date.now() - entry.cachedAt > CACHE_TTL) {
    sessionCache.delete(key);
    return null;
  }
  return entry;
}

function cacheSet(cookie, user) {
  if (sessionCache.size >= CACHE_MAX) {
    // ะฃะดะฐะปัะตะผ ะฟัะพััััะธะต
    const now = Date.now();
    for (const [k, v] of sessionCache) {
      if (now - v.cachedAt > CACHE_TTL) sessionCache.delete(k);
    }
  }
  sessionCache.set(cacheKey(cookie), { user, cachedAt: Date.now() });
}

function cacheRemove(cookie) {
  sessionCache.delete(cacheKey(cookie));
}

/**
 * ะะฐะปะธะดะฐัะธั ัะตััะธะธ ั ะผะฐะบัะธะผะฐะปัะฝะพะน ะพัะบะฐะทะพัััะพะนัะธะฒะพัััั:
 * - UAM 200 โ ะบัั + return user
 * - UAM 401 reason=revoked โ ะฏะะะซะ ะพัะทัะฒ โ ัะดะฐะปัะตะผ ะบัั
 * - UAM 401 ะดััะณะพะต โ wipe/ัะตััะฐัั โ ะธัะฟะพะปัะทัะตะผ ะบัั (ะฝะต ะฒัะบะธะดัะฒะฐะตะผ!)
 * - UAM ะฝะตะดะพัััะฟะตะฝ โ ะธัะฟะพะปัะทัะตะผ ะบัั
 */
async function validateSession(req) {
  const cookie = req.cookies?.uam_session;
  if (!cookie) return null;

  const cached = cacheGet(cookie);

  // ะัั ัะฒะตะถะธะน โ ะฝะต ะดััะณะฐะตะผ UAM
  if (cached && Date.now() - cached.cachedAt < CACHE_REFRESH) {
    return cached.user;
  }

  try {
    const { data, status } = await axios.get(
      `${UAM_INTERNAL}/api/uam/v1/session/validate`,
      {
        headers: { Cookie: `uam_session=${cookie}` },
        timeout: 3000,
        validateStatus: () => true
      }
    );

    if (status === 200) {
      cacheSet(cookie, data);
      return data;
    }

    if (status === 401) {
      // ะขะะะฌะะ reason=revoked ะพะทะฝะฐัะฐะตั ััะพ ะฟะพะปัะทะพะฒะฐัะตะปั ะกะะ ะพัะพะทะฒะฐะป ัะตััะธั
      if (data?.reason === 'revoked') {
        cacheRemove(cookie);
        return null;
      }
      // not_found, expired โ ะฒะพะทะผะพะถะฝะพ wipe/ัะตััะฐัั, ะะ ะฒัะบะธะดัะฒะฐะตะผ
      return cached ? cached.user : null;
    }

    // 500, 503 โ ะธัะฟะพะปัะทัะตะผ ะบัั
    return cached ? cached.user : null;
  } catch {
    // Timeout, connection refused โ ะธัะฟะพะปัะทัะตะผ ะบัั
    return cached ? cached.user : null;
  }
}

// Express middleware
function requireAuth(req, res, next) {
  validateSession(req).then(user => {
    if (!user) return res.redirect('https://auth.markbase.ru/login?return_url=' + encodeURIComponent(req.originalUrl));
    req.user = user;
    next();
  });
}
```

---

## 2. ะะฝัะตะณัะฐัะธั: Python / FastAPI โ ั ะบััะตะผ

```python
import time
import hashlib
import httpx
from fastapi import Request, HTTPException

# ะะฝัััะธ ัะดัะฐ (waysen_core ััะตะบ): "http://uam:8060"
# ะะท ะฒะฝะตัะฝะตะณะพ ะฟัะพะตะบัะฐ (ะดััะณะพะน Docker/ัะตัะฒะตั): "https://auth.markbase.ru"
UAM_INTERNAL = "https://auth.markbase.ru"
UAM_PUBLIC = "https://auth.markbase.ru"
COOKIE = "uam_session"

# โโ Session cache โโ
_cache: dict = {}
CACHE_TTL = 259200    # 72 ัะฐัะฐ โ ัะพะฒะฟะฐะดะฐะตั ั TTL ัะตััะธะธ
CACHE_REFRESH = 60    # 1 ะผะธะฝ โ ัะพะฝะพะฒะพะต ะพะฑะฝะพะฒะปะตะฝะธะต
CACHE_MAX = 10000

def _key(cookie): return hashlib.sha256(cookie.encode()).hexdigest()[:32]

def _cache_get(cookie):
    entry = _cache.get(_key(cookie))
    if not entry: return None
    if time.time() - entry["t"] > CACHE_TTL:
        _cache.pop(_key(cookie), None)
        return None
    return entry

def _cache_set(cookie, user):
    if len(_cache) >= CACHE_MAX:
        now = time.time()
        for k in [k for k,v in _cache.items() if now-v["t"] > CACHE_TTL]:
            _cache.pop(k, None)
    _cache[_key(cookie)] = {"user": user, "t": time.time()}

def _cache_rm(cookie):
    _cache.pop(_key(cookie), None)

def validate_session(request: Request):
    cookie = request.cookies.get(COOKIE)
    if not cookie: return None

    cached = _cache_get(cookie)
    if cached and time.time() - cached["t"] < CACHE_REFRESH:
        return cached["user"]

    try:
        resp = httpx.get(
            f"{UAM_INTERNAL}/api/uam/v1/session/validate",
            cookies={COOKIE: cookie}, timeout=3
        )
        if resp.status_code == 200:
            user = resp.json()
            _cache_set(cookie, user)
            return user
        if resp.status_code == 401:
            # ะขะพะปัะบะพ reason=revoked โ ะฟะพะปัะทะพะฒะฐัะตะปั ะฏะะะ ะพัะพะทะฒะฐะป
            reason = ""
            try: reason = resp.json().get("reason", "")
            except: pass
            if reason == "revoked":
                _cache_rm(cookie)
                return None
            # not_found/expired โ wipe/ัะตััะฐัั, ะะ ะฒัะบะธะดัะฒะฐะตะผ
            return cached["user"] if cached else None
        return cached["user"] if cached else None
    except:
        return cached["user"] if cached else None

def require_auth(request: Request, return_url: str):
    user = validate_session(request)
    if not user:
        raise HTTPException(302, headers={
            "Location": f"{UAM_PUBLIC}/login?return_url={return_url}"
        })
    return user
```

---

## 3. ะะฝัะตะณัะฐัะธั: PHP โ ั ะบััะตะผ

```php
<?php
define('UAM_URL', 'https://auth.markbase.ru');
define('UAM_COOKIE', 'uam_session');
define('UAM_CACHE_TTL', 259200);    // 72 ัะฐัะฐ โ ัะพะฒะฟะฐะดะฐะตั ั TTL ัะตััะธะธ
define('UAM_CACHE_REFRESH', 60);    // 1 ะผะธะฝ โ ัะพะฝะพะฒะพะต ะพะฑะฝะพะฒะปะตะฝะธะต

/**
 * ะะพะปััะธัั ะฟััั ะบ ัะฐะนะปั ะบััะฐ ัะตััะธะธ.
 * ะะปั PHP ะธัะฟะพะปัะทัะตััั ัะฐะนะปะพะฒัะน ะบัั ะฒ /tmp.
 */
function uam_cache_path(string $cookie): string {
    $hash = substr(hash('sha256', $cookie), 0, 32);
    return sys_get_temp_dir() . '/uam_session_' . $hash . '.json';
}

function uam_cache_get(string $cookie): ?array {
    $path = uam_cache_path($cookie);
    if (!file_exists($path)) return null;
    $data = json_decode(file_get_contents($path), true);
    if (!$data || (time() - $data['cached_at']) > UAM_CACHE_TTL) {
        @unlink($path);
        return null;
    }
    return $data;
}

function uam_cache_set(string $cookie, array $user): void {
    $path = uam_cache_path($cookie);
    file_put_contents($path, json_encode([
        'user' => $user,
        'cached_at' => time()
    ]), LOCK_EX);
}

function uam_cache_remove(string $cookie): void {
    @unlink(uam_cache_path($cookie));
}

/**
 * ะะฐะปะธะดะฐัะธั ัะตััะธะธ ั graceful degradation.
 * ะัะธ ะฝะตะดะพัััะฟะฝะพััะธ UAM ะฒะพะทะฒัะฐัะฐะตั ะทะฐะบััะธัะพะฒะฐะฝะฝัะน ัะตะทัะปััะฐั.
 */
function uam_validate_session(): ?array {
    $cookie = $_COOKIE[UAM_COOKIE] ?? null;
    if (!$cookie) return null;

    $cached = uam_cache_get($cookie);

    // ะัั ัะฒะตะถะธะน โ ะฝะต ะดััะณะฐะตะผ UAM
    if ($cached && (time() - $cached['cached_at']) < UAM_CACHE_REFRESH) {
        return $cached['user'];
    }

    $ch = curl_init(UAM_URL . '/api/uam/v1/session/validate');
    curl_setopt_array($ch, [
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_HTTPHEADER => ["Cookie: " . UAM_COOKIE . "=" . $cookie],
        CURLOPT_TIMEOUT => 3,
        CURLOPT_CONNECTTIMEOUT => 2
    ]);
    $response = curl_exec($ch);
    $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $error = curl_errno($ch);
    curl_close($ch);

    // Timeout ะธะปะธ ะพัะธะฑะบะฐ ัะพะตะดะธะฝะตะฝะธั โ ะธัะฟะพะปัะทัะตะผ ะบัั
    if ($error) {
        return $cached ? $cached['user'] : null;
    }

    if ($code === 200) {
        $user = json_decode($response, true);
        uam_cache_set($cookie, $user);
        return $user;
    }

    if ($code === 401) {
        // ะขะพะปัะบะพ reason=revoked โ ะฟะพะปัะทะพะฒะฐัะตะปั ะฏะะะ ะพัะพะทะฒะฐะป ัะตััะธั
        $body = json_decode($response, true);
        if (($body['reason'] ?? '') === 'revoked') {
            uam_cache_remove($cookie);
            return null;
        }
        // not_found/expired โ wipe/ัะตััะฐัั, ะะ ะฒัะบะธะดัะฒะฐะตะผ
        return $cached ? $cached['user'] : null;
    }

    // 500, 503 โ ะธัะฟะพะปัะทัะตะผ ะบัั
    return $cached ? $cached['user'] : null;
}

function uam_require_auth(string $return_url): array {
    $user = uam_validate_session();
    if (!$user) {
        header('Location: ' . UAM_URL . '/login?return_url=' . urlencode($return_url));
        exit;
    }
    return $user;
}

function uam_login_url(string $return_url): string {
    return UAM_URL . '/login?return_url=' . urlencode($return_url);
}

function uam_register_url(string $return_url): string {
    return UAM_URL . '/register?return_url=' . urlencode($return_url);
}

function uam_logout_url(string $return_url): string {
    return UAM_URL . '/api/uam/v1/logout?return_url=' . urlencode($return_url);
}
```

**ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะฒ ัะฐะฑะปะพะฝะต:**
```php
<?php
$return = 'https://' . $_SERVER['HTTP_HOST'] . '/dashboard';
$user = uam_validate_session();

if ($user) {
    echo "ะัะธะฒะตั, {$user['display_name']}! ";
    echo "<a href='" . uam_logout_url($return) . "'>ะัะนัะธ</a>";
} else {
    echo "<a href='" . uam_login_url($return) . "'>ะะพะนัะธ</a> | ";
    echo "<a href='" . uam_register_url($return) . "'>ะะตะณะธัััะฐัะธั</a>";
}
?>
```

---

## 4. ะะฝัะตะณัะฐัะธั: WordPress โ ั ะบััะตะผ

### ะคะฐะนะป ะฟะปะฐะณะธะฝะฐ: `markbase-auth.php`

```php
<?php
/**
 * Plugin Name: MarkBase Auth (WaySenID)
 * Description: ะะดะธะฝะฐั ะฐััะตะฝัะธัะธะบะฐัะธั ัะตัะตะท MarkBase UAM ั ะพัะบะฐะทะพัััะพะนัะธะฒัะผ ะบััะตะผ
 * Version: 1.2.0
 * Author: MarkBase
 */

if (!defined('ABSPATH')) exit;

define('MB_UAM_URL', 'https://auth.markbase.ru');
define('MB_UAM_COOKIE', 'uam_session');
define('MB_CACHE_TTL', 259200);    // 72 ัะฐัะฐ โ ัะพะฒะฟะฐะดะฐะตั ั TTL ัะตััะธะธ
define('MB_CACHE_REFRESH', 60);    // 1 ะผะธะฝ โ ัะพะฝะพะฒะพะต ะพะฑะฝะพะฒะปะตะฝะธะต

// === ะัั (WordPress Transients API) ===

function mb_auth_cache_key(string $cookie): string {
    return 'mb_uam_' . substr(hash('sha256', $cookie), 0, 20);
}

function mb_auth_cache_get(string $cookie): ?array {
    $data = get_transient(mb_auth_cache_key($cookie));
    return is_array($data) ? $data : null;
}

function mb_auth_cache_set(string $cookie, array $user): void {
    set_transient(mb_auth_cache_key($cookie), [
        'user' => $user,
        'cached_at' => time()
    ], MB_CACHE_TTL);
}

function mb_auth_cache_remove(string $cookie): void {
    delete_transient(mb_auth_cache_key($cookie));
}

// === ะะฐะปะธะดะฐัะธั ัะตััะธะธ UAM ั graceful degradation ===
function mb_auth_validate_session(): ?array {
    $cookie = $_COOKIE[MB_UAM_COOKIE] ?? null;
    if (!$cookie) return null;

    $cached = mb_auth_cache_get($cookie);

    // ะัั ัะฒะตะถะธะน โ ะฝะต ะดััะณะฐะตะผ UAM
    if ($cached && (time() - $cached['cached_at']) < MB_CACHE_REFRESH) {
        return $cached['user'];
    }

    $response = wp_remote_get(MB_UAM_URL . '/api/uam/v1/session/validate', [
        'cookies' => [new WP_Http_Cookie([
            'name' => MB_UAM_COOKIE,
            'value' => $cookie
        ])],
        'timeout' => 3
    ]);

    // UAM ะฝะตะดะพัััะฟะตะฝ โ ะธัะฟะพะปัะทัะตะผ ะบัั
    if (is_wp_error($response)) {
        return $cached ? $cached['user'] : null;
    }

    $code = wp_remote_retrieve_response_code($response);

    if ($code === 200) {
        $user = json_decode(wp_remote_retrieve_body($response), true);
        mb_auth_cache_set($cookie, $user);
        return $user;
    }

    if ($code === 401) {
        // ะขะพะปัะบะพ reason=revoked โ ะฟะพะปัะทะพะฒะฐัะตะปั ะฏะะะ ะพัะพะทะฒะฐะป ัะตััะธั
        $body = json_decode(wp_remote_retrieve_body($response), true);
        if (($body['reason'] ?? '') === 'revoked') {
            mb_auth_cache_remove($cookie);
            return null;
        }
        // not_found/expired โ wipe/ัะตััะฐัั, ะะ ะฒัะบะธะดัะฒะฐะตะผ
        return $cached ? $cached['user'] : null;
    }

    // 500, 503 โ ะธัะฟะพะปัะทัะตะผ ะบัั
    return $cached ? $cached['user'] : null;
}

// === ะะฒัะพะผะฐัะธัะตัะบะธะน ะปะพะณะธะฝ WordPress ัะตัะตะท UAM ===
add_action('init', function() {
    if (is_user_logged_in()) return;

    $uam_user = mb_auth_validate_session();
    if (!$uam_user) return;

    // ะะฐะนัะธ ะธะปะธ ัะพะทะดะฐัั WP-ะฟะพะปัะทะพะฒะฐัะตะปั
    $wp_user = get_user_by('email', $uam_user['email']);
    if (!$wp_user) {
        $user_id = wp_create_user(
            $uam_user['email'],
            wp_generate_password(),
            $uam_user['email']
        );
        wp_update_user([
            'ID' => $user_id,
            'display_name' => $uam_user['display_name'] ?? $uam_user['email'],
            'role' => mb_auth_map_role($uam_user['role'] ?? 'user')
        ]);
        $wp_user = get_user_by('id', $user_id);
    }

    // ะะฒัะพะผะฐัะธัะตัะบะธะน ะปะพะณะธะฝ
    wp_set_current_user($wp_user->ID);
    wp_set_auth_cookie($wp_user->ID);
});

// === ะะฐะฟะฟะธะฝะณ ัะพะปะตะน UAM -> WordPress ===
function mb_auth_map_role($uam_role) {
    $map = [
        'platform_admin' => 'administrator',
        'owner'          => 'administrator',
        'admin'          => 'editor',
        'manager'        => 'author',
        'operator'       => 'contributor',
        'user'           => 'subscriber'
    ];
    return $map[$uam_role] ?? 'subscriber';
}

// === ะะฝะพะฟะบะธ ะฒัะพะดะฐ ะธ ัะตะณะธัััะฐัะธะธ (ัะพััะบะพะดั) ===
add_shortcode('markbase_login', function($atts) {
    $atts = shortcode_atts(['text' => 'ะะพะนัะธ ัะตัะตะท MarkBase'], $atts);
    $return_url = urlencode(home_url($_SERVER['REQUEST_URI']));
    return '<a href="' . MB_UAM_URL . '/login?return_url=' . $return_url
         . '" class="markbase-login-btn">' . esc_html($atts['text']) . '</a>';
});

add_shortcode('markbase_register', function($atts) {
    $atts = shortcode_atts(['text' => 'ะะฐัะตะณะธัััะธัะพะฒะฐัััั'], $atts);
    $return_url = urlencode(home_url($_SERVER['REQUEST_URI']));
    return '<a href="' . MB_UAM_URL . '/register?return_url=' . $return_url
         . '" class="markbase-register-btn">' . esc_html($atts['text']) . '</a>';
});

// === ะะพะปะฝัะน ะฒะธะดะถะตั ะฐะฒัะพัะธะทะฐัะธะธ (ัะพััะบะพะด) ===
add_shortcode('markbase_auth', function($atts) {
    $user = mb_auth_validate_session();
    $return_url = urlencode(home_url($_SERVER['REQUEST_URI']));
    if ($user) {
        $name = esc_html($user['display_name'] ?? $user['email']);
        $logout = MB_UAM_URL . '/api/uam/v1/logout?return_url=' . $return_url;
        return "<span class='mb-auth-user'>ะัะธะฒะตั, {$name}! <a href='{$logout}'>ะัะนัะธ</a></span>";
    }
    $login = MB_UAM_URL . '/login?return_url=' . $return_url;
    $register = MB_UAM_URL . '/register?return_url=' . $return_url;
    return "<span class='mb-auth-guest'><a href='{$login}'>ะะพะนัะธ</a> | <a href='{$register}'>ะะตะณะธัััะฐัะธั</a></span>";
});

// === Logout โ ะพัะธััะบะฐ UAM cookie ===
add_action('wp_logout', function() {
    setcookie(MB_UAM_COOKIE, '', time() - 3600, '/', '.markbase.ru');
});

// === ะกััะฐะฝะธัะฐ ะฝะฐัััะพะตะบ ===
add_action('admin_menu', function() {
    add_options_page('MarkBase Auth', 'MarkBase Auth', 'manage_options', 'markbase-auth', function() {
        $user = mb_auth_validate_session();
        echo '<div class="wrap">';
        echo '<h1>MarkBase Auth (WaySenID)</h1>';
        echo '<table class="form-table">';
        echo '<tr><th>UAM URL</th><td>' . MB_UAM_URL . '</td></tr>';
        echo '<tr><th>Cookie</th><td>' . MB_UAM_COOKIE . '</td></tr>';
        echo '<tr><th>Cache TTL</th><td>' . MB_CACHE_TTL . ' ัะตะบ (72ั, ัะพะฒะฟะฐะดะฐะตั ั TTL ัะตััะธะธ)</td></tr>';
        echo '<tr><th>Session</th><td>' . ($user ? 'Active (' . $user['email'] . ')' : 'Not connected') . '</td></tr>';
        echo '</table></div>';
    });
});
```

### ะฃััะฐะฝะพะฒะบะฐ WordPress-ะฟะปะฐะณะธะฝะฐ

1. ะกะบะพะฟะธััะนัะต `markbase-auth.php` ะฒ `/wp-content/plugins/markbase-auth/`
2. ะะบัะธะฒะธััะนัะต ะฒ **ะะปะฐะณะธะฝั โ MarkBase Auth**
3. ะัะฟะพะปัะทัะนัะต ัะพััะบะพะดั:
   - `[markbase_login]` โ ะบะฝะพะฟะบะฐ ะฒัะพะดะฐ
   - `[markbase_register]` โ ะบะฝะพะฟะบะฐ ัะตะณะธัััะฐัะธะธ
   - `[markbase_auth]` โ ะฟะพะปะฝัะน ะฒะธะดะถะตั (ะตัะปะธ ะทะฐะปะพะณะธะฝะตะฝ โ ะธะผั + ะฒััะพะด, ะธะฝะฐัะต โ ะฒัะพะด + ัะตะณะธัััะฐัะธั)
4. ะะฐัััะพะนัะต ะฒ **ะะฐัััะพะนะบะธ โ MarkBase Auth** โ ะฟัะพะฒะตัััะต ััะฐััั ะฟะพะดะบะปััะตะฝะธั

---

## ะะพะฝัะธะณััะฐัะธั

| ะะฐัะฐะผะตัั | ะะฝะฐัะตะฝะธะต | ะะฟะธัะฐะฝะธะต |
|----------|----------|----------|
| `UAM_URL` | `https://auth.markbase.ru` | ะัะฑะปะธัะฝัะน URL |
| `UAM_INTERNAL` | `http://uam:8060` | ะะฝัััะธ ัะดัะฐ (waysen_core ััะตะบ). ะะท ะฒะฝะตัะฝะตะณะพ ะฟัะพะตะบัะฐ: `https://auth.markbase.ru` |
| `UAM_SESSION_COOKIE` | `uam_session` | ะะผั cookie |
| `UAM_COOKIE_DOMAIN` | `.markbase.ru` | ะะพะผะตะฝ cookie |
| `UAM_SESSION_TTL_HOURS` | `72` | ะัะตะผั ะถะธะทะฝะธ ัะตััะธะธ |
| `CACHE_TTL` | `259200` (72 ัะฐัะฐ) | ะกะพะฒะฟะฐะดะฐะตั ั TTL ัะตััะธะธ |
| `CACHE_REFRESH` | `60` (1 ะผะธะฝ) | ะคะพะฝะพะฒะพะต ะพะฑะฝะพะฒะปะตะฝะธะต |

---

## FAQ

### ะงัะพ ะฟัะพะธะทะพะนะดัั ะตัะปะธ UAM ัะฟะฐะดัั?

ะะพะปัะทะพะฒะฐัะตะปะธ, ะบะพัะพััะต **ัะถะต ะฒะพัะปะธ**, ะฟัะพะดะพะปะถะฐั ัะฐะฑะพัั ะฒ ะปัะฑะพะผ ะผะพะดัะปะต. ะั ัะตััะธั ะทะฐะบััะธัะพะฒะฐะฝะฐ ะปะพะบะฐะปัะฝะพ (TTL = 72 ัะฐัะฐ, ัะพะฒะฟะฐะดะฐะตั ั TTL ัะฐะผะพะน ัะตััะธะธ). ะะพะฒัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ ะฝะต ัะผะพะณัั ะฒะพะนัะธ ะดะพ ะฒะพัััะฐะฝะพะฒะปะตะฝะธั UAM.

### ะงัะพ ะฟัะพะธะทะพะนะดัั ะฟัะธ `--wipe` (ะฟะพะปะฝัะน ัะฑัะพั ะะ)?

ะะฐะปะพะณะธะฝะตะฝะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ **ะฝะต ะทะฐะผะตััั** โ ะบัั ะฝะฐ ะผะพะดัะปัั ะฟัะพะดะพะปะถะธั ัะฐะฑะพัะฐัั. UAM ะฒะตัะฝัั `reason: "not_found"` (ัะตััะธั ะพััััััะฒัะตั ะฒ ัะฒะตะถะตะน ะะ), ะฝะพ ะผะพะดัะปะธ ะะ ัะดะฐะปัั ะบัั. ะะพะปัะทะพะฒะฐัะตะปั ะฟัะพะดะพะปะถะฐะตั ัะฐะฑะพัั.

### ะงัะพ ะฟัะพะธะทะพะนะดัั ะฟัะธ "ะัะนัะธ ะธะท ะฒัะตั ััััะพะนััะฒ"?

UAM ะพัะผะตัะธั ะฒัะต ัะตััะธะธ ะบะฐะบ `revoked`. ะัะธ ัะปะตะดัััะตะน ัะตะฒะฐะปะธะดะฐัะธะธ (ะฒ ัะตัะตะฝะธะต 60 ัะตะบ) ะผะพะดัะปั ะฟะพะปััะธั `reason: "revoked"` ะธ **ัะดะฐะปะธั ะบัั**, ะฟะพะปัะทะพะฒะฐัะตะปั ะฑัะดะตั ัะฐะทะปะพะณะธะฝะตะฝ. ะญัะพ ะตะดะธะฝััะฒะตะฝะฝัะน ัะฟะพัะพะฑ ะฟัะธะฝัะดะธัะตะปัะฝะพ ัะฐะทะปะพะณะธะฝะธัั.

### ะะฐะบ ะพะฑะฝะพะฒะธัั ะบัั ะฟัะธ ะธะทะผะตะฝะตะฝะธะธ ัะพะปะธ ะฟะพะปัะทะพะฒะฐัะตะปั?

ะัั ะพะฑะฝะพะฒะปัะตััั ะบะฐะถะดัั ะผะธะฝััั ะฟัะธ ะดะพัััะฟะฝะพะผ UAM. ะะทะผะตะฝะตะฝะธะต ัะพะปะธ ะฟัะธะผะตะฝะธััั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฒ ัะตัะตะฝะธะต 60 ัะตะบัะฝะด.

### ะะตะทะพะฟะฐัะตะฝ ะปะธ ะบัั?

ะะฐ. ะะปัั ะบััะฐ โ SHA256 ะพั cookie (ะฝะต ัะฐะผ cookie). ะัั ะธะฝะฒะฐะปะธะดะธััะตััั **ัะพะปัะบะพ** ะฟัะธ ัะฒะฝะพะผ `reason: "revoked"` ะพั UAM. ะญัะพ ะพะทะฝะฐัะฐะตั ััะพ ะฟะพะปัะทะพะฒะฐัะตะปั ัะฐะผ ะฝะฐะถะฐะป "ะฒัะนัะธ" ะธะปะธ "ัะผะตะฝะธัั ะฟะฐัะพะปั ั ะฟัะธะฝัะดะธัะตะปัะฝัะผ ะฒััะพะดะพะผ".

### ะะฐะบ ัะฐะฑะพัะฐะตั ะทะฐัะธัะฐ ะพั ะฟะตัะตะฑะพัะฐ?

1. ะะฐะถะดะฐั ะฝะตัะดะฐัะฝะฐั ะฟะพะฟััะบะฐ ะฒัะพะดะฐ ะทะฐะฟะธััะฒะฐะตััั ั IP ะธ email
2. ะัะธ ะดะพััะธะถะตะฝะธะธ 10 ะฟะพะฟััะพะบ ะทะฐ 30 ะผะธะฝ โ ะฒัะพะด ะฑะปะพะบะธััะตััั
3. ะัะธ ะฟะพะฒัะพัะฝะพะผ ะฝะฐัััะตะฝะธะธ ะฑะปะพะบะธัะพะฒะบะฐ ะฝะฐัะฐััะฐะตั: 60 โ 120 โ 240 ะผะธะฝ
4. IP ะฐะฒัะพะผะฐัะธัะตัะบะธ ะทะฐะฝะพัะธััั ะฒ ัะฐะฑะปะธัั `blocked_ips`
5. ะะพะปัะทะพะฒะฐัะตะปั ะฒะธะดะธั ะพััะฐะฒัะธะตัั ะฟะพะฟััะบะธ ะธ ัะฐะนะผะตั ะฑะปะพะบะธัะพะฒะบะธ

### ะะฐะบ ัะฐะฑะพัะฐะตั IP-ัะธะปัััะฐัะธั?

1. ะะพะปัะทะพะฒะฐัะตะปั ะดะพะฑะฐะฒะปัะตั ะดะพะฒะตัะตะฝะฝัะต IP ะฒ `/account/ip`
2. ะัะปะธ ะฒ ัะฟะธัะบะต โฅ 1 IP โ ะฒัะพะด ัะฐะทัะตััะฝ **ัะพะปัะบะพ** ั ะฝะธั
3. ะัะธ ะฟะพะฟััะบะต ะฒัะพะดะฐ ั ะดััะณะพะณะพ IP โ ะพัะบะฐะท ั ัะพะพะฑัะตะฝะธะตะผ
4. ะัะปะธ ัะฟะธัะพะบ ะฟััั โ ะฒัะพะด ัะฐะทัะตััะฝ ะพัะพะฒััะดั

---

## Changelog

### 1.5.0 (2026-02-09)
- **ะะตัะตะบะปััะตะฝะธะต ะฑะตะท ะฟะฐัะพะปั** โ ะฟัะธ ะฟะตัะตะบะปััะตะฝะธะธ ะฝะฐ ะดััะณะพะน ัะพััะฐะฝัะฝะฝัะน ะฐะบะบะฐัะฝั ะฟะฐัะพะปั ะฝะต ะทะฐะฟัะฐัะธะฒะฐะตััั, ะตัะปะธ ะฒะปะฐะดะตะปะตั ะฐะบะบะฐัะฝัะฐ ะฝะต ะฒะบะปััะธะป ยซะัะตะณะดะฐ ะทะฐะฟัะฐัะธะฒะฐัั ะฟะฐัะพะปัยป ะธ ั ะฟะพัะปะตะดะฝะตะณะพ ะฒัะพะดะฐ ะฟัะพัะปะพ ะผะตะฝััะต N ะดะฝะตะน (ะฟะพ ัะผะพะปัะฐะฝะธั 180)
- **POST /switch-with-token** โ ะฟะตัะตะบะปััะตะฝะธะต ะฟะพ ัะพะบะตะฝั, ะฒัะดะฐะฝะฝะพะผั ะฟัะธ ะฒัะพะดะต ะฟะพ ะฟะฐัะพะปั (TTL ะฟะพ ัะผะพะปัะฐะฝะธั 30 ะดะฝะตะน)
- **ะะฐัััะพะนะบะธ ะฒ ะะตะทะพะฟะฐัะฝะพััะธ** โ ยซะะตัะตะบะปััะตะฝะธะต ะผะตะถะดั ะฐะบะบะฐัะฝัะฐะผะธยป: ะฒัะตะณะดะฐ ะฟะฐัะพะปั / ัะพะปัะบะพ ะฟะพัะปะต ะดะพะปะณะพะณะพ ะฝะตะฒัะพะดะฐ + ัะธัะปะพ ะดะฝะตะน
- **ะะตัะบะธ ััััะพะนััะฒ** โ ะฒ ัะฟะธัะบะต ัะตััะธะน ะผะพะถะฝะพ ะทะฐะดะฐัั ะฝะฐะทะฒะฐะฝะธะต ััััะพะนััะฒะฐ (PATCH /sessions/:id, `device_label`)
- **ะกะฟะตัะธัะธะบะฐัะธั ะฒ ะฟะปะฐะณะธะฝะต** โ ะปะพะณะธะบะฐ ะฟะตัะตะบะปััะตะฝะธั, ัะพัะผะฐั wsid_accounts (switch_token, ะฝะฐัััะพะนะบะธ), ัะตะบ-ะปะธัั ะธ ะณะพัะพะฒัะน AccountSwitcher ั ะฑะตะทะพะฟะฐัะฝะพะน ะปะพะณะธะบะพะน ะดะปั ััะพัะพะฝะฝะธั ะผะพะดัะปะตะน

### 1.4.0 (2026-02-09)
- **Account Switcher** โ ะฟะตัะตะบะปััะตะฝะธะต ะฐะบะบะฐัะฝัะพะฒ ะฒ dropdown ะฟัะพัะธะปั ัะฐะฟะบะธ (Layout.js)
- **URL-ะฟะฐัะฐะผะตัั `?switch=email`** โ ะฑััััะพะต ะฟะตัะตะบะปััะตะฝะธะต ะฐะบะบะฐัะฝัะฐ (ะฟัะพะฟััะบะฐะตั ะฒัะฑะพั, ััะฐะทั ะฒะฒะพะด ะฟะฐัะพะปั)
- **URL-ะฟะฐัะฐะผะตัั `?new_account=1`** โ ะดะพะฑะฐะฒะปะตะฝะธะต ะฝะพะฒะพะณะพ ะฐะบะบะฐัะฝัะฐ (ะฟัะพะฟััะบะฐะตั ะฒัะฑะพั, ััะฐะทั ะฒะฒะพะด email)
- **GET /logout ั return_url** โ ะฟะพะดะดะตัะถะบะฐ redirect-ัััะปะพะบ ะดะปั ะฒััะพะดะฐ (PHP/WordPress/HTML)
- **POST /check-email** โ ะฝะพะฒัะน endpoint ะดะปั ะฟัะพะฒะตัะบะธ ัััะตััะฒะพะฒะฐะฝะธั ะฐะบะบะฐัะฝัะฐ ะฟะตัะตะด ะฒะฒะพะดะพะผ ะฟะฐัะพะปั
- **ะฃะผะฝัะน UX ะปะพะณะธะฝะฐ** โ ะฟัะธ ะฝะตัััะตััะฒัััะตะผ email ะฟะพะบะฐะทัะฒะฐะตััั ะฟัะตะดะปะพะถะตะฝะธะต ะทะฐัะตะณะธัััะธัะพะฒะฐัััั (ั ะฐะฒัะพะทะฐะฟะพะปะฝะตะฝะธะตะผ email)
- **ะฃะผะฝัะน UX ัะตะณะธัััะฐัะธะธ** โ ะฟัะธ ะทะฐะฝััะพะผ email ะฟะพะบะฐะทัะฒะฐะตััั ะฟัะตะดะปะพะถะตะฝะธะต ะฒะพะนัะธ
- **ะะฐะทะปะธัะตะฝะธะต ะพัะธะฑะพะบ** โ `reason: 'user_not_found'` (ะปะพะณะธะฝ), `reason: 'email_taken'` (ัะตะณะธัััะฐัะธั) ะดะปั ัะพัะฝะพะณะพ ะพัะพะฑัะฐะถะตะฝะธั ะฝะฐ ััะพะฝัะตะฝะดะต
- **URL-ะฟะฐัะฐะผะตัั `?email=`** โ ะฑะตััะพะฒะฝัะน ะฟะตัะตัะพะด ะผะตะถะดั ะปะพะณะธะฝะพะผ ะธ ัะตะณะธัััะฐัะธะตะน ั ะฐะฒัะพะทะฐะฟะพะปะฝะตะฝะธะตะผ email
- **ะกะฟะตัะธัะธะบะฐัะธั Account Switcher ะดะปั ะผะพะดัะปะตะน** โ ะฟะพะปะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั + ะณะพัะพะฒัะน React-ะบะพะผะฟะพะฝะตะฝั ะดะปั ะปัะฑะพะณะพ ะผะพะดัะปั
- **Captcha fix** โ ะธัะฟัะฐะฒะปะตะฝะฐ ะดะฒะพะนะฝะฐั ะฒะตัะธัะธะบะฐัะธั (frontend ะฑะพะปััะต ะฝะต ะฒัะทัะฒะฐะตั /verify ะฝะฐะฟััะผัั)
- **Captcha URL** โ ะดะธะฝะฐะผะธัะตัะบะพะต ะพะฟัะตะดะตะปะตะฝะธะต URL captcha-ัะตัะฒะธัะฐ (`https://captcha.markbase.ru` ะฒ ะฟัะพะดะฐะบัะตะฝะต)
- **Fail-open tokens** โ ะบะพััะตะบัะฝะฐั ะพะฑัะฐะฑะพัะบะฐ `fail_open` ัะพะบะตะฝะพะฒ ะฒ backend middleware

### 1.3.0 (2026-02-08)
- ๐จ **ะะพะปะฝัะน ัะตะดะธะทะฐะนะฝ** frontend ะฒ ััะธะปะต Yandex ID
- ๐ **ะะฝะพะณะพััะพะฒะฝะตะฒะฐั ะทะฐัะธัะฐ**: brute-force, DDoS rate limiting, progressive lockout, IP auto-block
- ๐ค **ะัะฑะพั ะฐะบะบะฐัะฝัะพะฒ**: ะดะพ 5 ะทะฐะฟะพะผะฝะตะฝะฝัั, ัะดะฐะปะตะฝะธะต, ะฟะตัะตะบะปััะตะฝะธะต, ะฐะฒะฐัะฐัั
- ๐ **IP-ัะฟัะฐะฒะปะตะฝะธะต**: ะดะพะฑะฐะฒะปะตะฝะธะต/ัะดะฐะปะตะฝะธะต IP, ัะตะบััะธะน IP, ะผะตัะบะธ
- ๐ **ะฆะตะฝัั ะฑะตะทะพะฟะฐัะฝะพััะธ**: ะพัะตะฝะบะฐ 0โ100, ะผะพะดัะปะธ ะทะฐัะธัั, ะฟะฐัะฐะผะตััั, ะธััะพัะธั
- ๐ **ะััะพัะธั ะฒัะพะดะพะฒ**: ะฟะพะปะฝะฐั ัะฐะฑะปะธัะฐ ั IP, ััััะพะนััะฒะพะผ, ะดะฐัะพะน, ััะฐัััะพะผ
- ๐ก๏ธ **Password Policy**: ะผะธะฝะธะผัะผ 8 ัะธะผะฒะพะปะพะฒ, ะทะฐะณะปะฐะฒะฝัะต + ัััะพัะฝัะต + ัะธััั
- ๐ **Security Headers**: HSTS, X-Frame-Options, X-XSS-Protection, no-cache
- ๐ก **ะะพะฒัะต API**: `/security/status`, `/security/settings`, `/security/login-history`, `/security/protection-info`
- โก **Global Rate Limiter**: 120 req/min ะฝะฐ ะฒัะต API, 20 req/min ะฝะฐ auth
- ๐ซ **IP Auto-Block**: ะฐะฒัะพะฑะปะพะบะธัะพะฒะบะฐ ะฟัะธ ะฟะพะฒัะพัะฝัั ะฝะฐัััะตะฝะธัั ั ะฝะฐัะฐััะฐััะธะผ lockout
- ๐ **Audit Logging**: ะฟะพะปะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต ะฒัะพะดะพะฒ ะธ ะดะตะนััะฒะธะน ะฑะตะทะพะฟะฐัะฝะพััะธ
- ๐ **ะะธัะฝัะน ะบะฐะฑะธะฝะตั**: 6 ัััะฐะฝะธั โ ะัะพัะธะปั, ะกะตััะธะธ, ะะพะดัะปะธ, ะกะพะณะปะฐัะธั, ะะตะทะพะฟะฐัะฝะพััั, IP
- โ **ะะฐะปะธะดะฐัะธั ัะตะณะธัััะฐัะธะธ**: ัะตะบะปะธัั ััะตะฑะพะฒะฐะฝะธะน ะบ ะฟะฐัะพะปั ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ

### 1.2.0 (2026-02-07)
- Reason-based invalidation: ะบัั ัะดะฐะปัะตััั ะขะะะฌะะ ะฟัะธ `reason: "revoked"`
- ะะตัะตะทะฐะฟััะบ/wipe UAM ะฝะต ะฒะปะธัะตั ะฝะฐ ะทะฐะปะพะณะธะฝะตะฝะฝัั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
- Cache TTL ัะฒะตะปะธัะตะฝ ะดะพ 72 ัะฐัะพะฒ (ัะพะฒะฟะฐะดะฐะตั ั TTL ัะตััะธะธ)
- ะญะฝะดะฟะพะธะฝั `/session/validate` ัะตะฟะตัั ะฒะพะทะฒัะฐัะฐะตั `reason` ะฒ 401-ะพัะฒะตัะฐั

### 1.1.0 (2026-02-07)
- Session cache ั graceful degradation
- ะัะธ ะฝะตะดะพัััะฟะฝะพััะธ UAM ะฟะพะปัะทะพะฒะฐัะตะปะธ ะพััะฐัััั ะทะฐะปะพะณะธะฝะตะฝะฝัะผะธ
- ะคะพะฝะพะฒะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ะบััะฐ ะบะฐะถะดัะต 60 ัะตะบ ะฟัะธ ะดะพัััะฟะฝะพะผ UAM
- ะะฑะฝะพะฒะปะตะฝั ะฒัะต ะฟัะธะผะตัั: JS, Python, PHP, WordPress

### 1.0.0 (2026-02-07)
- ะะตัะฒัะน ัะตะปะธะท
- Session-based ะฐััะตะฝัะธัะธะบะฐัะธั (bcrypt + HTTP-only cookie)
- SSO ัะตัะตะท cookie ะฝะฐ `.markbase.ru`
- CORS ะดะปั `*.markbase.ru`, `*.waygpt.ru`
- Brute-force protection (10 ะฟะพะฟััะพะบ / 30 ะผะธะฝ)
- IP allowlist ะดะปั ะพะณัะฐะฝะธัะตะฝะธั ะฒัะพะดะฐ
- ะััะพะด ะธะท ะฒัะตั ััััะพะนััะฒ
- ะะฝัะตะณัะฐัะธั: JS, Python, PHP, WordPress
