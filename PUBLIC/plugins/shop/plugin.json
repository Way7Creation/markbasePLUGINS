{
  "name": "MarkBase Shop",
  "slug": "shop",
  "version": "1.1.0",
  "description": "Мультитенантный интернет-магазин: каталог, корзина, чекаут (B2B/B2C), управление компаниями, шаблоны витрин, AI-поиск, управление обработкой данных (152-ФЗ), подключение внешней БД. Полная изоляция по shop_id.",
  "author": "MarkBase",
  "license": "MIT",
  "homepage": "https://shop.markbase.ru",
  "api_base": "https://shop.markbase.ru/api/shop/v1",
  "port": 8020,
  "category": "ecommerce",
  "requires": ["uam", "registry"],
  "provides": ["catalog", "cart", "checkout_b2b", "checkout_b2c", "customer_account", "company_management", "storefront_templates", "ai_search", "document_recognition", "telegram_bot", "data_governance", "external_db"],
  "multi_tenant": {
    "isolation": "shop_id",
    "description": "Полная изоляция по shop_id. Каждый магазин — отдельная витрина с каталогом, корзинами, заказами, шаблонами и настройками. Клиенты видят только свой магазин.",
    "header": "X-Shop-Id",
    "enforcement": "shopIdentificationMiddleware определяет shop_id из заголовка / домена / query. Все SQL-запросы содержат WHERE shop_id.",
    "domains": "Поддержка кастомных доменов: *.shop.markbase.ru и собственные домены клиентов",
    "api_keys_per_shop": true
  },
  "auth": {
    "type": "uam_session + hmac",
    "session_cookie": "uam_session",
    "cookie_domain": ".markbase.ru",
    "hmac_headers": ["X-Api-Key", "X-Timestamp", "X-Signature", "X-Shop-Id"],
    "description": "Покупатели авторизуются через WaySenID (SSO). Межмодульные запросы подписываются HMAC-SHA256."
  },
  "endpoints": {
    "catalog": "GET /api/shop/v1/catalog",
    "product_get": "GET /api/shop/v1/products/:id",
    "categories": "GET /api/shop/v1/categories",
    "search": "GET /api/shop/v1/search",
    "cart_get": "GET /api/shop/v1/cart",
    "cart_add_item": "POST /api/shop/v1/cart/items",
    "cart_update_item": "PATCH /api/shop/v1/cart/items/:item_id",
    "cart_remove_item": "DELETE /api/shop/v1/cart/items/:item_id",
    "cart_clear": "DELETE /api/shop/v1/cart",
    "checkout_b2b": "POST /api/shop/v1/checkout/b2b",
    "checkout_b2c": "POST /api/shop/v1/checkout/b2c",
    "checkout_start": "POST /api/shop/v1/checkout",
    "checkout_initiate": "POST /api/shop/v1/checkout/initiate",
    "checkout_confirm": "POST /api/shop/v1/checkout/confirm",
    "checkout_delivery_options": "POST /api/shop/v1/checkout/delivery-options",
    "checkout_session_get": "GET /api/shop/v1/checkout/:session_id",
    "checkout_session_update": "PATCH /api/shop/v1/checkout/:session_id",
    "checkout_complete": "POST /api/shop/v1/checkout/:session_id/complete",
    "orders_list": "GET /api/shop/v1/orders",
    "order_get": "GET /api/shop/v1/orders/:order_id",
    "order_cancel": "POST /api/shop/v1/orders/:order_id/cancel",
    "order_to_invoice": "POST /api/shop/v1/orders/:id/to-invoice",
    "me": "GET /api/shop/v1/me",
    "my_orders": "GET /api/shop/v1/me/orders",
    "my_order": "GET /api/shop/v1/me/orders/:order_id",
    "my_addresses": "GET /api/shop/v1/me/addresses",
    "my_address_add": "POST /api/shop/v1/me/addresses",
    "pickup_points": "GET /api/shop/v1/pickup-points",
    "companies_list": "GET /api/shop/v1/companies",
    "company_create": "POST /api/shop/v1/companies",
    "company_get": "GET /api/shop/v1/companies/:id",
    "company_update": "PUT /api/shop/v1/companies/:id",
    "company_invite": "POST /api/shop/v1/companies/:id/invite",
    "company_accept_invite": "POST /api/shop/v1/companies/accept-invite",
    "company_member_update": "PUT /api/shop/v1/companies/:id/members/:memberId",
    "company_link_shop": "POST /api/shop/v1/companies/:id/shops/:shopId/link",
    "data_governance_get": "GET /api/shop/v1/companies/:companyId/data-governance",
    "data_governance_update": "PUT /api/shop/v1/companies/:companyId/data-governance",
    "data_governance_test_db": "POST /api/shop/v1/companies/:companyId/data-governance/test-db",
    "data_governance_passport_json": "GET /api/shop/v1/companies/:companyId/data-governance/passport",
    "data_governance_passport_txt": "GET /api/shop/v1/companies/:companyId/data-governance/passport/txt",
    "data_governance_audit": "GET /api/shop/v1/companies/:companyId/data-governance/audit",
    "data_governance_public": "GET /api/shop/v1/companies/:companyId/data-governance/public",
    "document_upload": "POST /api/shop/v1/documents/upload",
    "documents_list": "GET /api/shop/v1/documents",
    "document_get": "GET /api/shop/v1/documents/:id",
    "document_add_to_cart": "POST /api/shop/v1/documents/:id/add-to-cart",
    "telegram_webhook": "POST /api/shop/v1/telegram/webhook/:app_id",
    "health": "GET /api/shop/v1/health"
  },
  "admin_endpoints": {
    "base": "/api/shop/v1/admin",
    "description": "Управление магазином: домены, интеграции, шаблоны, диагностика, каталог"
  },
  "features": {
    "b2b_checkout": "Корпоративные заказы с юридическими реквизитами, спецификациями, счетами",
    "b2c_checkout": "Простые заказы для физлиц",
    "ai_search": "Умный поиск через WayGPT AI с фоллбэком на PostgreSQL full-text",
    "document_recognition": "AI-распознавание документов (PDF, Excel, фото) и автоматический подбор товаров",
    "telegram_bot": "Telegram-бот для приёма заказов",
    "storefront_templates": "Версионированные шаблоны витрин (HTML+CSS)"
  },
  "data_governance": {
    "description": "Управление обработкой персональных данных клиентов на уровне компании (152-ФЗ)",
    "compliance": "ст. 18 ФЗ-152, ст. 9 ФЗ-152, Постановление Правительства РФ N 1119",
    "storage_modes": {
      "platform": "Данные хранятся на серверах платформы MarkBase",
      "self_hosted": "Компания хостит свою БД для данных клиентов",
      "hybrid": "Часть данных на платформе, часть на внешней БД"
    },
    "external_db": {
      "description": "Подключение собственной PostgreSQL БД для хранения данных клиентов",
      "auto_schema": "При подключении автоматически создаются таблицы customers и customer_consents",
      "encryption": "Пароль БД шифруется AES-256 на стороне приложения",
      "sync": "Синхронизация мета-данных с платформой, raw-данные остаются на сервере клиента"
    },
    "passport": {
      "description": "Скачиваемый Паспорт обработки данных для Роскомнадзора и клиентов",
      "formats": ["JSON", "TXT (для печати)"],
      "content": ["Оператор ПД", "Инфраструктура хранения", "Меры безопасности", "Цели обработки", "Сроки хранения", "Статистика согласий", "Надзорный орган"]
    },
    "admin_page": "/admin/dashboard/data-governance",
    "public_api": "GET /api/shop/v1/companies/:companyId/data-governance/public — публичная информация о хранении данных"
  },
  "integrations": {
    "orders": "Передача заказов в Orders модуль для закупок у поставщиков",
    "crm": "Синхронизация клиентов и заказов в CRM",
    "logistics": "Создание логистических заказов",
    "delivery": "Расчёт тарифов доставки при чекауте",
    "markbase": "Получение каталога товаров из MarkBase (app.markbase.ru)",
    "waygpt": "AI-поиск и распознавание документов",
    "files": "Аватарки, изображения товаров, документы — всё через FILES модуль. files-client.js для HMAC-загрузки."
  },
  "avatar": {
    "source": "FILES module (files.markbase.ru)",
    "endpoint_used": "GET /api/files/v1/avatar/user/:userId через files-client.getUserAvatar()",
    "display": "Header — профиль пользователя (img с fallback на иконку user)",
    "auth_me": "GET /api/auth/me возвращает avatar_url полученный из FILES через files-client"
  },
  "database": {
    "name": "shop_db",
    "schema": "shop",
    "tables": ["shops", "products_cache", "carts", "cart_items", "orders", "order_items", "customers", "customer_addresses", "checkout_sessions", "pickup_points", "domains", "templates", "companies", "company_members", "webhooks_inbox", "outbox_events", "company_data_governance", "company_data_governance_audit", "company_customer_consents"],
    "isolation_indexes": "Все таблицы индексированы по shop_id"
  },
  "config": {
    "SHOP_URL": "https://shop.markbase.ru",
    "SHOP_PORT": 8020,
    "SHOP_API_KEY": "Выдаётся через Registry",
    "SHOP_HMAC_SECRET": "Выдаётся через Registry"
  },
  "compatibility": {
    "platforms": ["javascript", "python", "php", "wordpress", "any"],
    "min_version": "1.0.0"
  }
}
