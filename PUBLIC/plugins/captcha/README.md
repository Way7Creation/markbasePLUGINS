# Plugin: Captcha โ ะะฐัะธัะฐ ัะพัะผ ะพั ะฑะพัะพะฒ

> **ะะตััะธั:** 1.1.0
> **Slug:** `captcha`
> **ะะพะผะตะฝ:** `captcha.markbase.ru`
> **ะะพัั:** 8079
> **ะัะพะฒะฐะนะดะตั ะฟะพ ัะผะพะปัะฐะฝะธั:** ะกะพะฑััะฒะตะฝะฝะฐั ะบะฐะฟัะฐ (MarkBase Custom)

---

## ะะฑะทะพั

MarkBase Captcha โ ัะฝะธะฒะตััะฐะปัะฝัะน ัะตัะฒะธั ะทะฐัะธัั ะปัะฑัั ัะพัะผ ะพั ะฑะพัะพะฒ, ัะฟะฐะผะฐ ะธ ะฐะฒัะพะผะฐัะธัะตัะบะธั ะดะตะนััะฒะธะน. ะะฐะฑะพัะฐะตั ะฝะฐ `captcha.markbase.ru` ะธ ะดะพัััะฟะตะฝ ะดะปั ะฒัััะฐะธะฒะฐะฝะธั ะฝะฐ **ะปัะฑะพะน ัะฐะนั** ัะตัะตะท ะฒะธะดะถะตั.

**3 ะฟัะพะฒะฐะนะดะตัะฐ:**
| # | ะัะพะฒะฐะนะดะตั | ะะพ ัะผะพะปัะฐะฝะธั | ะขัะตะฑัะตั ะฒะฝะตัะฝะธะน ัะตัะฒะธั | ะะฟะธัะฐะฝะธะต |
|---|-----------|:---:|:---:|-----------|
| 1 | **MarkBase Custom** | โ | ะะตั | SVG-ะบะฐะฟัะฐ ั ะธัะบะฐะถัะฝะฝัะผ ัะตะบััะพะผ/ะผะฐัะตะผะฐัะธะบะพะน |
| 2 | **ะฏะฝะดะตะบั SmartCaptcha** | โ | ะะฐ | ะะตะฒะธะดะธะผะฐั ะฟัะพะฒะตัะบะฐ ัะตัะตะท ะฏะฝะดะตะบั.ะะฑะปะฐะบะพ |
| 3 | **Google reCAPTCHA v3** | โ | ะะฐ | ะะตะฒะธะดะธะผะฐั ะฟัะพะฒะตัะบะฐ ัะพ ัะบะพัะพะผ ัะตัะตะท Google |

**ะะปััะตะฒัะต ะฒะพะทะผะพะถะฝะพััะธ:**
- ๐ **ะกะธััะตะผะฐ ะบะปััะตะน** โ ะบะฐะถะดัะน ะฟัะพะตะบั ะฟะพะปััะฐะตั ัะฒะพั ะฟะฐัั `site_key` / `secret_key`
- ๐ **ะะธะดะถะตั ะดะปั ะปัะฑะพะณะพ ัะฐะนัะฐ** โ `<script src="https://captcha.markbase.ru/widget.js">`
- ๐ก๏ธ **Fail-Open ัััะฐัะตะณะธั** โ ะฟัะธ ะฝะตะดะพัััะฟะฝะพััะธ ัะตัะฒะธัะฐ ัะพัะผั ะฟัะพะดะพะปะถะฐัั ัะฐะฑะพัะฐัั
- ๐ **ะกัะฐัะธััะธะบะฐ** โ ัะบะพะปัะบะพ ะฟัะพะฒะตัะพะบ, ััะฟะตัะฝัั/ะฝะตััะฟะตัะฝัั, ะฟะพ ะฟัะพะฒะฐะนะดะตัะฐะผ
- ๐ **Fallback** โ ะตัะปะธ ะพัะฝะพะฒะฝะพะน ะฟัะพะฒะฐะนะดะตั ะฝะตะดะพัััะฟะตะฝ, ะฐะฒัะพะผะฐัะธัะตัะบะธ ะธัะฟะพะปัะทัะตััั ะทะฐะฟะฐัะฝะพะน
- ๐ **ะะพะผะตะฝ-ัะธะปัััะฐัะธั** โ ะบะปััะธ ัะฐะฑะพัะฐัั ัะพะปัะบะพ ะฝะฐ ัะฐะทัะตััะฝะฝัั ะดะพะผะตะฝะฐั
- โก **ะััะธัะพะฒะฐะฝะธะต** โ ะฟัะพะตะบัั ะบััะธัััััั ะดะปั ะฑััััะพะณะพ ะพัะฒะตัะฐ

---

## ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                 captcha.markbase.ru (8079)               โ
โ                                                          โ
โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โ
โ  โ  Custom       โ  โ  ะฏะฝะดะตะบั      โ  โ  Google      โ  โ
โ  โ  (ะฟะพ ัะผะพะปั.)  โ  โ  SmartCaptchaโ  โ  reCAPTCHA   โ  โ
โ  โ  SVG + verify โ  โ  validate APIโ  โ  siteverify  โ  โ
โ  โโโโโโโโฌโโโโโโโโ  โโโโโโโโฌโโโโโโโโ  โโโโโโโโฌโโโโโโโโ  โ
โ         โ                  โ                  โ          โ
โ         โโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโ          โ
โ                        โ                                 โ
โ              โโโโโโโโโโโผโโโโโโโโโโโ                      โ
โ              โ   Verification     โ                      โ
โ              โ   Service          โ                      โ
โ              โ   (ะตะดะธะฝะฐั ัะพัะบะฐ)   โ                      โ
โ              โโโโโโโโโโโฌโโโโโโโโโโโ                      โ
โ                        โ                                 โ
โ              โโโโโโโโโโโผโโโโโโโโโโโ                      โ
โ              โ   PostgreSQL       โ                      โ
โ              โ   projects,        โ                      โ
โ              โ   challenges,      โ                      โ
โ              โ   verifications    โ                      โ
โ              โโโโโโโโโโโโโโโโโโโโโโ                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
         โโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโ
         โ                 โ                  โ
    โโโโโโผโโโโโ      โโโโโโผโโโโโ       โโโโโโผโโโโโ
    โ  UAM    โ      โ  ะะฐั    โ       โ  ะัะฑะพะน  โ
    โ  (ะฒัะพะด/ โ      โ  ัะฐะนั   โ       โ  ัะฐะนั   โ
    โ  ัะตะณะธัั)โ      โ  (ัะฐัั/ โ       โ  (widgetโ
    โ         โ      โ  ัะพัะผั) โ       โ  .js)   โ
    โโโโโโโโโโโ      โโโโโโโโโโโ       โโโโโโโโโโโ
```

### ะะพััะดะพะบ ะฟัะพะฒะฐะนะดะตัะพะฒ (ะฟัะธะพัะธัะตั)

```
1. ะกะพะฑััะฒะตะฝะฝะฐั ะบะฐะฟัะฐ (custom) โ ะฟะพ ัะผะพะปัะฐะฝะธั, ะฒัะตะณะดะฐ ะดะพัััะฟะฝะฐ
       โ (ะตัะปะธ ะฝะฐัััะพะตะฝ yandex)
2. ะฏะฝะดะตะบั SmartCaptcha โ ะตัะปะธ ะตััั yandex_site_key + yandex_secret_key
       โ (ะตัะปะธ ะฝะฐัััะพะตะฝ google)
3. Google reCAPTCHA โ ะตัะปะธ ะตััั google_site_key + google_secret_key
       โ (ะฟัะธ ะพัะธะฑะบะต ะปัะฑะพะณะพ ะฟัะพะฒะฐะนะดะตัะฐ)
4. Fallback โ ะดััะณะพะน ะฟัะพะฒะฐะนะดะตั
       โ (ะตัะปะธ ะฒัั ะฝะตะดะพัััะฟะฝะพ)
5. Fail-Open โ ะฟัะพะฟััะบะฐะตะผ + ะปะพะณะธััะตะผ
```

### Fail-Open ัััะฐัะตะณะธั

| ะกะธััะฐัะธั | ะะพะฒะตะดะตะฝะธะต | ะะพะณะธัะพะฒะฐะฝะธะต |
|----------|-----------|-------------|
| ะัะพะฒะฐะนะดะตั ะดะพัััะฟะตะฝ, ัะพะบะตะฝ ะฒะตัะฝัะน | โ ะัะพะฟััะบะฐะตะผ | โ ะะพะณ |
| ะัะพะฒะฐะนะดะตั ะดะพัััะฟะตะฝ, ัะพะบะตะฝ ะฝะตะฒะตัะฝัะน | โ ะะปะพะบะธััะตะผ | โ ะะพะณ |
| ะัะพะฒะฐะนะดะตั ะฝะตะดะพัััะฟะตะฝ (timeout) | โ๏ธ ะัะพะฟััะบะฐะตะผ (fail-open) | โ ะะพะณ + alert |
| Captcha Service ะฝะต ัะฐะฑะพัะฐะตั | โ๏ธ ะัะพะฟััะบะฐะตะผ (fail-open) | โ ะะพะณ + alert |
| ะขะพะบะตะฝ ะฝะต ะฟะตัะตะดะฐะฝ (ะฝะตั ะบะฐะฟัะธ) | โ๏ธ ะัะพะฟััะบะฐะตะผ (fail-open) | โ ะะพะณ |

---

## ะัััััะน ััะฐัั

### 1. ะัััะพะธัั ะฒะธะดะถะตั ะฝะฐ ัะฐะนั (5 ะผะธะฝัั)

```html
<!-- ะจะฐะณ 1: ะะพะฝัะตะนะฝะตั -->
<div id="mb-captcha"></div>

<!-- ะจะฐะณ 2: ะกะบัะธะฟั -->
<script src="https://captcha.markbase.ru/widget.js"></script>

<!-- ะจะฐะณ 3: ะะฝะธัะธะฐะปะธะทะฐัะธั -->
<script>
  MBCaptcha.render('#mb-captcha', {
    siteKey: 'mb_cap_live_xxxxxxxxxxxx',  // ะะฐั ะฟัะฑะปะธัะฝัะน ะบะปัั
    provider: 'custom',                    // custom | yandex | google
    theme: 'light',                        // light | dark
    lang: 'ru',                            // ru | en
    action: 'contact',                     // ะะตะนััะฒะธะต (ะดะปั ััะฐัะธััะธะบะธ)
    onVerify: function(result) {
      // result.token โ ะฟะตัะตะดะฐะนัะต ะฒ ัะบัััะพะต ะฟะพะปะต ัะพัะผั
      document.getElementById('captcha-token').value = result.token;
      document.getElementById('challenge-id').value = result.challengeId || '';
      document.getElementById('captcha-answer').value = result.answer || result.token;
    }
  });
</script>

<!-- ะ ะฒะฐัะตะน ัะพัะผะต: -->
<form method="POST" action="/submit">
  <input type="hidden" id="captcha-token" name="captcha_token" />
  <input type="hidden" id="challenge-id" name="challenge_id" />
  <input type="hidden" id="captcha-answer" name="captcha_answer" />
  <!-- ะััะฐะปัะฝัะต ะฟะพะปั ัะพัะผั -->
  <button type="submit">ะัะฟัะฐะฒะธัั</button>
</form>
```

### 2. ะัะพะฒะตัะธัั ะฝะฐ ัะตัะฒะตัะต

```javascript
// Node.js
const axios = require('axios');

app.post('/submit', async (req, res) => {
  const { captcha_token, challenge_id, captcha_answer } = req.body;

  try {
    const { data } = await axios.post('https://captcha.markbase.ru/api/captcha/v1/verify', {
      secret_key: 'mb_caps_live_xxxxxxxxxxxx', // ะะฐั ัะตะบัะตัะฝัะน ะบะปัั
      provider: 'custom',
      action: 'contact',
      challenge_id,
      answer: captcha_answer
    }, { timeout: 3000 });

    if (!data.success) {
      return res.status(400).json({ error: 'ะัะพะฒะตัะบะฐ ะบะฐะฟัะธ ะฝะต ะฟัะพะนะดะตะฝะฐ' });
    }

    // ะะฑัะฐะฑะฐััะฒะฐะตะผ ัะพัะผั...
  } catch (err) {
    // Fail-open: ัะฐะทัะตัะฐะตะผ ะตัะปะธ Captcha Service ะฝะตะดะพัััะฟะตะฝ
    console.warn('Captcha service unavailable:', err.message);
  }
});
```

```php
<?php
// PHP
$token = $_POST['captcha_answer'] ?? '';
$challengeId = $_POST['challenge_id'] ?? '';

$ch = curl_init('https://captcha.markbase.ru/api/captcha/v1/verify');
curl_setopt_array($ch, [
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_POST => true,
    CURLOPT_POSTFIELDS => json_encode([
        'secret_key' => 'mb_caps_live_xxxxxxxxxxxx',
        'provider' => 'custom',
        'action' => 'contact',
        'challenge_id' => $challengeId,
        'answer' => $token
    ]),
    CURLOPT_HTTPHEADER => ['Content-Type: application/json'],
    CURLOPT_TIMEOUT => 3
]);
$response = curl_exec($ch);
$code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

if ($code !== 200) {
    // Fail-open: Captcha Service ะฝะตะดะพัััะฟะตะฝ
    error_log("Captcha unavailable, allowing form");
} else {
    $data = json_decode($response, true);
    if ($data['success'] !== true) {
        die('ะัะพะฒะตัะบะฐ ะบะฐะฟัะธ ะฝะต ะฟัะพะนะดะตะฝะฐ');
    }
}
// ะะฑัะฐะฑะฐััะฒะฐะตะผ ัะพัะผั...
?>
```

### 3. ะะพะปััะธัั ะบะปััะธ (API)

ะะฒัะพัะธะทัะนัะตัั ัะตัะตะท WaySenID, ะทะฐัะตะผ:

```bash
curl -X POST https://captcha.markbase.ru/api/captcha/v1/projects \
  -H "Content-Type: application/json" \
  -H "Cookie: uam_session=YOUR_SESSION" \
  -d '{
    "project_name": "ะะพะน ัะฐะนั",
    "provider": "custom",
    "allowed_domains": ["mysite.ru", ".mysite.ru"],
    "difficulty": "medium"
  }'
```

ะัะฒะตั:
```json
{
  "project_id": "uuid",
  "site_key": "mb_cap_live_xxxxxxxxxxxx",
  "secret_key": "mb_caps_live_xxxxxxxxxxxx",
  "provider": "custom",
  "widget_code": "<div id=\"mb-captcha\"></div>..."
}
```

---

## ะะฝัะตะณัะฐัะธั ั UAM (WaySenID)

ะะฐะฟัะฐ **ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟะพะดะบะปััะตะฝะฐ** ะบ UAM:

| ะะตะนััะฒะธะต | ะะฐะฟัะฐ | ะกััะฐัะตะณะธั |
|----------|:-----:|-----------|
| ะะตะณะธัััะฐัะธั | โ ะะฑัะทะฐัะตะปัะฝะฐ | Fail-open |
| ะัะพะด (ะฟัะธ โค3 ะฟะพะฟััะบะฐั) | ๐ ะฃัะปะพะฒะฝะฐั | Fail-open, ัะพะปัะบะพ ะฟะพัะปะต ะฝะตัะดะฐัะฝัั ะฟะพะฟััะพะบ |
| ะกะผะตะฝะฐ ะฟะฐัะพะปั | ๐ ะฃัะปะพะฒะฝะฐั | Fail-open |

### Backend middleware

**ะคะฐะนะป:** `modules/uam/backend/src/middleware/captcha.js`

```javascript
const { verifyCaptcha } = require('../middleware/captcha');

// ะะตะณะธัััะฐัะธั โ ะบะฐะฟัะฐ ะพะฑัะทะฐัะตะปัะฝะฐ
router.post('/register',
  authRateLimiter,
  verifyCaptcha('register'),        // โ ะะฐะฟัะฐ
  async (req, res) => { ... }
);

// ะัะพะด โ ะบะฐะฟัะฐ ััะปะพะฒะฝะฐั (ัะพะปัะบะพ ะตัะปะธ token ะฟะตัะตะดะฐะฝ)
router.post('/login',
  authRateLimiter,
  checkBlockedIp,
  checkBruteForce,
  verifyCaptcha('login', { conditional: true }),  // โ ะฃัะปะพะฒะฝะฐั ะบะฐะฟัะฐ
  async (req, res) => { ... }
);

// ะกะผะตะฝะฐ ะฟะฐัะพะปั โ ััะปะพะฒะฝะฐั
router.post('/change-password',
  verifyCaptcha('password_change', { conditional: true }),
  async (req, res) => { ... }
);
```

### Frontend ะบะพะผะฟะพะฝะตะฝั (v1.1.0)

**ะคะฐะนะป:** `modules/uam/frontend/src/components/Captcha.js`

> **ะะฐะถะฝะพ (v1.1.0):** Frontend ะบะพะผะฟะพะฝะตะฝั **ะะ ะฒัะทัะฒะฐะตั** `/verify` ะฝะฐะฟััะผัั. ะะฝ ัะพะปัะบะพ ัะพะฑะธัะฐะตั `challengeId` ะธ `answer`, ะฟะตัะตะดะฐัั ะธั ะฒ `onVerify`. ะะตัะธัะธะบะฐัะธั ะฟัะพะธััะพะดะธั **ัะพะปัะบะพ ะฝะฐ backend** ะฟัะธ ะพัะฟัะฐะฒะบะต ัะพัะผั. ะญัะพ ะธัะบะปััะฐะตั ะดะฒะพะนะฝัั ะฒะตัะธัะธะบะฐัะธั.

```jsx
import Captcha from '../components/Captcha';

// ะ ัะพัะผะต ัะตะณะธัััะฐัะธะธ:
<Captcha
  action="register"
  onVerify={(result) => {
    // result = { success: true, provider: 'custom', challengeId: '...', answer: '...', token: null }
    setCaptchaResult(result);
  }}
  onError={() => setCaptchaResult({ success: true, token: 'fail_open' })}
/>

// ะัะธ ะพัะฟัะฐะฒะบะต ัะพัะผั ะฟะตัะตะดะฐะนัะต ะฝะฐ backend:
// { captcha_answer: result.answer, challenge_id: result.challengeId }
// Backend middleware verifyCaptcha() ัะฐะผ ะฟัะพะฒะตัะธั ัะตัะตะท captcha service.
```

> **URL ะบะฐะฟัะธ:** ะะพะผะฟะพะฝะตะฝั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะพะฟัะตะดะตะปัะตั URL captcha-ัะตัะฒะธัะฐ:
> - `REACT_APP_CAPTCHA_URL` (env variable, ะฟัะธะพัะธัะตั)
> - `https://captcha.markbase.ru` (ะดะปั `*.markbase.ru` ะดะพะผะตะฝะพะฒ)
> - Relative URL `/api/captcha/v1/...` (fallback ะดะปั dev)

---

## API Reference

### ะัะฑะปะธัะฝัะต ัะฝะดะฟะพะธะฝัั (ะฑะตะท ะฐะฒัะพัะธะทะฐัะธะธ)

| ะะตัะพะด | ะญะฝะดะฟะพะธะฝั | ะะฟะธัะฐะฝะธะต |
|-------|----------|----------|
| `POST` | `/api/captcha/v1/challenge` | ะกะพะทะดะฐัั ัะตะปะปะตะฝะดะถ (ัะพะฑััะฒะตะฝะฝะฐั ะบะฐะฟัะฐ) |
| `POST` | `/api/captcha/v1/verify` | ะัะพะฒะตัะธัั ะพัะฒะตั/ัะพะบะตะฝ |
| `GET` | `/api/captcha/v1/config` | ะะพะฝัะธะณััะฐัะธั ะฟัะพะฒะฐะนะดะตัะฐ |
| `GET` | `/health` | Health check ัะตัะฒะธัะฐ |

### ะะฐัะธััะฝะฝัะต ัะฝะดะฟะพะธะฝัั (ั secret_key ะธะปะธ ะฐะฒัะพัะธะทะฐัะธะตะน)

| ะะตัะพะด | ะญะฝะดะฟะพะธะฝั | ะะฟะธัะฐะฝะธะต |
|-------|----------|----------|
| `GET` | `/api/captcha/v1/stats` | ะกัะฐัะธััะธะบะฐ ะฟัะพะฒะตัะพะบ |
| `GET` | `/api/captcha/v1/projects` | ะกะฟะธัะพะบ ะฟัะพะตะบัะพะฒ |
| `POST` | `/api/captcha/v1/projects` | ะกะพะทะดะฐัั ะฟัะพะตะบั |
| `PATCH` | `/api/captcha/v1/projects/:id` | ะะฑะฝะพะฒะธัั ะฟัะพะตะบั |
| `DELETE` | `/api/captcha/v1/projects/:id` | ะฃะดะฐะปะธัั ะฟัะพะตะบั |
| `POST` | `/api/captcha/v1/projects/:id/regenerate-keys` | ะะตัะตะณะตะฝะตัะธัะพะฒะฐัั ะบะปััะธ |

### POST /challenge

ะกะพะทะดะฐัั ะฝะพะฒัะน ัะตะปะปะตะฝะดะถ ะดะปั ัะพะฑััะฒะตะฝะฝะพะน ะบะฐะฟัะธ.

**ะขะตะปะพ:**
```json
{
  "site_key": "mb_cap_live_xxxx",
  "type": "text",
  "difficulty": "medium"
}
```

**ะัะฒะตั:**
```json
{
  "challenge_id": "uuid",
  "type": "text",
  "difficulty": "medium",
  "image": "data:image/svg+xml;base64,...",
  "hint": "ะะฒะตะดะธัะต ัะธะผะฒะพะปั ั ะบะฐััะธะฝะบะธ",
  "max_attempts": 3,
  "expires_at": "2026-02-08T12:05:00Z",
  "ttl_seconds": 300
}
```

### POST /verify

ะัะพะฒะตัะธัั ะพัะฒะตั ะธะปะธ ัะพะบะตะฝ.

**ะขะตะปะพ (ัะพะฑััะฒะตะฝะฝะฐั ะบะฐะฟัะฐ):**
```json
{
  "site_key": "mb_cap_live_xxxx",
  "provider": "custom",
  "action": "register",
  "challenge_id": "uuid",
  "answer": "ABC123"
}
```

**ะขะตะปะพ (ะฏะฝะดะตะบั/Google):**
```json
{
  "secret_key": "mb_caps_live_xxxx",
  "provider": "yandex",
  "action": "login",
  "token": "smartcaptcha_token_here"
}
```

**ะัะฒะตั (ััะฟะตั):**
```json
{
  "success": true,
  "provider": "custom",
  "score": 1.0,
  "action": "register"
}
```

**ะัะฒะตั (ะฝะตัะดะฐัะฐ):**
```json
{
  "success": false,
  "provider": "custom",
  "error": "wrong_answer",
  "action": "register",
  "attempts_left": 2
}
```

---

## ะะพะฝัะธะณััะฐัะธั

### Environment Variables

| ะะตัะตะผะตะฝะฝะฐั | ะะฟะธัะฐะฝะธะต | ะะพ ัะผะพะปัะฐะฝะธั |
|-----------|----------|:---:|
| `CAPTCHA_PORT` | ะะพัั ัะตัะฒะธัะฐ | `8079` |
| `CAPTCHA_PUBLIC_URL` | ะัะฑะปะธัะฝัะน URL | `https://captcha.markbase.ru` |
| `CAPTCHA_ENABLED` | ะะบะปััะตะฝะฐ ะปะธ ะบะฐะฟัะฐ | `true` |
| `CAPTCHA_FAIL_OPEN` | Fail-open ัััะฐัะตะณะธั | `true` |
| `CAPTCHA_DB_HOST` | ะฅะพัั PostgreSQL | `captcha-postgres` |
| `CAPTCHA_DB_NAME` | ะะผั ะะ | `captcha_db` |
| `CAPTCHA_DB_USER` | ะะพะปัะทะพะฒะฐัะตะปั ะะ | `captcha_user` |
| `CAPTCHA_DB_PASSWORD` | ะะฐัะพะปั ะะ | โ |
| `UAM_INTERNAL_URL` | URL UAM ะดะปั ะฐััะตะฝัะธัะธะบะฐัะธะธ | `http://uam:8060` (Docker-ะธะผั ะฒ core ััะตะบะต) |
| `YANDEX_SMARTCAPTCHA_SITE_KEY` | ะัะฑะปะธัะฝัะน ะบะปัั ะฏะฝะดะตะบั | โ |
| `YANDEX_SMARTCAPTCHA_SECRET_KEY` | ะกะตะบัะตัะฝัะน ะบะปัั ะฏะฝะดะตะบั | โ |
| `GOOGLE_RECAPTCHA_SITE_KEY` | ะัะฑะปะธัะฝัะน ะบะปัั Google | โ |
| `GOOGLE_RECAPTCHA_SECRET_KEY` | ะกะตะบัะตัะฝัะน ะบะปัั Google | โ |
| `CAPTCHA_CORS_ORIGINS` | **ะะต ะธัะฟะพะปัะทัะตััั** (deprecated). CORS ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะฐะทัะตัะฐะตั ะฒัะต origins. | โ |

**CORS:**
- ะะธะดะถะตั ะบะฐะฟัะธ ะฟัะตะดะฝะฐะทะฝะฐัะตะฝ ะดะปั ะฒัััะฐะธะฒะฐะฝะธั ะฝะฐ **ะปัะฑะพะน ัะฐะนั** (ะบะฐะบ reCAPTCHA / hCaptcha).
- CORS ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะฐะทัะตัะฐะตั ะฒัะต origins. ะะฐะปะธะดะฐัะธั ะดะพะผะตะฝะฐ ะฟัะพะธััะพะดะธั ะฝะฐ ััะพะฒะฝะต **ะฟัะพะตะบัะฐ** (`allowed_domains` ะฒ ะะ).
- Nginx ะดะปั captcha.markbase.ru **ะะ ััะฐะฒะธั** CORS-ะทะฐะณะพะปะพะฒะบะธ โ ะธั ััะฐะฒะธั ัะพะปัะบะพ Express middleware.
- ะัะธะฑะบะฐ ยซmultiple valuesยป ะพะทะฝะฐัะฐะตั, ััะพ CORS-ะทะฐะณะพะปะพะฒะพะบ ััะฐะฒะธััั ะฒ ะดะฒัั ะผะตััะฐั โ ะธัะฟัะฐะฒััะต Nginx.
- ะะพะดัะพะฑะฝะตะต: [ะะะะะะะะซ_ะะ_ะะ_ะะะจะะ_ะกะขะะะะะ.md](../../../../ะะะะะะะะซ_ะะ_ะะ_ะะะจะะ_ะกะขะะะะะ.md) ยง 1.
- CSP ะดะปั ะฒะฝะตัะฝะธั ะฟัะพะตะบัะพะฒ: [MARKBASE_PLUGINS_OUR_SIDE.md](../../MARKBASE_PLUGINS_OUR_SIDE.md).

### ะะฐัััะพะนะบะฐ ะฟัะพะฒะฐะนะดะตัะพะฒ

#### ะกะพะฑััะฒะตะฝะฝะฐั ะบะฐะฟัะฐ (custom)

ะะฐะฑะพัะฐะตั **ะธะท ะบะพัะพะฑะบะธ**, ะฝะต ััะตะฑัะตั ะฝะฐัััะพะนะบะธ. ะะตะฝะตัะธััะตั SVG-ะธะทะพะฑัะฐะถะตะฝะธั ั ะธัะบะฐะถัะฝะฝัะผ ัะตะบััะพะผ.

ะฃัะพะฒะฝะธ ัะปะพะถะฝะพััะธ:
| ะกะปะพะถะฝะพััั | ะกะธะผะฒะพะปะพะฒ | ะจัะผ | ะะฐะบั. ะฟะพะฟััะพะบ |
|-----------|:--------:|:---:|:---:|
| `easy` | 4 | ะะฐะปะพ | 5 |
| `medium` | 5 | ะกัะตะดะฝะต | 3 |
| `hard` | 6 | ะะฝะพะณะพ | 2 |

#### ะฏะฝะดะตะบั SmartCaptcha

1. ะะฐะนะดะธัะต ะฝะฐ [ะฏะฝะดะตะบั.ะะฑะปะฐะบะพ](https://cloud.yandex.ru/services/smartcaptcha)
2. ะกะพะทะดะฐะนัะต SmartCaptcha
3. ะฃะบะฐะถะธัะต ัะฐะทัะตััะฝะฝัะต ะดะพะผะตะฝั
4. ะกะบะพะฟะธััะนัะต `site_key` ะธ `secret_key`
5. ะัะธ ัะพะทะดะฐะฝะธะธ ะฟัะพะตะบัะฐ ัะบะฐะถะธัะต:
```json
{
  "provider": "yandex",
  "yandex_site_key": "...",
  "yandex_secret_key": "..."
}
```

#### Google reCAPTCHA v3

1. ะะฐะนะดะธัะต ะฝะฐ [reCAPTCHA Admin](https://www.google.com/recaptcha/admin)
2. ะกะพะทะดะฐะนัะต reCAPTCHA v3
3. ะฃะบะฐะถะธัะต ะดะพะผะตะฝั
4. ะัะธ ัะพะทะดะฐะฝะธะธ ะฟัะพะตะบัะฐ ัะบะฐะถะธัะต:
```json
{
  "provider": "google",
  "google_site_key": "...",
  "google_secret_key": "...",
  "google_min_score": 0.5
}
```

---

## ะะฐะทะฐ ะดะฐะฝะฝัั

### ะกัะตะผะฐ: `captcha`

| ะขะฐะฑะปะธัะฐ | ะะฟะธัะฐะฝะธะต |
|---------|----------|
| `projects` | ะัะพะตะบัั ั ะบะปััะฐะผะธ, ะฝะฐัััะพะนะบะฐะผะธ, ัะฐะทัะตััะฝะฝัะผะธ ะดะพะผะตะฝะฐะผะธ |
| `challenges` | ะกะณะตะฝะตัะธัะพะฒะฐะฝะฝัะต ัะตะปะปะตะฝะดะถะธ (ัะพะฑััะฒะตะฝะฝะฐั ะบะฐะฟัะฐ) |
| `verifications` | ะะพะณ ะฒัะตั ะฟัะพะฒะตัะพะบ (ััะฟะตั/ะฝะตัะดะฐัะฐ/fail-open) |
| `daily_stats` | ะะณัะตะณะฐัะธั ะฟะพ ะดะฝัะผ |
| `migrations` | ะัะธะผะตะฝัะฝะฝัะต ะผะธะณัะฐัะธะธ |

### ะะปััะตะฒัะต ะฟะพะปั `projects`

| ะะพะปะต | ะขะธะฟ | ะะฟะธัะฐะฝะธะต |
|------|-----|----------|
| `site_key` | `VARCHAR(64)` | ะัะฑะปะธัะฝัะน ะบะปัั (`mb_cap_live_...`) |
| `secret_key` | `VARCHAR(128)` | ะกะตะบัะตัะฝัะน ะบะปัั (`mb_caps_live_...`) |
| `provider` | `VARCHAR(32)` | ะัะฝะพะฒะฝะพะน ะฟัะพะฒะฐะนะดะตั |
| `fallback_provider` | `VARCHAR(32)` | ะะตะทะตัะฒะฝัะน ะฟัะพะฒะฐะนะดะตั |
| `allowed_domains` | `JSONB` | ะะฐะทัะตััะฝะฝัะต ะดะพะผะตะฝั `["mysite.ru"]` |
| `fail_open` | `BOOLEAN` | Fail-open ัััะฐัะตะณะธั |
| `difficulty` | `VARCHAR(16)` | ะกะปะพะถะฝะพััั (easy/medium/hard) |

---

## ะัะบะฐะทะพัััะพะนัะธะฒะพััั

```
ะะฐะฟัะพั ะฝะฐ ะฟัะพะฒะตัะบั ะบะฐะฟัะธ
    โ
    โโโ โ ะัะฝะพะฒะฝะพะน ะฟัะพะฒะฐะนะดะตั ะดะพัััะฟะตะฝ โ ะัะพะฒะตััะตะผ
    โ       โโโ โ ะฃัะฟะตั โ ะัะพะฟััะบะฐะตะผ
    โ       โโโ โ ะะตัะดะฐัะฐ โ ะะปะพะบะธััะตะผ
    โ
    โโโ โ๏ธ ะัะฝะพะฒะฝะพะน ะฝะตะดะพัััะฟะตะฝ โ Fallback-ะฟัะพะฒะฐะนะดะตั
    โ       โโโ โ ะฃัะฟะตั โ ะัะพะฟััะบะฐะตะผ
    โ       โโโ โ ะะตัะดะฐัะฐ โ ะะปะพะบะธััะตะผ
    โ
    โโโ โ๏ธ ะะฑะฐ ะฝะตะดะพัััะฟะฝั โ Fail-Open
    โ       โโโ โ๏ธ ะัะพะฟััะบะฐะตะผ + ะปะพะณะธััะตะผ
    โ
    โโโ ๐ด Captcha Service ะฟะพะปะฝะพัััั ะฝะตะดะพัััะฟะตะฝ
            โโโ โ๏ธ Middleware fail-open โ ะัะพะฟััะบะฐะตะผ + ะปะพะณะธััะตะผ
```

### ะััะธัะพะฒะฐะฝะธะต

- ะะพะฝัะธะณััะฐัะธั ะฟัะพะตะบัะพะฒ ะบััะธััะตััั **1 ะผะธะฝััั** (in-memory)
- ะัะธ ะฝะตะดะพัััะฟะฝะพััะธ ะะ โ ะธัะฟะพะปัะทัะตััั ะบัั (ะดะฐะถะต ัััะฐัะตะฒัะธะน)
- ะงะตะปะปะตะฝะดะถะธ ะถะธะฒัั **5 ะผะธะฝัั** (ะฝะฐัััะฐะธะฒะฐะตััั)

---

## Docker

### ะะฐะฟััะบ

```bash
cd modules/captcha/deploy
cp .env.example .env
# ะััะตะดะฐะบัะธััะนัะต .env
docker compose up -d
```

### ะัะพะฒะตัะบะฐ

```bash
curl http://localhost:8079/health

# ะัะฒะตั:
# {"status":"ok","service":"markbase-captcha","version":"1.0.0","postgres":true,...}
```

---

## ะะธะดะถะตั MBCaptcha

### API ะฒะธะดะถะตัะฐ

```javascript
// ะััะธัะพะฒะฐัั ะบะฐะฟัั
const id = MBCaptcha.render('#container', {
  siteKey: 'mb_cap_live_...',
  provider: 'custom',   // custom | yandex | google
  theme: 'light',       // light | dark
  lang: 'ru',           // ru | en
  action: 'register',   // ะดะตะนััะฒะธะต ะดะปั ััะฐัะธััะธะบะธ
  onVerify: (result) => {},  // { success, token, provider, challengeId }
  onError: (error) => {},    // { error, attempts_left }
  onExpire: () => {}         // ัะพะบะตะฝ ะธัััะบ
});

// ะะพะปััะธัั ัะพะบะตะฝ
MBCaptcha.getToken(id);

// ะกะฑัะพัะธัั (ะฟะตัะตะทะฐะณััะทะธัั)
MBCaptcha.reset(id);

// ะฃะดะฐะปะธัั
MBCaptcha.destroy(id);
```

### ะะพะดะดะตัะถะบะฐ ัะตะผ

```javascript
// ะกะฒะตัะปะฐั ัะตะผะฐ (ะฟะพ ัะผะพะปัะฐะฝะธั)
MBCaptcha.render('#cap', { theme: 'light' });

// ะขัะผะฝะฐั ัะตะผะฐ
MBCaptcha.render('#cap', { theme: 'dark' });
```

---

## Changelog

### 1.1.0 (2026-02-09)
- **ะะพัั ะธะทะผะตะฝัะฝ:** 8062 โ 8079 (8062 ะบะพะฝัะปะธะบัะพะฒะฐะป ั Server Mgmt)
- **Fix: ะะฒะพะนะฝะฐั ะฒะตัะธัะธะบะฐัะธั** โ Frontend `Captcha.js` ะฑะพะปััะต ะฝะต ะฒัะทัะฒะฐะตั `/verify` ะฝะฐะฟััะผัั, ะฒะตัะธัะธะบะฐัะธั ัะพะปัะบะพ ะฝะฐ backend
- **Fix: Captcha URL** โ ะะธะฝะฐะผะธัะตัะบะพะต ะพะฟัะตะดะตะปะตะฝะธะต URL ัะตัะฒะธัะฐ (`https://captcha.markbase.ru` ะดะปั ะฟัะพะดะฐะบัะตะฝะฐ)
- **Fix: Fail-open tokens** โ Backend middleware ะบะพััะตะบัะฝะพ ะพะฑัะฐะฑะฐััะฒะฐะตั `fail_open` ัะพะบะตะฝั ะพั frontend
- **ะะฝัะตะณัะฐัะธั ะฒ core** โ Captcha ะฟะพะปะฝะพัััั ะธะฝัะตะณัะธัะพะฒะฐะฝะฐ ะฒ `docker-compose.yml`, `core-postgres`, `redeploy-interactive.sh`
- **Nginx ะบะพะฝัะธะณััะฐัะธั** โ ะะฑะฝะพะฒะปะตะฝั proxy_pass ะดะปั ะฟะพััะฐ 8079
- **ะะ** โ `captcha_db` ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะพะทะดะฐัััั ะฒ `core-postgres`

### 1.0.0 (2026-02-08)
- ะะตัะฒัะน ัะตะปะธะท
- ะกะพะฑััะฒะตะฝะฝะฐั SVG-ะบะฐะฟัะฐ (text + math) โ ะฟะพ ัะผะพะปัะฐะฝะธั
- ะฏะฝะดะตะบั SmartCaptcha โ ะธะฝัะตะณัะฐัะธั
- Google reCAPTCHA v3 โ ะธะฝัะตะณัะฐัะธั
- ะกะธััะตะผะฐ ะบะปััะตะน (site_key / secret_key) ะดะปั ะฟัะพะตะบัะพะฒ
- ะะธะดะถะตั `widget.js` ะดะปั ะฒัััะฐะธะฒะฐะฝะธั ะฝะฐ ะปัะฑะพะน ัะฐะนั
- Fail-Open ัััะฐัะตะณะธั ั ะปะพะณะธัะพะฒะฐะฝะธะตะผ
- Fallback ะผะตะถะดั ะฟัะพะฒะฐะนะดะตัะฐะผะธ
- ะะพะผะตะฝ-ัะธะปัััะฐัะธั ะบะปััะตะน
- ะะฝัะตะณัะฐัะธั ั UAM (ัะตะณะธัััะฐัะธั, ะฒัะพะด, ัะผะตะฝะฐ ะฟะฐัะพะปั)
- React-ะบะพะผะฟะพะฝะตะฝั `<Captcha>` ะดะปั frontend UAM
- Express middleware `verifyCaptcha()` ะดะปั backend
- ะกัะฐัะธััะธะบะฐ ะฟัะพะฒะตัะพะบ ะธ API ัะฟัะฐะฒะปะตะฝะธั ะฟัะพะตะบัะฐะผะธ
- Docker + Nginx ะบะพะฝัะธะณััะฐัะธั

---

## UI Compliance (Header v1.1.0)

ะัะปะธ ะผะพะดัะปั ะธะผะตะตั web-ะธะฝัะตััะตะนั ั ะฐะบะบะฐัะฝั-ะผะตะฝั ะฒ ะฟัะฐะฒะพะผ ะฒะตััะฝะตะผ ัะณะปั, ะพะฑัะทะฐัะตะปัะฝะพ ัะพะฑะปัะดะฐะตััั ะตะดะธะฝัะน ััะฐะฝะดะฐัั ัะบะพัะธััะตะผั:

- ะฟัะพัะธะปั (ะธะผั + email)
- ะฑะฐะปะฐะฝั ะบะพัะตะปัะบะฐ ะธะท `https://billing.markbase.ru/api/billing/balance`
- ะฟัะฝะบัั: ะฐะบะบะฐัะฝั/ะฑะตะทะพะฟะฐัะฝะพััั, ัะฒะตะดะพะผะปะตะฝะธั, ะบะพัะตะปะตะบ, ัะฐัะธัั/ะฑะธะปะปะธะฝะณ, ะฟะพะผะพัั, ะฒััะพะด
- ะฟะตัะตัะพะดั ะฝะฐ ะดััะณะธะต ะฟะพะดะดะพะผะตะฝั ะฟะพะผะตัะฐัััั ัะตะณะพะผ `ะฒะฝะตัะฝัั`

ะััะพัะฝะธะบ ััะฐะฝะดะฐััะฐ:

- `markbaseCORE/INTEGRATION/MARKBASE/design/HEADER.md`
- `markbaseCORE/INTEGRATION/MARKBASE/design/header.json`
- `markbaseCORE/INTEGRATION/MARKBASE/design/HEADER_CHECKLIST.md`

